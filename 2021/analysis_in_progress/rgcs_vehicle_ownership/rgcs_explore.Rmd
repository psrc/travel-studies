---
title: "Regional Growth Center Analysis using 2017, 2019, and 2021 travel surveys"
author: "Joanne Lin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
---


```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      fig.align = "center"
                      # out.width = '50%'
                      ) # formatting
setwd("C:/Joanne_PSRC/data_science/travel-studies/2021/analysis_in_progress/rgcs_vehicle_ownership")

# connect to script with functions
source("C:/Joanne_PSRC/data_science/travel-studies/2021/analysis_in_progress/rgcs_vehicle_ownership/rgcs_functions.R")

# psrc packages
library(psrc.travelsurvey)
library(psrcplot)
library(psrctrends)
library(tidycensus)

library(tidyverse)
library(stringr)
library(rlang)
library(chron)
library(scales)
library(gridExtra)
# library(tidycensus)
# library(htmlwidgets)

install_psrc_fonts()
```

# Variables we might want to summarize

```{r Variable, echo=TRUE}
hh_vars=c("survey_year",
          "hhid", "sample_county", 
          "final_home_rgcnum", "final_home_is_rgc","final_home_tract20",
          # "final_home_uvnum",
          "final_home_tract10",
          "hhsize", "vehicle_count", "hhincome_broad", "hhincome_detailed", 
          "numadults", "numchildren", "numworkers", "lifecycle",
          "res_dur", "res_type", "res_months",
          "broadband", "offpark", "offpark_cost", "streetpark")

person_vars=c("person_id",  "household_id", "gender", 
              "age", "age_category", "race_category", "race_eth_broad",
              "education", "workplace", "industry", "employment",
              "worker", # for calculating number of workers in the household
              
              "license",
              "commute_freq", # How often commuted to workplace last week
              "commute_mode", # Method of commuting to work location/office last week
              "telecommute_freq",

              "mode_freq_1", # Times ridden transit in past 30 days
              "mode_freq_2", # Times ridden a bike in past 30 days
              "mode_freq_3", # Times gone for a walk in past 30 days
              "mode_freq_4", # Times used carshare in past 30 days
              "mode_freq_5", # Times used rideshare in past 30 days
              "benefits_3" # Employer commuter benefits: Free/partially subsidized passes/fares
              
              )

trip_vars = c("hhid",'person_id',
              "driver","mode_1","mode_simple",
              
              'dest_purpose_cat', 'origin_purpose_cat',
              "google_duration", 
              'trip_path_distance',
              "depart_time_hhmm", "arrival_time_hhmm", 
              "depart_time_mam", "arrival_time_mam",
              
              "dayofweek", "travelers_total",
              
              "pool_start", "change_vehicles",
              "toll", "toll_pay", "taxi_pay",
              "mode_acc", "mode_egr", "speed_mph")


# list of all urban and metro RGCs
urban_metro <- read_csv("urban_metro.csv") %>% select(3,13) %>%
  mutate(name = case_when(name == "Bellevue" ~ "Bellevue Downtown",
                          name == "Redmond-Overlake" ~ "Redmond Overlake",
                          TRUE~ name))
```

Get the data from Elmer.
```{r trip + household data, include=FALSE}
hh_data_17_19<- get_hhts("2017_2019", "h", vars=hh_vars) %>% hh_group_data()
hh_data_17<-    get_hhts("2017", "h", vars=hh_vars) %>%      hh_group_data()
hh_data_19<-    get_hhts("2019", "h", vars=hh_vars) %>%      hh_group_data()
hh_data_21<-    get_hhts("2021", "h", vars=hh_vars) %>%      hh_group_data()


per_data_17_19<- get_hhts("2017_2019", "p", vars=person_vars) %>% per_group_data(hh_data_17_19)
per_data_17<-    get_hhts("2017", "p", vars=person_vars) %>%      per_group_data(hh_data_17)
per_data_19<-    get_hhts("2019", "p", vars=person_vars) %>%      per_group_data(hh_data_19)
per_data_21<-    get_hhts("2021", "p", vars=person_vars) %>%      per_group_data(hh_data_21)

trip_data_17_19<- get_hhts("2017_2019", "t", vars=trip_vars) %>% trip_group_data(per_data_17_19)
trip_data_17<-    get_hhts("2017", "t", vars=trip_vars) %>%      trip_group_data(per_data_17)
trip_data_19<-    get_hhts("2019", "t", vars=trip_vars) %>%      trip_group_data(per_data_19)
trip_data_21<-    get_hhts("2021", "t", vars=trip_vars) %>%      trip_group_data(per_data_21)

# rgcs_tracts_list <- read_csv("C:/Users/JLin/Downloads/rgc_tracts.csv") %>% select(-1) %>%
#   inner_join(hh_data_21 %>%distinct(urban_metro, final_home_rgcnum), 
#              by = c("name"="final_home_uv"))
```


# Basic demographic analysis

## Across all RGCs
1. Household Demographics
```{r}
# Household size
plot  <- hhts_count(hh_data_21, group_vars=c("final_home_is_rgc","hhsize"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(hhsize=="1") %>%
  mutate(hhsize = "single-person household")

TT <- "Household size in RGCs (2021)"
ggplot(plot, aes(x=hhsize, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

plot  <- hhts_count(hh_data_21, group_vars=c("urban_metro","hhsize"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(hhsize=="1") %>%
  mutate(hhsize = "single-person household")

TT <- "Household size in RGCs (2021)"
ggplot(plot, aes(x=hhsize, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2()

# Include children
plot2  <- hhts_count(hh_data_21, group_vars=c("final_home_is_rgc","have_child"),
                     spec_wgt = "hh_weight_2021") %>%
  filter(have_child=="Includes children")

TT <- "Households that include children in RGCs (2021)"
ggplot(plot2, aes(x=have_child, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("psrc_light")+
  ggtitle(TT)+
  psrc_style2(text_size=3)

# Residence types
plot  <- hhts_count(hh_data_21, group_vars=c("final_home_is_rgc","res_type"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(res_type!="Total",
         res_type!="Others") %>%
  wrap_axis(res_type,w=13)
plot$cat <- factor(plot$cat, levels=c("Single-family\nhouse","Townhouse","Apartment/\nCondo","Others"))


TT <- "Residence types in RGCs (2021)"
ggplot(plot, aes(x=cat, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2()




# Residence types
plot  <- hhts_count(hh_data_21, group_vars=c("urban_metro","res_type"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(res_type!="Total") %>%
  wrap_axis(res_type)
plot$cat <- factor(plot$cat, levels=c("Single-\nfamily\nhouse","Townhouse","Apartment/\nCondo","Others"))


TT <- "Residence types in Metro and Urban RGCs (2021)"
ggplot(plot, aes(x=cat, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2()


# Income distribution
# plot3 <- hhts_count(hh_data_21 %>% 
#                       filter(hhincome_broad!="Prefer not to answer"), 
#                     group_vars=c("final_home_is_rgc","hhincome_broad"),
#                     spec_wgt = "hh_weight_2021") %>%
#   filter(hhincome_broad!="Total") %>%
#   wrap_axis(hhincome_broad)
# plot3$cat <- factor(plot3$cat, levels=c("Under\n$25,000","$25,000-\n$49,999",
#                                       "$50,000-\n$74,999","$75,000-\n$99,999","$100,000 or\nmore"))
# 
# TT <- "Household income in RGCs (2021)"
# ggplot(plot3, aes(x=cat, y=share, fill=final_home_is_rgc)) +
#   geom_col(position = "dodge")+  
#   moe_bars+
#   scale_y_continuous(labels=percent) +
#   scale_fill_discrete_psrc ("pognbgy_10")+
#   ggtitle(TT)+
#   psrc_style()


plot4 <- hhts_count(hh_data_21 %>%
                      filter(hhincome_binary!="Prefer not to answer"),
                    group_vars=c("final_home_is_rgc","hhincome_binary"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(hhincome_binary!="Total")

TT <- "Household income in RGCs (2021)"
ggplot(plot4, aes(x=hhincome_binary, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2()

# vehicle ownership
# plot2 <- hhts_count(hh_data_21, group_vars=c("final_home_is_rgc","vehicle_count"),
#                     spec_wgt = "hh_weight_2021") %>%
#   filter(vehicle_count!="Total") 
# 
# 
# TT <- "Number of vehicles in a household (2021)"
# ggplot(plot2, aes(x=vehicle_count, y=share, fill=final_home_is_rgc)) +
#   geom_col(position = "dodge")+  
#   moe_bars +
#   scale_y_continuous(labels=percent) +
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   ggtitle(TT)+
#   psrc_style()
# 
# plot4 <- hhts_count(hh_data_21 %>% 
#                       filter(hhincome_binary!="Prefer not to answer"), 
#                     group_vars=c("urban_metro","hhincome_binary"),
#                     spec_wgt = "hh_weight_2021") %>%
#   filter(hhincome_binary!="Total") 
# 
# TT <- "Household income in Metro and Urban RGCs (2021)"
# ggplot(plot4, aes(x=hhincome_binary, y=share, fill=urban_metro)) +
#   geom_col(position = "dodge")+  
#   moe_bars+
#   scale_y_continuous(labels=percent) +
#   scale_fill_discrete_psrc ("pognbgy_10")+
#   ggtitle(TT)+
#   psrc_style()

# vehicle ownership
plot2 <- hhts_count(hh_data_21, group_vars=c("urban_metro","vehicle_binary"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(vehicle_binary=="1 or more") %>%
  mutate(vehicle_binary="1 vehicle or more")


TT <- "Vehicle ownership in a household (2021)"
ggplot(plot2, aes(x=vehicle_binary, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2)

# vehicle ownership
plot2 <- hhts_count(hh_data_21, group_vars=c("final_home_rgcnum","vehicle_binary"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(vehicle_binary=="1 or more") %>%
  mutate(vehicle_binary="1 vehicle or more")


TT <- "Vehicle ownership in a household (2021)"
ggplot(plot2, aes(x=final_home_rgcnum, y=share)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  # scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2) +
  coord_flip()

```
* Metro and Urban RGCs have similar demographic composition in terms of household size, having children and income ditribution
* Urban RGCs have more single-family housing and fewer apartments than Metro RGCs
* Urban RGCs also have higher vehicle ownership than Metro RGCs


2. Person Demographics
```{r}
# Race
plot  <- hhts_count(per_data_21,
                    group_vars=c("final_home_is_rgc", "race_eth_broad"),
                    spec_wgt = 'person_adult_weight_2021') %>%
  filter(race_eth_broad!="Total") %>%
  wrap_axis(race_eth_broad)
plot$cat <- factor(plot$cat, level = c("Asian only",
                                       "Black or\nAfrican\nAmerican\nonly",
                                       "Hispanic or\nLatinx",
                                       "White only",
                                       "Other race,\nincluding\nmulti-race"))


TT <- "Race distribution in RGCs (2021)"
ggplot(plot, aes(x=cat, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("psrc_light")+
  ggtitle(TT)+
  psrc_style2()

# 
# plot  <- hhts_count(per_data_21,
#                     group_vars=c("urban_metro", "race_eth_broad"),
#                     spec_wgt = 'person_adult_weight_2021') %>%
#   filter(race_eth_broad!="Total") %>%
#   wrap_axis(race_eth_broad)
# plot$cat <- factor(plot$cat, level = c("Asian only",
#                                        "Black or\nAfrican\nAmerican\nonly",
#                                        "Hispanic or\nLatinx",
#                                        "White only",
#                                        "Other race,\nincluding\nmulti-race"))
# 
# 
# TT <- "Race distribution in Metro and Urban RGCs (2021)"
# ggplot(plot, aes(x=cat, y=share, fill=urban_metro)) +
#   geom_col(position = "dodge")+
#   moe_bars +
#   scale_y_continuous(labels=percent) +
#   scale_fill_discrete_psrc ("psrc_light")+
#   ggtitle(TT)+
#   psrc_style2()


# Education
plot  <- hhts_count(per_data_21,
                    group_vars=c("final_home_is_rgc", "education2"),
                    spec_wgt = 'person_adult_weight_2021') %>%
  filter(education2!="Total") %>%
  wrap_axis(education2)
plot$cat <- factor(plot$cat, level = c("High school\nor less",
                                       "Technical\nor\nAssociates",
                                       "Bachelor's\nor higher"))

TT <- "Education in RGCs (2021)"
ggplot(plot, aes(x=cat, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2()


plot  <- hhts_count(per_data_21,
                    group_vars=c("urban_metro", "education2"),
                    spec_wgt = 'person_adult_weight_2021') %>%
  filter(education2!="Total") %>%
  wrap_axis(education2)
plot$cat <- factor(plot$cat, level = c("High school\nor less",
                                       "Technical\nor\nAssociates",
                                       "Bachelor's\nor higher"))

TT <- "Education in Metro and Urban RGCs (2021)"
ggplot(plot, aes(x=cat, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2()


# vehicle ownership
plot2 <- hhts_count(hh_data_21, group_vars=c("urban_metro","vehicle_binary"),
                    spec_wgt = "hh_weight_2021") %>%
  filter(vehicle_binary=="1 or more") %>%
  mutate(vehicle_binary="1 vehicle or more")


TT <- "Vehicle ownership in a household (2021)"
ggplot(plot2, aes(x=vehicle_binary, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2)

```



# Travel behavior analysis

```{r}
trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
person_w <- c("hh_weight_2017","hh_weight_2019","person_adult_weight_2021")

trip <- function(trip_data, person_data, year){
  
  if(year==2017){
    ix <- 1
  }
  else if(year==2019){
    ix <- 2
  }
  else{
    ix <- 3
  }
  
  # remove children
  trip_data <- trip_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  person_data <- person_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  
  # total trips
  plot <- hhts_count(trip_data,group_vars = c('final_home_is_rgc'),
                     spec_wgt = trip_w[[ix]]) %>%
    drop_na('final_home_is_rgc') %>% 
    filter(final_home_is_rgc != 'Total')
  
  #  to calculate total number of people
  plot2 <- hhts_count(person_data, group_vars=c("final_home_is_rgc"),
                      spec_wgt = person_w[[ix]]) %>%
    filter(final_home_is_rgc != 'Total')
  
  # number of trips and total population
  plot3 <- plot %>%
    left_join(plot2, by="final_home_is_rgc", suffix = c('_trips', '_person')) %>% 
    mutate(
      trips_per_person = count_trips / count_person,
      moe_trips_person = moe_ratio(count_trips, count_person, count_moe_trips, count_moe_person)
    ) 
  
  # TT <- paste("Number of trips per day in RGCs",year)
  # 
  # return(ggplot(plot3, 
  #        aes(x=final_home_is_rgc, y=trips_per_person, fill=final_home_is_rgc)) +
  #   geom_col(position = "dodge")+  
  #   geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
  #                           width=0.2, position = position_dodge(0.9))+
  #   scale_fill_discrete_psrc ("gnbopgy_5")+
  #   ggtitle(TT)+
  #   psrc_style2(text_size = 2, loc="top"))
  return(plot3)
  
  
}

plot_17 <- trip(trip_data_17,per_data_17,2017)
plot_19 <- trip(trip_data_19,per_data_19,2019)
plot_21 <- trip(trip_data_21,per_data_21,2021)


plot_all_per <- plot_17 %>% mutate(survey ="2017") %>%
  add_row(plot_19 %>% mutate(survey ="2019")) %>%
  add_row(plot_21 %>% mutate(survey ="2021"))# %>%
  # wrap_axis(simple_purpose)


 TT <- paste("Number of trips per day in RGCs")
ggplot(plot_all_per, 
         aes(x=final_home_is_rgc, y=trips_per_person, fill=survey)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~final_home_is_rgc)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)

TT <- paste("Number of trips per day in RGCs (2021)")
ggplot(plot_all_per[plot_all_per$survey==2021,], 
         aes(x=final_home_is_rgc, y=trips_per_person, fill=final_home_is_rgc)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~final_home_is_rgc)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)


trip <- function(trip_data, person_data, year){
  
  if(year==2017){
    ix <- 1
  }
  else if(year==2019){
    ix <- 2
  }
  else{
    ix <- 3
  }
  
  # remove children
  trip_data <- trip_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  person_data <- person_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  
  # total trips
  plot <- hhts_count(trip_data,group_vars = c('urban_metro'),
                     spec_wgt = trip_w[[ix]]) %>%
    drop_na('urban_metro') %>% 
    filter(urban_metro != 'Total')
  
  #  to calculate total number of people
  plot2 <- hhts_count(person_data, group_vars=c("urban_metro"),
                      spec_wgt = person_w[[ix]]) %>%
    filter(urban_metro != 'Total')
  
  # number of trips and total population
  plot3 <- plot %>%
    left_join(plot2, by="urban_metro", suffix = c('_trips', '_person')) %>% 
    mutate(
      trips_per_person = count_trips / count_person,
      moe_trips_person = moe_ratio(count_trips, count_person, count_moe_trips, count_moe_person)
    ) 
  
  # TT <- paste("Number of trips per day in RGCs",year)
  # 
  # return(ggplot(plot3, 
  #        aes(x=urban_metro, y=trips_per_person, fill=urban_metro)) +
  #   geom_col(position = "dodge")+  
  #   geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
  #                           width=0.2, position = position_dodge(0.9))+
  #   scale_fill_discrete_psrc ("gnbopgy_5")+
  #   ggtitle(TT)+
  #   psrc_style2(text_size = 2, loc="top"))
  return(plot3)
  
  
}

plot_17_um <- trip(trip_data_17,per_data_17,2017)
plot_19_um <- trip(trip_data_19,per_data_19,2019)
plot_21_um <- trip(trip_data_21,per_data_21,2021)


plot_all_per_um <- plot_17_um %>% mutate(survey ="2017") %>%
  add_row(plot_19_um %>% mutate(survey ="2019")) %>%
  add_row(plot_21_um %>% mutate(survey ="2021"))# %>%
  # wrap_axis(simple_purpose)


 TT <- paste("Number of trips per day in RGCs")
ggplot(plot_all_per_um, 
         aes(x=urban_metro, y=trips_per_person, fill=survey)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~urban_metro)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)

test_um<- plot_21 %>%
  rename(label = final_home_is_rgc) %>%
  mutate(category = "final_home_is_rgc") %>%
  add_row(plot_21_um %>%
    rename(label = urban_metro) %>%
    mutate(category = "urban_metro"))
test_um$label <- factor(test_um$label, levels=c("RGC","Metro","Urban","Not RGC")) 

TT <- paste("Average number of trips per day \nin RGCs (2021 HHTS)")
ggplot(test_um[test_um$category=="final_home_is_rgc"], 
         aes(x=label, y=trips_per_person, fill=label)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("pognbgy_10")+
  # facet_wrap(~category, scales = "free_x")+
    ggtitle(TT)+
    psrc_style2(text_size = 2)

TT <- paste("Average number of trips per day \nin metro and urban RGCs (2021 HHTS)")
ggplot(test_um[test_um$category=="urban_metro"], 
         aes(x=label, y=trips_per_person, fill=label)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~category, scales = "free_x")+
    ggtitle(TT)+
    psrc_style2(text_size = 2)
```

## Trips by purpose (trips per person)
  * if only look into trips made by single households, would the patterns differ? not as much as households with children
```{r}
trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
person_w <- c("hh_weight_2017","hh_weight_2019","person_adult_weight_2021")

trip_purpose <- function(trip_data, person_data, year){
  
  if(year==2017){
    ix <- 1
  }
  else if(year==2019){
    ix <- 2
  }
  else{
    ix <- 3
  }
  
  # remove children
  trip_data <- trip_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  person_data <- person_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  
  # total trips
  plot <- hhts_count(trip_data,group_vars = c('urban_metro', 'simple_purpose'),
                     spec_wgt = trip_w[[ix]]) %>%
    drop_na(c('urban_metro', 'simple_purpose')) %>% 
    filter(simple_purpose != 'Total')
  
  #  to calculate total number of people
  plot2 <- hhts_count(person_data, group_vars=c("urban_metro"),
                      spec_wgt = person_w[[ix]]) %>%
    filter(urban_metro != 'Total')
  
  # number of trips and total population
  plot3 <- plot %>%
    left_join(plot2, by="urban_metro", suffix = c('_trips', '_person')) %>% 
    mutate(
      trips_per_person = count_trips / count_person,
      moe_trips_person = moe_ratio(count_trips, count_person, count_moe_trips, count_moe_person)
    ) 
  
  
  p1<- ggplot(plot3, 
         aes(x=simple_purpose, y=trips_per_person, fill=urban_metro)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
    psrc_style2(loc="top")
  
  data_table <- ggplot(plot3, aes(x = simple_purpose, y = urban_metro,
                                  label = sample_size_trips)) +
    geom_text() +
    scale_y_discrete(limits=rev)+
    theme(panel.background = element_rect(fill = "white", colour = "white"),
          panel.grid.major = NULL, legend.position = NULL, axis.ticks = element_blank(),
          axis.text.x = element_blank()) +
    xlab(NULL) + ylab(NULL)
  
  grid.arrange(p1,data_table, nrow=2, heights=c(4,1))
  return(plot3)
}

plot_17 <- trip_purpose(trip_data_17,per_data_17,2017)
plot_19 <- trip_purpose(trip_data_19,per_data_19,2019)
plot_21 <- trip_purpose(trip_data_21,per_data_21,2021)

plot_all_per <- plot_17 %>% mutate(survey ="2017") %>%
  add_row(plot_19 %>% mutate(survey ="2019")) %>%
  add_row(plot_21 %>% mutate(survey ="2021")) %>%
  wrap_axis(simple_purpose)
plot_all_per$cat <- factor(plot_all_per$cat, levels=c("Work/School","Shop","Errands","Social/\nRecreation/\nMeal"))


 TT <- paste("Person trips by purpose in RGCs")
ggplot(plot_all_per, 
         aes(x=cat, y=trips_per_person, fill=survey)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  facet_wrap(~final_home_is_rgc)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)
```



```{r}

trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
hh_w <- c("hh_weight_2017","hh_weight_2019","hh_weight_2021")


trip_purpose_hhtrips <- function(trip_data, hh_data, year){
  
  if(year==2017){
    ix <- 1
  }
  else if(year==2019){
    ix <- 2
  }
  else{
    ix <- 3
  }
  
  trip_data <- trip_data %>%
    filter(race_eth_broad != "Child -- no race specified")
  
  hh_trips <- trip_data %>%
  group_by(survey,dayofweek,hhid,dest_purpose_cat,origin_purpose_cat,
           depart_time_hhmm,arrival_time_hhmm,travelers_total,
           mode_simple2,simple_purpose) %>%
  filter(row_number()==1) 
  
  # total trips
  plot <- hhts_count(hh_trips,group_vars = c('final_home_is_rgc', 'simple_purpose'),
                     spec_wgt = trip_w[[ix]]) %>%
    drop_na(c('final_home_is_rgc', 'simple_purpose')) %>% 
    filter(simple_purpose != 'Total')
  
  #  to calculate total number of people
  plot2 <- hhts_count(hh_data, group_vars=c("final_home_is_rgc"),
                      spec_wgt = hh_w[[ix]]) %>%
    filter(final_home_is_rgc != 'Total')
  
  # number of trips and total population
  plot3 <- plot %>%
    left_join(plot2, by="final_home_is_rgc", suffix = c('_trips', '_person')) %>% 
    mutate(
      trips_per_person = count_trips / count_person,
      moe_trips_person = moe_ratio(count_trips, count_person, count_moe_trips, count_moe_person)
    ) 
  
  TT <- paste("Household trips by purpose in RGCs",year)
  
  p1<- ggplot(plot3, 
         aes(x=simple_purpose, y=trips_per_person, fill=final_home_is_rgc)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
    ggtitle(TT)+
    psrc_style2(text_size = 2)
  
  data_table <- ggplot(plot3, aes(x = simple_purpose, y = final_home_is_rgc,
                                  label = sample_size_trips)) +
    geom_text() +
    scale_y_discrete(limits=rev)+
    theme(panel.background = element_rect(fill = "white", colour = "white"),
          panel.grid.major = NULL, legend.position = NULL, axis.ticks = element_blank(),#panel.border = NULL, 
          axis.text.x = element_blank()) +
    xlab(NULL) + ylab(NULL)
  
  grid.arrange(p1,data_table, nrow=2, heights=c(4,1))
  return(list(p1,data_table,plot3))
}

plot_17<- trip_purpose_hhtrips(trip_data_17,hh_data_17,2017)
plot_19<- trip_purpose_hhtrips(trip_data_19,hh_data_19,2019)
plot_21<- trip_purpose_hhtrips(trip_data_21,hh_data_21,2021)

plot_all_hh <- plot_17[[3]] %>% mutate(survey ="2017") %>%
  add_row(plot_19[[3]] %>% mutate(survey ="2019")) %>%
  add_row(plot_21[[3]] %>% mutate(survey ="2021")) %>%
  wrap_axis(simple_purpose)
plot_all_hh$cat <- factor(plot_all_hh$cat, levels=c("Work/School","Shop","Errands","Social/\nRecreation/\nMeal"))


 TT <- paste("Household trips by purpose in RGCs")
ggplot(plot_all_hh, 
         aes(x=cat, y=trips_per_person, fill=survey)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  facet_wrap(~final_home_is_rgc)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)

# compare between household and person trips
plot_all <- plot_all_hh %>%
  mutate(type = "Household trips") %>%
  add_row(plot_all_per %>%
  mutate(type = "Person trips"))

TT <- paste("Household and person Work/School trips by purpose in RGCs")
ggplot(plot_all %>% filter(simple_purpose == "Work/School"), 
         aes(x=type, y=trips_per_person, fill=survey)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  facet_wrap(~final_home_is_rgc)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)

TT <- paste("Household and person shopping trips by purpose in RGCs")
ggplot(plot_all %>% filter(simple_purpose == "Shop"), 
         aes(x=type, y=trips_per_person, fill=survey)) +
    geom_col(position = "dodge")+  
    geom_errorbar(aes(ymin=trips_per_person-moe_trips_person, ymax=trips_per_person+moe_trips_person),
                            width=0.2, position = position_dodge(0.9))+
    scale_fill_discrete_psrc ("gnbopgy_5")+
  facet_wrap(~final_home_is_rgc)+
    ggtitle(TT)+
    psrc_style2(text_size = 2)
```
* no clear differences between RGC and non-RGC trip purposes


## Trips by modes
```{r}
trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
hh_w <- c("hh_weight_2017","hh_weight_2019","hh_weight_2021")


plot_rgc <- hhts_count(trip_data_21 %>%
                       filter(race_eth_broad != "Child -- no race specified"),
                     group_vars = c('final_home_is_rgc', 'mode_simple2'),
                     spec_wgt = 'trip_adult_weight_2021') %>% 
  filter(final_home_is_rgc != 'Total',
         !is.na(mode_simple2),
         mode_simple2 != 'Total')

plot_metro <- hhts_count(trip_data_21 %>%
                       filter(race_eth_broad != "Child -- no race specified"),
                     group_vars = c('urban_metro', 'mode_simple2'),
                     spec_wgt = 'trip_adult_weight_2021') %>% 
  filter(urban_metro != 'Total',
         !is.na(mode_simple2),
         mode_simple2 != 'Total')

# TT <- "Trips by mode in RGCs"
# ggplot(plot_rgc, aes(x=mode_simple2, y=share, fill=final_home_is_rgc)) +
#   geom_col(position = "dodge")+  
#   moe_bars+
#   scale_y_continuous(labels=percent) +
#   scale_fill_discrete_psrc ("pognbgy_10")+
#   facet_wrap(~survey)+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)
# TT <- "Trips by mode in metro and urban RGCs"
# ggplot(plot_metro, aes(x=mode_simple2, y=share, fill=urban_metro)) +
#   geom_col(position = "dodge")+  
#   moe_bars+
#   scale_y_continuous(labels=percent) +
#   scale_fill_discrete_psrc ("pognbgy_10")+
#   facet_wrap(~survey)+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)


TT <- "Trips by mode in RGCs (2021 HHTS)"
ggplot(plot_rgc[plot_rgc$mode_simple2!="Other" & plot_rgc$survey == "2021",],
       aes(x=mode_simple2, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

TT <- "Trips by mode in metro and urban RGCs (2021 HHTS)"
ggplot(plot_metro[plot_metro$mode_simple2!="Other" & plot_metro$survey == "2021",],
       aes(x=mode_simple2, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
```

## Trips by modes: percentage change

```{r}
# number of trips and total population
# plot <- plot_metro %>%
#   left_join(plot_metro[plot_metro$survey=="2017",c(2,3,6,7)] %>% 
#               rename(share_base2017 = share,
#                      share_moe_base2017 = share_moe),
#             by = c("urban_metro", "mode_simple2")) %>%
#   filter(survey!="2017",
#          mode_simple2!="Other",
#          !(mode_simple2=="Transit" & urban_metro=="Urban")) %>%
#   mutate(
#     share_change = (share-share_base2017) / share_base2017,
#     share_moe_change = moe_ratio(share, share_base2017, share_moe, share_moe_base2017)
#   ) 
# 
# plot2 <- plot_rgc %>%
#   left_join(plot_rgc[plot_rgc$survey=="2017",c(2,3,6,7)] %>% 
#               rename(share_base2017 = share,
#                      share_moe_base2017 = share_moe),
#             by = c("final_home_is_rgc", "mode_simple2")) %>%
#   filter(survey!="2017",
#          mode_simple2!="Other") %>%
#   mutate(
#     share_change = (share-share_base2017) / share_base2017,
#     share_moe_change = moe_ratio(share, share_base2017, share_moe, share_moe_base2017)
#   ) 
# 
# TT <- "Change in mode share in RGCs"
# ggplot(plot2, aes(x=mode_simple2, y=share_change, fill=survey)) +
#   geom_col(position = "dodge")+
#   geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
#                           width=0.2, position = position_dodge(0.9)) +
#   scale_y_continuous(labels=percent,breaks=seq(-0.6,0.6,0.2)) +
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   facet_wrap(~final_home_is_rgc, scales = "free_x")+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)
# 
# TT <- "Change in mode share in metro and urban RGCs"
# ggplot(plot, aes(x=mode_simple2, y=share_change, fill=survey)) +
#   geom_col(position = "dodge")+
#   geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
#                           width=0.2, position = position_dodge(0.9)) +
#   scale_y_continuous(labels=percent,breaks=seq(-0.6,0.6,0.2)) +
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   facet_wrap(~urban_metro, scales = "free_x")+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)
# 
# 
# trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
# hh_w <- c("hh_weight_2017","hh_weight_2019","hh_weight_2021")


plot_rgc2 <- hhts_count(trip_data_17_19 %>%
                     filter(race_eth_broad != "Child -- no race specified"),
                   group_vars = c('final_home_is_rgc', 'mode_simple2'),
                   spec_wgt = 'trip_weight_2017_2019') %>%  
  add_row(hhts_count(trip_data_21 %>%
                       filter(race_eth_broad != "Child -- no race specified"),
                     group_vars = c('final_home_is_rgc', 'mode_simple2'),
                     spec_wgt = 'trip_adult_weight_2021')) %>% 
  filter(final_home_is_rgc != 'Total',
         !is.na(mode_simple2),
         mode_simple2 != 'Total')

plot_metro2 <- hhts_count(trip_data_17_19 %>%
                     filter(race_eth_broad != "Child -- no race specified"),
                   group_vars = c('urban_metro', 'mode_simple2'),
                   spec_wgt = 'trip_weight_2017_2019') %>%  
  add_row(hhts_count(trip_data_21 %>%
                       filter(race_eth_broad != "Child -- no race specified"),
                     group_vars = c('urban_metro', 'mode_simple2'),
                     spec_wgt = 'trip_adult_weight_2021')) %>% 
  filter(urban_metro != 'Total',
         !is.na(mode_simple2),
         mode_simple2 != 'Total')

plot <- plot_metro2 %>%
  left_join(plot_metro2[plot_metro2$survey=="2017_2019",c(2,3,6,7)] %>% 
              rename(share_base = share,
                     share_moe_base = share_moe),
            by = c("urban_metro", "mode_simple2")) %>%
  filter(survey!="2017_2019",
         mode_simple2!="Other",
         !(mode_simple2=="Transit" & urban_metro=="Urban")) %>%
  mutate(
    share_change = (share-share_base) / share_base,
    share_moe_change = moe_ratio(share, share_base, share_moe, share_moe_base)
  ) 

plot2 <- plot_rgc2 %>%
  left_join(plot_rgc2[plot_rgc2$survey=="2017_2019",c(2,3,6,7)] %>% 
              rename(share_base = share,
                     share_moe_base = share_moe),
            by = c("final_home_is_rgc", "mode_simple2")) %>%
  filter(survey!="2017_2019",
         mode_simple2!="Other") %>%
  mutate(
    share_change = (share-share_base) / share_base,
    share_moe_change = moe_ratio(share, share_base, share_moe, share_moe_base)
  ) 

TT <- "Change in mode share in RGCs \n(2021 compared to 2017/2019 HHTS)"
ggplot(plot2, aes(x=mode_simple2, y=share_change, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+
  geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
                          width=0.2, position = position_dodge(0.9)) +
  scale_y_continuous(labels=percent,breaks=seq(-0.8,0.8,0.2)) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

TT <- "Change in mode share in metro and urban RGCs \n(2021 compared to 2017/2019 HHTS)"
ggplot(plot, aes(x=mode_simple2, y=share_change, fill=urban_metro)) +
  geom_col(position = "dodge")+
  geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
                          width=0.2, position = position_dodge(0.9)) +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
```
* cannot tell if the mode share has change from 2017 to 2019 -> compare 2021 to 2017_2019 instead



Work/Shopping trips by modes
```{r}
prupose_mode <- function(purpose){
  .data <- hhts_count(trip_data_17 %>%
                         filter(race_eth_broad != "Child -- no race specified",
                                simple_purpose==purpose),
                         group_vars = c('final_home_is_rgc', 'mode_simple2'),
                         spec_wgt = 'trip_weight_2017') %>%  
    add_row(hhts_count(trip_data_19 %>%
                         filter(race_eth_broad != "Child -- no race specified",
                                simple_purpose==purpose),
                       group_vars = c('final_home_is_rgc', 'mode_simple2'),
                       spec_wgt = 'trip_weight_2019')) %>%
    add_row(hhts_count(trip_data_21 %>%
                         filter(race_eth_broad != "Child -- no race specified",
                                simple_purpose==purpose),
                       group_vars = c('final_home_is_rgc', 'mode_simple2'),
                       spec_wgt = 'trip_adult_weight_2021')) %>% 
    filter(final_home_is_rgc != 'Total',
           !is.na(mode_simple2),
           mode_simple2 != 'Total')
  
  return(.data)
}

plot_rgc <- prupose_mode("Work/School")

TT <- "Work/School trips by mode in RGCs"
ggplot(plot_rgc, aes(x=mode_simple2, y=share, fill=survey)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  facet_wrap(~final_home_is_rgc, ncol = 2)+
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

plot_rgc <- prupose_mode("Shop")

TT <- "Shopping trips by mode in RGCs"
ggplot(plot_rgc, aes(x=mode_simple2, y=share, fill=survey)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  facet_wrap(~final_home_is_rgc, ncol = 2)+
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
```


* Trip distances / travel time 

```{r}

# Trip distances
plot <- hhts_mean(trip_data_21, stat_var = 'trip_path_distance',
                    group_vars=c('final_home_is_rgc'),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total') %>%
  mutate(label = "Trip distance (miles)") %>%
  rename(mean = trip_path_distance_mean,
         mean_moe = trip_path_distance_mean_moe) %>%
  add_row(hhts_mean(trip_data_21, stat_var = 'google_duration',
                    group_vars=c('final_home_is_rgc'),
                    spec_wgt='trip_adult_weight_2021') %>%
    filter(final_home_is_rgc!='Total') %>%
    mutate(label = "Travel time (minutes)") %>%
    rename(mean = google_duration_mean,
           mean_moe = google_duration_mean_moe))

TT <- "Average travel time and trip distance (2021 HHTS)"
ggplot(plot, 
       aes(x=final_home_is_rgc, y=mean, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=mean-mean_moe, 
                    ymax=mean+mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("pognbgy_10")+
  facet_wrap(~label, scales = "free_y") +
  ggtitle(TT)+
  psrc_style2(text_size = 2)


plot <- hhts_mean(trip_data_21, stat_var = 'trip_path_distance',
                    group_vars=c('urban_metro'),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(urban_metro!='Total') %>%
  mutate(label = "Trip distance (miles)") %>%
  rename(mean = trip_path_distance_mean,
         mean_moe = trip_path_distance_mean_moe) %>%
  add_row(hhts_mean(trip_data_21, stat_var = 'google_duration',
                    group_vars=c('urban_metro'),
                    spec_wgt='trip_adult_weight_2021') %>%
    filter(urban_metro!='Total') %>%
    mutate(label = "Travel time (minutes)") %>%
    rename(mean = google_duration_mean,
           mean_moe = google_duration_mean_moe))

TT <- "Average travel time and trip distance (2021 HHTS)"
ggplot(plot, 
       aes(x=urban_metro, y=mean, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=mean-mean_moe, 
                    ymax=mean+mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("gnbopgy_5")+
  facet_wrap(~label, scales = "free_y") +
  ggtitle(TT)+
  psrc_style2(text_size = 2)

```


* Trip distances / travel time by purpose

```{r}


# Trip distances
plot <- hhts_mean(trip_data_21, stat_var = 'trip_path_distance',
                    group_vars=c('final_home_is_rgc', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total',
         simple_purpose!= "Total")
plot2 <- hhts_median(trip_data_21, stat_var = 'trip_path_distance',
                    group_vars=c('final_home_is_rgc', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total')

TT <- "Average trip distances by purpose (miles, 2021 HHTS)"
ggplot(plot[plot$survey=="2021" & plot$simple_purpose!= "Total",], 
       aes(x=simple_purpose, y=trip_path_distance_mean, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=trip_path_distance_mean-trip_path_distance_mean_moe, 
                    ymax=trip_path_distance_mean+trip_path_distance_mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
TT <- "Median trip distances by purpose (miles)"
# ggplot(plot2[plot2$survey=="2021" & plot2$simple_purpose!= "Total",], 
#        aes(x=simple_purpose, y=trip_path_distance_median, fill=final_home_is_rgc)) +
#   geom_col(position = "dodge")+  
#   geom_errorbar(aes(ymin=trip_path_distance_median-trip_path_distance_median_moe, 
#                     ymax=trip_path_distance_median+trip_path_distance_median_moe),
#                           width=0.2, position = position_dodge(0.9))+
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)

plot <- hhts_mean(trip_data_21, stat_var = 'trip_path_distance',
                    group_vars=c('urban_metro', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(urban_metro!='Total',
         simple_purpose!= "Total")
plot2 <- hhts_median(trip_data_21, stat_var = 'trip_path_distance',
                    group_vars=c('urban_metro', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(urban_metro!='Total')

TT <- "Average trip distances by purpose (miles, 2021 HHTS)"
ggplot(plot[plot$survey=="2021" & plot$simple_purpose!= "Total",], 
       aes(x=simple_purpose, y=trip_path_distance_mean, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=trip_path_distance_mean-trip_path_distance_mean_moe, 
                    ymax=trip_path_distance_mean+trip_path_distance_mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
# TT <- "Median trip distances by purpose (miles)"
# ggplot(plot2[plot2$survey=="2021" & plot2$simple_purpose!= "Total",], 
#        aes(x=simple_purpose, y=trip_path_distance_median, fill=urban_metro)) +
#   geom_col(position = "dodge")+  
#   geom_errorbar(aes(ymin=trip_path_distance_median-trip_path_distance_median_moe, 
#                     ymax=trip_path_distance_median+trip_path_distance_median_moe),
#                           width=0.2, position = position_dodge(0.9))+
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)

# travel time
plot <- hhts_mean(trip_data_21, stat_var = 'google_duration',
                    group_vars=c('final_home_is_rgc', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total',
         simple_purpose!= "Total")
plot2 <- hhts_median(trip_data_21, stat_var = 'google_duration',
                    group_vars=c('final_home_is_rgc', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total',
         simple_purpose!= "Total")

TT <- "Average trip travel time by purpose (minutes, 2021 HHTS)"
ggplot(plot, 
       aes(x=simple_purpose, y=google_duration_mean, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=google_duration_mean-google_duration_mean_moe, 
                    ymax=google_duration_mean+google_duration_mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

TT <- "Median trip travel time by purpose (minutes)"
# ggplot(plot2, 
#        aes(x=simple_purpose, y=google_duration_median, fill=final_home_is_rgc)) +
#   geom_col(position = "dodge")+  
#   geom_errorbar(aes(ymin=google_duration_median-google_duration_median_moe, 
#                     ymax=google_duration_median+google_duration_median_moe),
#                           width=0.2, position = position_dodge(0.9))+
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)

plot <- hhts_mean(trip_data_21, stat_var = 'google_duration',
                    group_vars=c('urban_metro', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(urban_metro!='Total',
         simple_purpose!= "Total")
plot2 <- hhts_median(trip_data_21, stat_var = 'google_duration',
                    group_vars=c('urban_metro', "simple_purpose"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(urban_metro!='Total',
         simple_purpose!= "Total")

TT <- "Average trip travel time by purpose (minutes, 2021 HHTS)"
ggplot(plot, 
       aes(x=simple_purpose, y=google_duration_mean, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=google_duration_mean-google_duration_mean_moe, 
                    ymax=google_duration_mean+google_duration_mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

# TT <- "Median trip travel time by purpose (minutes)"
# ggplot(plot2, 
#        aes(x=simple_purpose, y=google_duration_median, fill=urban_metro)) +
#   geom_col(position = "dodge")+  
#   geom_errorbar(aes(ymin=google_duration_median-google_duration_median_moe, 
#                     ymax=google_duration_median+google_duration_median_moe),
#                           width=0.2, position = position_dodge(0.9))+
#   scale_fill_discrete_psrc ("gnbopgy_5")+
#   ggtitle(TT)+
#   psrc_style2(text_size = 2)
```
* All transit trips
```{r}
plot  <- hhts_count(trip_data_21 %>%
                      filter(mode_simple=="Drive"), 
                    group_vars=c("urban_metro", "simple_purpose"),
                    spec_wgt = "trip_adult_weight_2021") %>%
  filter(simple_purpose!="Total")
TT <- "Purposes for driving trips"
ggplot(plot, 
       aes(x=urban_metro, y=share, fill=simple_purpose)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)


plot  <- hhts_count(trip_data_21 %>%
                      filter(mode_simple=="Transit"), 
                    group_vars=c("urban_metro", "simple_purpose"),
                    spec_wgt = "trip_adult_weight_2021") %>%
  filter(simple_purpose!="Total",
         urban_metro!="Urban")
TT <- "Purposes for transit trips"
ggplot(plot, 
       aes(x=urban_metro, y=share, fill=simple_purpose)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

plot  <- hhts_count(trip_data_21 %>%
                      filter(mode_simple=="Walk"), 
                    group_vars=c("urban_metro", "simple_purpose"),
                    spec_wgt = "trip_adult_weight_2021") %>%
  filter(simple_purpose!="Total")
TT <- "Purposes for walking trips"
ggplot(plot, 
       aes(x=urban_metro, y=share, fill=simple_purpose)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
```

transit work trip travel time
```{r}
plot <- hhts_mean(trip_data_21 %>%
                      filter(simple_purpose=="Work/School"), 
                  stat_var = 'google_duration',
                    group_vars=c('final_home_is_rgc', "mode_simple"),
                    spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total',
         mode_simple %in% c("Drive","Transit","Bike","Walk"))

TT <- "Average trip travel time by purpose (minutes)"
ggplot(plot, 
       aes(x=simple_purpose, y=google_duration_mean, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=google_duration_mean-google_duration_mean_moe, 
                    ymax=google_duration_mean+google_duration_mean_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

plot2 <- hhts_median(trip_data_21 %>%
                      filter(simple_purpose=="Work/School"), 
                     stat_var = 'google_duration',
                     group_vars=c('final_home_is_rgc', "mode_simple"),
                     spec_wgt='trip_adult_weight_2021') %>%
  filter(final_home_is_rgc!='Total',
         mode_simple %in% c("Drive","Transit","Bike","Walk"))
TT <- "Median trip travel time by purpose (minutes)"
ggplot(plot2, 
       aes(x=mode_simple, y=google_duration_median, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  geom_errorbar(aes(ymin=google_duration_median-google_duration_median_moe, 
                    ymax=google_duration_median+google_duration_median_moe),
                          width=0.2, position = position_dodge(0.9))+
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
```


```{r}
freq <- per_data_21 %>%
    mutate(walk_label = case_when(walk_freq %in% c("1 day/week",
                                              "2-4 days/week",
                                              "5 days/week",
                                              "6-7 days/week")~"at least 1 day/week",
                             TRUE~ "less than 1 day/week"),
           transit_label = case_when(transit_freq %in% c("1 day/week",
                                              "2-4 days/week",
                                              "5 days/week",
                                              "6-7 days/week")~"at least 1 day/week",
                             TRUE~ "less than 1 day/week"))
plot  <- hhts_count(freq, 
                    group_vars=c("urban_metro", "transit_label"),
                    spec_wgt = "person_adult_weight_2021") %>%
  filter(transit_label!="Total") 
TT <- "Transit frequency (2021 HHTS)"
ggplot(plot, 
       aes(x=transit_label, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

plot  <- hhts_count(freq, 
                    group_vars=c("urban_metro", "walk_label"),
                    spec_wgt = "person_adult_weight_2021") %>%
  filter(walk_label!="Total") 
TT <- "Walk frequency (2021 HHTS)"
ggplot(plot, 
       aes(x=walk_label, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars+
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

```

```{r}

trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
hh_w <- c("hh_weight_2017","hh_weight_2019","hh_weight_2021")


freq <- function(.data){
  .data %>% 
    mutate(walk_label = case_when(walk_freq %in% c("1 day/week",
                                                  "2-4 days/week",
                                                  "5 days/week",
                                                  "6-7 days/week")~"at least 1 day/week",
                                 TRUE~ "less than 1 day/week"),
           transit_label = case_when(transit_freq %in% c("1 day/week",
                                                  "2-4 days/week",
                                                  "5 days/week",
                                                  "6-7 days/week")~"at least 1 day/week",
                                 TRUE~ "less than 1 day/week"))
}
    

plot_rgc <- hhts_count(per_data_17 %>%freq(),
                   group_vars = c('final_home_is_rgc', 'walk_label'),
                   spec_wgt = 'hh_weight_2017') %>%  
  add_row(hhts_count(per_data_19 %>%freq(),
                   group_vars = c('final_home_is_rgc', 'walk_label'),
                     spec_wgt = 'hh_weight_2019')) %>%
  add_row(hhts_count(per_data_21 %>%freq(),
                   group_vars = c('final_home_is_rgc', 'walk_label'),
                     spec_wgt = 'hh_weight_2021')) %>% 
  filter( walk_label != 'Total')


plot_metro <- hhts_count(per_data_17 %>%freq(),
                   group_vars = c('urban_metro', 'walk_label'),
                   spec_wgt = 'hh_weight_2017') %>%  
  add_row(hhts_count(per_data_19 %>%freq(),
                   group_vars = c('urban_metro', 'walk_label'),
                     spec_wgt = 'hh_weight_2019')) %>%
  add_row(hhts_count(per_data_21 %>%freq(),
                   group_vars = c('urban_metro', 'walk_label'),
                     spec_wgt = 'hh_weight_2021')) %>% 
  filter( walk_label != 'Total')

# number of trips and total population
plot <- plot_metro %>%
  left_join(plot_metro[plot_metro$survey=="2017",c(2,3,6,7)] %>% 
              rename(share_base2017 = share,
                     share_moe_base2017 = share_moe),
            by = c("urban_metro", "walk_label")) %>%
  filter(survey!="2017") %>%
  mutate(
    share_change = (share-share_base2017) / share_base2017,
    share_moe_change = moe_ratio(share, share_base2017, share_moe, share_moe_base2017)
  ) 

plot2 <- plot_rgc %>%
  left_join(plot_rgc[plot_rgc$survey=="2017",c(2,3,6,7)] %>% 
              rename(share_base2017 = share,
                     share_moe_base2017 = share_moe),
            by = c("final_home_is_rgc", "walk_label")) %>%
  filter(survey!="2017") %>%
  mutate(
    share_change = (share-share_base2017) / share_base2017,
    share_moe_change = moe_ratio(share, share_base2017, share_moe, share_moe_base2017)
  ) 

TT <- "Change in walk frequency in RGCs"
ggplot(plot2 %>% filter(walk_label=="at least 1 day/week"), aes(x=final_home_is_rgc, y=share_change, fill=survey)) +
  geom_col(position = "dodge")+
  geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
                          width=0.2, position = position_dodge(0.9)) +
  scale_y_continuous(labels=percent#,breaks=seq(-0.6,0.6,0.2)
                     ) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~final_home_is_rgc, scales = "free_x")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

ggplot(plot %>% filter(walk_label=="at least 1 day/week"), aes(x=urban_metro, y=share_change, fill=survey)) +
  geom_col(position = "dodge")+
  geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
                          width=0.2, position = position_dodge(0.9)) +
  scale_y_continuous(labels=percent#,breaks=seq(-0.6,0.6,0.2)
                     ) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~final_home_is_rgc, scales = "free_x")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)


plot_rgc2 <- hhts_count(per_data_17_19 %>%freq(),
                   group_vars = c('final_home_is_rgc', 'walk_label'),
                   spec_wgt = 'hh_weight_2017_2019') %>%  
  add_row(hhts_count(per_data_21 %>%freq(),
                   group_vars = c('final_home_is_rgc', 'walk_label'),
                     spec_wgt = 'hh_weight_2021')) %>% 
  filter( walk_label != 'Total')


plot_metro2 <- hhts_count(per_data_17_19 %>%freq(),
                   group_vars = c('urban_metro', 'walk_label'),
                   spec_wgt = 'hh_weight_2017_2019') %>%  
  add_row(hhts_count(per_data_21 %>%freq(),
                   group_vars = c('urban_metro', 'walk_label'),
                     spec_wgt = 'hh_weight_2021')) %>% 
  filter( walk_label != 'Total')


plot <- plot_metro2 %>%
  left_join(plot_metro2[plot_metro2$survey=="2017_2019",c(2,3,6,7)] %>% 
              rename(share_base = share,
                     share_moe_base = share_moe),
            by = c("urban_metro", "walk_label")) %>%
  filter(survey!="2017_2019") %>%
  mutate(
    share_change = (share-share_base) / share_base,
    share_moe_change = moe_ratio(share, share_base, share_moe, share_moe_base)
  ) 

plot2 <- plot_rgc2 %>%
  left_join(plot_rgc2[plot_rgc2$survey=="2017_2019",c(2,3,6,7)] %>% 
              rename(share_base = share,
                     share_moe_base = share_moe),
            by = c("final_home_is_rgc", "walk_label")) %>%
  filter(survey!="2017_2019") %>%
  mutate(
    share_change = (share-share_base) / share_base,
    share_moe_change = moe_ratio(share, share_base, share_moe, share_moe_base)
  ) 

TT <- "Change in walk frequency in RGCs"
ggplot(plot2 %>% filter(walk_label=="at least 1 day/week"), aes(x=final_home_is_rgc, y=share_change, fill=survey)) +
  geom_col(position = "dodge")+
  geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
                          width=0.2, position = position_dodge(0.9)) +
  scale_y_continuous(labels=percent#,breaks=seq(-0.6,0.6,0.2)
                     ) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~final_home_is_rgc, scales = "free_x")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)

ggplot(plot %>% filter(walk_label=="at least 1 day/week"), aes(x=urban_metro, y=share_change, fill=survey)) +
  geom_col(position = "dodge")+
  geom_errorbar(aes(ymin=share_change-share_moe_change, ymax=share_change+share_moe_change),
                          width=0.2, position = position_dodge(0.9)) +
  scale_y_continuous(labels=percent#,breaks=seq(-0.6,0.6,0.2)
                     ) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  # facet_wrap(~final_home_is_rgc, scales = "free_x")+
  ggtitle(TT)+
  psrc_style2(text_size = 2)
```



```{r}

query <- function(est_name, table, variable=NULL, tracts, not_in="no"){
  
  if(not_in=="no"){
    con <- "in"
  }
  else{
    con <- "not in"
  }
  
  if(is.null(variable)){
    return(
      paste("select geoid, variable_label, estimate as ", est_name, ", margin_of_error as ", est_name,"_moe 
            ",
            
            "from census.census_table(2021,'Tract','ACS1','", table, "')",
            "where geoid ",con," (",paste(tracts, collapse=", "),")",
            sep="")
    )
  }
  else{
    return(
      paste("select geoid, estimate as ", est_name, ", margin_of_error as ", est_name,"_moe 
            ",
            
            "from census.census_table(2020,'Tract','ACS5','", table, "')",
            "where variable_name = '", variable, "' ",
            "and geoid ",con," (",paste(tracts, collapse=", "),")",
            sep="")
      )
  }
  
  
}

df <- dbGetQuery(elmer_connection, 
                 SQL(query("no_veh", "B08201", "B08201_002", rgcs_tracts)))
df <- dbGetQuery(elmer_connection, 
                 SQL(query("no_veh", "B08201", tracts=rgcs_tracts)))
df_not <- dbGetQuery(elmer_connection, 
                 SQL(query("no_veh", "B08201", tracts=rgcs_tracts, not_in="yes")))

unique(df$variable_label)
census_veh <- df %>%
  summarise(pop = sum(no_veh*(variable_label=="Total:")),
            no_veh_sum = sum(no_veh*(variable_label=="Total:No vehicle available"))) %>%
  mutate(RGC = "RGC") %>%
  add_row(df_not %>%
    summarise(pop = sum(no_veh*(variable_label=="Total:")),
              no_veh_sum = sum(no_veh*(variable_label=="Total:No vehicle available"))) %>%
    mutate(RGC = "Not RGC")) %>%
  mutate(vehicle_occu_rate = (pop-no_veh_sum)/pop)

```


```{r}
library(psrccensus)
# Sys.setenv(CENSUS_API_KEY = '3fc20d0d6664692c0becc323b82c752408d843d9')
Sys.getenv("CENSUS_API_KEY")
# test <- get_acs_recs(geography = 'tract',
#              table.names = 'B08201',
#              years = 2020,
#              acs.type = 'acs5')
```

# Age

```{r}
age <- get_acs_recs(geography = 'tract',
                    table.names = 'B01001',
                    years = 2021,
                    acs.type = 'acs5') %>%
  add_RGCs() %>%
  filter(!label %in% c("Estimate!!Total:","Estimate!!Total:!!Male:","Estimate!!Total:!!Female:" )) %>%
  mutate(label2 = str_remove_all(label,"Estimate!!Total:"),
         label2 = str_remove_all(label2,"!!Male:"),
         label2 = str_remove_all(label2,"!!Female:"),
         label2 = str_remove_all(label2,"!!"),
         label3 = case_when(label2 %in% c("10 to 14 years","15 to 17 years",
                                        "5 to 9 years","Under 5 years")~ "< 18 years",
                            label2 %in% c("18 and 19 years",  
                                         "20 years",         
                                         "21 years",         
                                         "22 to 24 years",   
                                         "25 to 29 years",   
                                         "30 to 34 years")~ "18-34 years",
                            label2 %in% c("35 to 39 years",
                                          "40 to 44 years",
                                          "45 to 49 years",
                                          "50 to 54 years",
                                          "55 to 59 years",
                                          "60 and 61 years",
                                          "62 to 64 years")~ "35-64 years",
                            label2 %in% c("65 and 66 years",
                                         "67 to 69 years",
                                         "70 to 74 years",
                                         "75 to 79 years",
                                         "80 to 84 years",
                                         "85 years and over")~ "65+ years",
                            TRUE ~ label2)) %>%
  group_by(label3, RGC) %>%
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe, estimate = estimate) )%>%
  group_by(RGC) %>%
  mutate(share = estimate/sum(estimate),
         share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
  ungroup()
 

TT <- "Age (2021 ACS 1-year data)"
ggplot(age, aes(x=label3, y=share, fill=RGC)) +
  geom_col(position = "dodge")+  
  # moe_bars +
  scale_y_continuous(labels=percent,limits = c(0, 0.41)) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2) + 
  geom_text(aes(x=label3,y=share, 
    label=paste0(prettyNum(round(share*100,0), big.mark = ","),"%")),
    check_overlap = TRUE,
    position = position_dodge(0.9),
    vjust = -0.25,
    size = 11*0.36,
    family="Poppins") +
  theme(axis.text.y = element_blank(),
        panel.grid.major.y = element_blank()
        )
```




```{r}
test_rgc <- get_acs_recs(geography = 'tract',
             table.names = 'B08201',
             years = 2021,
             acs.type = 'acs1') %>%
  filter(label %in% c(#"Estimate!!Total:",
                      "Estimate!!Total:!!No vehicle available",
                      "Estimate!!Total:!!1 vehicle available",
                      "Estimate!!Total:!!2 vehicles available",
                      "Estimate!!Total:!!3 vehicles available",
                      "Estimate!!Total:!!4 or more vehicles available")) %>%
  mutate(RGC = case_when(GEOID %in% rgcs_tracts_list$geoid~"RGC",
                         !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
         urban_metro = case_when(GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Metro",]$geoid~"Metro",
                                 GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Urban",]$geoid~"Urban",
                         !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
         label2 = case_when(label %in% c("Estimate!!Total:!!1 vehicle available",
                                         "Estimate!!Total:!!2 vehicles available",
                                         "Estimate!!Total:!!3 vehicles available",
                                         "Estimate!!Total:!!4 or more vehicles available")~"1 or more vehicle(s)",
                            label=="Estimate!!Total:!!No vehicle available"~"No vehicle"))
test_rgc$urban_metro <- factor(test_rgc$urban_metro, levels=c("Metro","Urban","Not RGC")) 


plot <- test_rgc %>%
  group_by(label2,urban_metro) %>%
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe, estimate = estimate)) %>%
  group_by(urban_metro) %>%
  mutate(share = estimate/sum(estimate),
         share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
  ungroup() %>%
  filter(label2 == "1 or more vehicle(s)")


TT <- "Vehicle ownership (2021 ACS 1-year data)"
ggplot(plot, aes(x=label2, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2)



test_rgc <- get_acs_recs(geography = 'tract',
             table.names = 'B08201',
             years = 2021,
             acs.type = 'acs1') %>%
  filter(label %in% c(#"Estimate!!Total:",
                      "Estimate!!Total:!!1-person household:",
                      "Estimate!!Total:!!2-person household:",
                      "Estimate!!Total:!!3-person household:",
                      "Estimate!!Total:!!4-or-more-person household:")) %>%
  mutate(RGC = case_when(GEOID %in% rgcs_tracts_list$geoid~"RGC",
                         !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
         urban_metro = case_when(GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Metro",]$geoid~"Metro",
                                 GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Urban",]$geoid~"Urban",
                         !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
         label2 = case_when(label == "Estimate!!Total:!!1-person household:" ~ "Single-person",
                            TRUE~"2-or-more-person"))
test_rgc$urban_metro <- factor(test_rgc$urban_metro, levels=c("Metro","Urban","Not RGC")) 
test_rgc$label2 <- factor(test_rgc$label2, levels=c("Single-person","2-or-more-person")) 


plot2 <- test_rgc %>%
  group_by(label2,urban_metro) %>%
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe, estimate = estimate)) %>%
  group_by(urban_metro) %>%
  mutate(share = estimate/sum(estimate),
         share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
  ungroup() %>%
  filter(label2 =="Single-person")


TT <- "Household size (2021 ACS 1-year data)"
ggplot(plot2, aes(x=label2, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2)

```


```{r}

test_rgc <- get_acs_recs(geography = 'tract',
             table.names = 'B19001',
             years = 2021,
             acs.type = 'acs1') %>%
  filter(label != "Estimate!!Total:") %>%
  mutate(RGC = case_when(GEOID %in% rgcs_tracts_list$geoid~"RGC",
                         !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
         urban_metro = case_when(GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Metro",]$geoid~"Metro",
                                 GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Urban",]$geoid~"Urban",
                         !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
         label2 = case_when(label %in% c("Estimate!!Total:!!Less than $10,000",
                                        "Estimate!!Total:!!$10,000 to $14,999",
                                        "Estimate!!Total:!!$15,000 to $19,999",
                                        "Estimate!!Total:!!$20,000 to $24,999",
                                        "Estimate!!Total:!!$25,000 to $29,999",
                                        "Estimate!!Total:!!$30,000 to $34,999",
                                        "Estimate!!Total:!!$35,000 to $39,999",
                                        "Estimate!!Total:!!$40,000 to $44,999",
                                        "Estimate!!Total:!!$45,000 to $49,999") ~ "Under $50,000",
                            TRUE~"$50,000 and over"))
test_rgc$urban_metro <- factor(test_rgc$urban_metro, levels=c("Metro","Urban","Not RGC")) 
test_rgc$label2 <- factor(test_rgc$label2, levels=c("Under $50,000","$50,000 and over")) 


plot <- test_rgc %>%
  group_by(label2,urban_metro) %>%
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe, estimate = estimate)) %>%
  group_by(urban_metro) %>%
  mutate(share = estimate/sum(estimate),
         share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
  ungroup() 


TT <- "Household income (2021 ACS 1-year data)"
ggplot(plot, aes(x=label2, y=share, fill=urban_metro)) +
  geom_col(position = "dodge")+  
  moe_bars +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("gnbopgy_5")+
  ggtitle(TT)+
  psrc_style2(axis_text_size = 2)

```

# check HHTS and ACS vehicle ownership
```{r}
library(psrccensus)
Sys.setenv(CENSUS_API_KEY = '3fc20d0d6664692c0becc323b82c752408d843d9')
Sys.getenv("CENSUS_API_KEY")
# test <- get_acs_recs(geography = 'tract',
#              table.names = 'B08201',
#              years = 2020,
#              acs.type = 'acs5')
trip_w <- c("trip_weight_2017","trip_weight_2019","trip_adult_weight_2021")
hh_w <- c("hh_weight_2017","hh_weight_2019","hh_weight_2021")


veh_compare <- function(year,per_data){
  
    
  if(year==2017){
    ix <- 1
  }
  else if(year==2019){
    ix <- 2
  }
  else{
    ix <- 3
  }
  
  abb <- substr(as.character(year),3,4)
  
  acs <- get_acs_recs(geography = 'tract',
               table.names = 'B08201',
               years = year,
               acs.type = 'acs1') %>%
      filter(label %in% c("Estimate!!Total!!No vehicle available",
                        "Estimate!!Total!!1 vehicle available",
                        "Estimate!!Total!!2 vehicles available",
                        "Estimate!!Total!!3 vehicles available",
                        "Estimate!!Total!!4 or more vehicles available",
                        "Estimate!!Total:!!No vehicle available",
                        "Estimate!!Total:!!1 vehicle available",
                        "Estimate!!Total:!!2 vehicles available",
                        "Estimate!!Total:!!3 vehicles available",
                        "Estimate!!Total:!!4 or more vehicles available")) %>%
    mutate(County = case_when(substr(GEOID,3,5)=="033"~"King",
                              substr(GEOID,3,5)=="035"~"Kitsap",
                              substr(GEOID,3,5)=="053"~"Pierce",
                              substr(GEOID,3,5)=="061"~"Snohomish"),
           RGC = case_when(GEOID %in% rgcs_tracts_list$geoid~"RGC",
                           !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
           urban_metro = case_when(GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Metro",]$geoid~"Metro",
                                   GEOID %in% rgcs_tracts_list[rgcs_tracts_list$urban_metro=="Urban",]$geoid~"Urban",
                           !GEOID %in% rgcs_tracts_list$geoid~"Not RGC"),
           label2 = case_when(label %in% c("Estimate!!Total!!1 vehicle available",
                                           "Estimate!!Total!!2 vehicles available",
                                           "Estimate!!Total!!3 vehicles available",
                                           "Estimate!!Total!!4 or more vehicles available",
                                           "Estimate!!Total:!!1 vehicle available",
                                           "Estimate!!Total:!!2 vehicles available",
                                           "Estimate!!Total:!!3 vehicles available",
                                           "Estimate!!Total:!!4 or more vehicles available")~"1 or more vehicle(s)",
                              label %in% c("Estimate!!Total!!No vehicle available",
                                           "Estimate!!Total:!!No vehicle available")~"No vehicle"))
  acs$urban_metro <- factor(acs$urban_metro, levels=c("Metro","Urban","Not RGC")) 
  acs$RGC <- factor(acs$RGC, levels=c("RGC","Not RGC"))
  
  plot_acs <- acs %>%
    # County
    group_by(label2,County) %>%
    summarise(estimate = sum(estimate),
              moe = moe_sum(moe, estimate = estimate)) %>%
    group_by(County) %>%
    mutate(share = estimate/sum(estimate),
           share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
    ungroup() %>%
    filter(label2 == "1 or more vehicle(s)") %>%
    select(County,share,share_moe) %>%
    mutate(data = "ACS",
           group = "County") %>%
    rename(label = County) %>%
    # RGC
    add_row(acs %>%
      group_by(label2,RGC) %>%
      summarise(estimate = sum(estimate),
                moe = moe_sum(moe, estimate = estimate)) %>%
      group_by(RGC) %>%
      mutate(share = estimate/sum(estimate),
             share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
      ungroup() %>%
      filter(label2 == "1 or more vehicle(s)") %>%
      select(RGC,share,share_moe) %>%
      mutate(data = "ACS",
             group = "RGC") %>%
      rename(label = RGC)) %>%
    # Metro and Urban RGC
    add_row(acs %>%
        group_by(label2,urban_metro) %>%
        summarise(estimate = sum(estimate),
                  moe = moe_sum(moe, estimate = estimate)) %>%
        group_by(urban_metro) %>%
        mutate(share = estimate/sum(estimate),
               share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
        ungroup() %>%
        filter(label2 == "1 or more vehicle(s)") %>%
        select(urban_metro,share,share_moe) %>%
        mutate(data = "ACS",
               group = "Metro and Urban RGC") %>%
        rename(label = urban_metro)) %>%
    # total
    add_row(acs %>%
        group_by(label2) %>%
        summarise(estimate = sum(estimate),
                  moe = moe_sum(moe, estimate = estimate)) %>%
        ungroup() %>%
        mutate(share = estimate/sum(estimate),
               share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
        filter(label2 == "1 or more vehicle(s)") %>%
        select(share,share_moe) %>%
        mutate(data = "ACS",
               group = "Total",
               label = "Total"))
  
  plot_hhts <- hhts_count(per_data, group_vars=c("sample_county","vehicle_binary"),
                      spec_wgt = hh_w[[ix]]) %>%
    filter(vehicle_binary=="1 or more",
           !is.na(sample_county)) %>%
    mutate(vehicle_binary="1 vehicle or more") %>%
    select(sample_county,share,share_moe) %>%
    mutate(data = "HHTS",
           group = "County") %>%
    rename(label = sample_county) %>%
    # RGC
    add_row(hhts_count(per_data, group_vars=c("final_home_is_rgc","vehicle_binary"),
                      spec_wgt = hh_w[[ix]]) %>%
    filter(vehicle_binary=="1 or more",
           !is.na(final_home_is_rgc)) %>%
    mutate(vehicle_binary="1 vehicle or more") %>%
    select(final_home_is_rgc,share,share_moe) %>%
    mutate(data = "HHTS",
           group = "RGC") %>%
    rename(label = final_home_is_rgc)) %>%
    # Metro and Urban RGC
    add_row(hhts_count(per_data, group_vars=c("urban_metro","vehicle_binary"),
                        spec_wgt = hh_w[[ix]]) %>%
      filter(vehicle_binary=="1 or more",
             !is.na(urban_metro)) %>%
      mutate(vehicle_binary="1 vehicle or more") %>%
      select(urban_metro,share,share_moe) %>%
      mutate(data = "HHTS",
             group = "Metro and Urban RGC") %>%
      rename(label = urban_metro)) %>%
    # Total
    add_row(hhts_count(per_data, group_vars=c("vehicle_binary"),
                        spec_wgt = hh_w[[ix]]) %>%
      filter(vehicle_binary=="1 or more") %>%
      mutate(vehicle_binary="1 vehicle or more") %>%
      select(share,share_moe) %>%
      mutate(data = "HHTS",
             group = "Total",
             label = "Total"))
  plot <- plot_acs %>% add_row(plot_hhts)
  plot$label <- factor(plot$label, levels=c("RGC","Metro","Urban","Not RGC",
                                            "King","Kitsap", "Pierce", "Snohomish",
                                            "Total")) 
  plot$group <- factor(plot$group, levels=c("County","RGC","Metro and Urban RGC","Total")) 
  
  return(plot)

}

plot2017 <- veh_compare(2017, hh_data_17)
plot2019 <- veh_compare(2019, hh_data_19)
plot2021 <- veh_compare(2021, hh_data_21)



veh_plot <- function(plot, year){
  
  
  TT <- paste("Vehicle ownership (",year,")",sep = "")
  
  
  return(
    ggplot(plot, aes(x=label, y=share, fill=data)) +
      geom_col(position = "dodge")+  
      moe_bars +
      scale_y_continuous(labels=percent) +
      scale_fill_discrete_psrc ("gnbopgy_5")+
      facet_grid(cols = vars(group), scales = "free_x", space = "free_x")+
      # facet_wrap(~group,scales = "free_x", ncol = 4)+
      ggtitle(TT)+
      psrc_style2()
  )
}

veh_plot(plot2017,2017)
veh_plot(plot2019,2019)
veh_plot(plot2021,2021)

vehicle_ownership <- plot2017 %>% 
  mutate(year = 2017) %>%
  add_row(plot2019 %>% 
  mutate(year = 2019)) %>% 
  add_row(plot2021 %>% 
  mutate(year = 2021))


```


# urban and metro rgc counties
```{r}
acs <- get_acs_recs(geography = 'block group',
               table.names = 'B08201',
               years = 2021,
               acs.type = 'acs1') %>%
      filter(label %in% c("Estimate!!Total!!No vehicle available",
                        "Estimate!!Total!!1 vehicle available",
                        "Estimate!!Total!!2 vehicles available",
                        "Estimate!!Total!!3 vehicles available",
                        "Estimate!!Total!!4 or more vehicles available",
                        "Estimate!!Total:!!No vehicle available",
                        "Estimate!!Total:!!1 vehicle available",
                        "Estimate!!Total:!!2 vehicles available",
                        "Estimate!!Total:!!3 vehicles available",
                        "Estimate!!Total:!!4 or more vehicles available")) %>%
  mutate(GEOID = as.numeric(GEOID)) %>%
  left_join(rgcs_tracts_list %>%
              mutate(rgc = name), by =c("GEOID"="geoid")) %>%
    mutate(label2 = case_when(label %in% c("Estimate!!Total!!1 vehicle available",
                                           "Estimate!!Total!!2 vehicles available",
                                           "Estimate!!Total!!3 vehicles available",
                                           "Estimate!!Total!!4 or more vehicles available",
                                           "Estimate!!Total:!!1 vehicle available",
                                           "Estimate!!Total:!!2 vehicles available",
                                           "Estimate!!Total:!!3 vehicles available",
                                           "Estimate!!Total:!!4 or more vehicles available")~"1 or more vehicle(s)",
                              label %in% c("Estimate!!Total!!No vehicle available",
                                           "Estimate!!Total:!!No vehicle available")~"No vehicle"),
           rgc = ifelse(is.na(rgc),"Not RGC",rgc))%>%
      group_by(label2,rgc) %>%
      summarise(estimate = sum(estimate),
                moe = moe_sum(moe, estimate = estimate)) %>%
      group_by(rgc) %>%
      mutate(share = estimate/sum(estimate),
             share_moe = moe_ratio(estimate, sum(estimate), moe, moe_sum(moe, estimate = estimate))) %>%
      ungroup() %>%
      filter(label2 == "1 or more vehicle(s)") 

ggplot(acs, aes(x=reorder(rgc,-share), y=share)) +
      geom_col(position = "dodge")+  
      moe_bars +
      scale_y_continuous(labels=percent) +
      scale_fill_discrete_psrc ("gnbopgy_5")+
      # facet_grid(cols = vars(group), scales = "free_x", space = "free_x")+
      # facet_wrap(~group,scales = "free_x", ncol = 4)+
      ggtitle(TT)+
      psrc_style2() +
  coord_flip()
```


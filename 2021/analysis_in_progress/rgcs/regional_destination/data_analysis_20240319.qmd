---
title: "Regional destination data analysis"
date: today
format: 
  html:
    mainfont: Poppins
    theme: cosmo
    toc: true
    df-print: kable
    warning: false
    echo: false
---

```{r}
source("region_dest_data.R")

formatting_func <- function(.data){
  .data %>%
  mutate(share = scales::percent(share,accuracy=1),
         count = scales::number(count,accuracy=1000,big.mark = ","),
         `trip/acre` = scales::number(`trip/acre`,accuracy=0.01,big.mark = ","),
         `trip/activity unit` = scales::number(`trip/activity unit`,accuracy=0.01))
}

pal_rgc <- c(psrc_colors$purples_inc[2],psrc_colors$greens_inc[2])
pal_rgc <- setNames(pal_rgc, c("RGC","Not RGC"))

pal_rgc_mu <- c(psrc_colors$oranges_inc[2],psrc_colors$blues_inc[2],psrc_colors$greens_inc[2])
pal_rgc_mu <- setNames(pal_rgc_mu, c("Metro","Urban","Not RGC"))

```


## edits since 2/28 check-in
- filter trips to UGA geography
- color code table by area type for clearer visualization
- use acres instead of sq. miles
- create hexagon maps
- create map with trip destination points
- get more accurate population and employment data


:::{.callout-note}
- study area: Urban Growth Area (only include trips ended in UGA)
- trip types:
  1. **non-work trips**: Shop, Meal, Social/Recreation, Escort and Errand/Other purposes
  2. **work trips**: Work, Work-related and School purposes
  3. other trips: Home, Change mode
  
- data source:
  1. trip data from 2017 and 2019 household travel survey
  2. 2018 centers employment data
     - UGA employment count: 2018 LODES block-level data
  3. 2020 OFM population data
     - UGA population count: 2020 OFM block-level data
:::


## trips in centers

:::{.panel-tabset}

### RGC

```{r}
#| out-width: 450px
#| out-height: 300px

df_plot <- trip_data_uga_17_19 %>% 
  hhts_count(group_vars=c("trip_type","d_rgcname"),spec_wgt = "trip_weight_2017_2019") %>%
  filter(d_rgcname!= "Total") %>%
  left_join(df_rgc, by="d_rgcname") %>%
  mutate(`trip/acre` = count/acres,
         `trip/activity unit` = count/activity_unit)
df_plot$d_rgcname <- factor(df_plot$d_rgcname, levels=c("RGC","Not RGC"))

plot_ly(data = df_plot %>% filter(d_rgcname != "Total"),
        x = ~trip_type, y = ~share,type = "bar", color = ~d_rgcname, colors = pal_rgc,
        error_y = ~list(array = share_moe,
                        color = '#000000')) %>%
  layout(xaxis = list(title = 'trip type'), yaxis = list(title = 'trip share', tickformat=".1%"), 
         title = "share of weekday trip destinations in RCC/ Not RGC",
         font = list(family="Poppins"))
```

- one-fifth of non-work trips ends in centers
- To highlight the intensity of places, we normalize the number of trips by area and by activity units:
  - trips per acre
    - non-work trip/acre for centers is **50 times** higher than that for non-center
    - work trip/acre for centers is **80 times** higher than that for non-center
  - trips per activity unit
    - activity units: the sum of population and employment counts
    - non-work trip/activity unit for centers is higher than non-center, showing that an activity unit in centers is more likely to generate more trips

```{r}
#| tbl-cap: area and activity units in centers

kbl(
  df_rgc %>% select(d_rgcname,acres,activity_unit) %>%
    mutate(acres = scales::number(acres,accuracy=1000,big.mark = ","),
           activity_unit = scales::number(activity_unit,accuracy=1000,big.mark = ","))
  )%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  row_spec(1, background = psrc_colors$purples_inc[1]) %>%
  row_spec(2, background = psrc_colors$greens_inc[1])
```

```{r}
#| tbl-cap: weekday trip destination

kbl(
  df_plot[,list(d_rgcname,trip_type,share,count,`trip/acre`,`trip/activity unit`)] %>%
    formatting_func()
  )%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  row_spec(c(1,3), background = psrc_colors$purples_inc[1]) %>%
  row_spec(c(2,4), background = psrc_colors$greens_inc[1])
```

### Metro/Urban RGC

```{r}
#| out-width: 550px
#| out-height: 300px

df_plot <- trip_data_uga_17_19 %>% 
  hhts_count(group_vars=c("trip_type","category"),spec_wgt = "trip_weight_2017_2019") %>%
  filter(category!= "Total") %>%
  left_join(df_metro_urban, by="category") %>%
  mutate(`trip/acre` = count/acres,
         `trip/activity unit` = count/activity_unit)
df_plot$category <- factor(df_plot$category, levels=c("Metro","Urban","Not RGC"))

plot_ly(data = df_plot,
        x = ~trip_type, y = ~share,type = "bar", color = ~category, colors = pal_rgc_mu,
        error_y = ~list(array = share_moe,
                        color = '#000000')) %>%
  layout(xaxis = list(title = 'trip type'), yaxis = list(title = 'trip share', tickformat=".1%"), 
         title = "share of weekday trip destinations in Metro/Urban RCC",
         font = list(family="Poppins"))
```

- trips per square mile
  - metro and urban centers have similar share of non-work trips. However, since the area of metro centers is smaller, non-work trip/acre for metro centers is 27% higher than urban centers
- trips per activity unit
  - non-work trip/activity unit in metro centers is the lowest because metro centers have the densest activity unit
  - among centers and non-centers, an activity unit in metro centers generates the least non-work trips, but generates the most work trips

```{r}
#| tbl-cap: area and activity units in centers

kbl(
  df_metro_urban %>% select(category,acres,activity_unit) %>%
    mutate(category=factor(category, levels=c("Metro","Urban","Not RGC")),
           acres = scales::number(acres,accuracy=100,big.mark = ","),
           activity_unit = scales::number(activity_unit,accuracy=1000,big.mark = ",")) %>%
    arrange(category)
  )%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  row_spec(c(1), background = psrc_colors$oranges_inc[1]) %>%
  row_spec(c(2), background = psrc_colors$blues_inc[1]) %>%
  row_spec(c(3), background = psrc_colors$greens_inc[1])
```

```{r}
#| tbl-cap: weekday trip destination
kbl(
  df_plot[,list(category,trip_type,share,count,`trip/acre`,`trip/activity unit`)] %>%
    formatting_func()
  )%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  row_spec(c(1,4), background = psrc_colors$oranges_inc[1]) %>%
  row_spec(c(2,5), background = psrc_colors$blues_inc[1]) %>%
  row_spec(c(3,6), background = psrc_colors$greens_inc[1])
```

### individual centers

```{r}
#| out-width: 600px
#| out-height: 700px


# TODO: add activity unit
df_plot <- trip_data_uga_17_19 %>%
  filter(trip_type=="Work") %>%
  hhts_count(group_vars=c("trip_type","d_rgcname_indv"),spec_wgt = "trip_weight_2017_2019") %>%
  filter(d_rgcname_indv != "Total") %>%
  add_row(
    trip_data_uga_17_19 %>%
      filter(trip_type=="Non-work") %>%
      hhts_count(group_vars=c("trip_type","d_rgcname_indv"),spec_wgt = "trip_weight_2017_2019") %>%
      filter(d_rgcname_indv != "Total")
  ) %>%
  left_join(df_centers, by="d_rgcname_indv") %>%
  mutate(`trip/acre` = count/acres,
         `trip/activity unit` = count/activity_unit)

plot_ly(data = df_plot %>% filter(d_rgcname_indv!="Not RGC"),
        x = ~share, y = ~reorder(d_rgcname_indv,share), name=~trip_type, type = "bar", orientation = 'h',
        error_x = ~list(array = share_moe,
                        color = '#000000')) %>%
  layout(xaxis = list(title = 'trip share', tickformat=".1%"), yaxis = list(title = 'regional growth center'), 
         title = "share of weekday trip destinations in RCC",
         font = list(family="Poppins"))

plot_ly(data = df_plot,
        x = ~`trip/acre`, y = ~reorder(d_rgcname_indv,`trip/acre`), name=~trip_type, type = "bar", orientation = 'h') %>%
  layout(xaxis = list(title = 'trip count/ square mile'), yaxis = list(title = 'regional growth center'), 
         title = "weekday trip destinations per square mile in RCC",
         font = list(family="Poppins"))

plot_ly(data = df_plot,
        x = ~`trip/activity unit`, y = ~reorder(d_rgcname_indv,`trip/activity unit`), name=~trip_type, type = "bar", orientation = 'h') %>%
  layout(xaxis = list(title = 'trip count/ activity unit'), yaxis = list(title = 'regional growth center'), 
         title = "weekday trip destinations per activity unit in RCC",
         font = list(family="Poppins"))
```


```{r}
#| tbl-cap: weekday trip destination

df_plot[,list(d_rgcname_indv,trip_type,share,count,`trip/acre`,`trip/activity unit`)] %>%
  formatting_func()
```

:::

## trips in centers by trip purpose


:::{.panel-tabset}

### RGC

```{r}
#| out-width: 700px
#| out-height: 400px

df_plot <- trip_data_uga_17_19 %>% 
  filter(trip_type=="Non-work") %>%
  hhts_count(group_vars=c("d_rgcname",'dest_purpose_cat'),spec_wgt = "trip_weight_2017_2019") %>% 
  filter(dest_purpose_cat != "Total") %>%
  left_join(df_rgc, by="d_rgcname") %>%
  mutate(`trip/acre` = count/acres,
         `trip/activity unit` = count/activity_unit)
df_plot$d_rgcname <- factor(df_plot$d_rgcname, levels=c("Not RGC","RGC"))

```

- the centers serve significantly more non-work trips, especially meal trips, which are about 100 times higher in trip/acre
- from trip/activity unit, activity units in centers didn't generate much higher escort and social/recreation trips

```{r}
#| tbl-cap: weekday non-work trip per square mile by purpose
df_tab1 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = d_rgcname, values_from = `trip/acre`) %>%
  mutate(RGC = scales::number(RGC,accuracy=0.01,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=0.01,big.mark = ","))
df_tab2 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = d_rgcname, values_from = count) %>%
  mutate(RGC = scales::number(RGC,accuracy=1000,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=1000,big.mark = ","))

kbl(df_tab2 %>% add_column(df_tab1[,c(2,3)],.name_repair = "minimal"))%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  add_header_above(c(" " = 1, "trip count" = 2, "trip/acre" = 2)) %>%
  column_spec(4, background = psrc_colors$purples_inc[1]) %>%
  column_spec(5, background = psrc_colors$greens_inc[1])
```


```{r}
#| tbl-cap: weekday non-work trip per activity unit by purpose
df_tab1 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = d_rgcname, values_from = `trip/activity unit`) %>%
  mutate(RGC = scales::number(RGC,accuracy=0.01,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=0.01,big.mark = ","))
df_tab2 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = d_rgcname, values_from = count) %>%
  mutate(RGC = scales::number(RGC,accuracy=1000,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=1000,big.mark = ","))

kbl(df_tab2 %>% add_column(df_tab1[,c(2,3)],.name_repair = "minimal"))%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  add_header_above(c(" " = 1, "trip count" = 2, "trip/activity unit" = 2)) %>%
  column_spec(4, background = psrc_colors$purples_inc[1]) %>%
  column_spec(5, background = psrc_colors$greens_inc[1])
```



### Metro/Urban RGC

```{r}
#| out-width: 700px
#| out-height: 400px

df_plot <- trip_data_uga_17_19 %>% 
  filter(trip_type=="Non-work") %>%
  hhts_count(group_vars=c("category",'dest_purpose_cat'),spec_wgt = "trip_weight_2017_2019") %>% 
  filter(dest_purpose_cat != "Total") %>%
  left_join(df_metro_urban, by="category") %>%
  mutate(`trip/acre` = count/acres,
         `trip/activity unit` = count/activity_unit)
df_plot$category <- factor(df_plot$category, levels=c("Not RGC","Metro", "Urban"))
```

- Metro centers serve the most trips for each non-work purpose, except for shopping purpose. Urban centers serves the most shopping trips
- Metro centers have the lowest trip/activity unit for each non-work purpose, except for meal purpose because of its dense activity units

```{r}
#| tbl-cap: weekday non-work trip per square mile by purpose
df_tab1 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = category, values_from = `trip/acre`) %>%
  mutate(Metro = scales::number(Metro,accuracy=0.01,big.mark = ","),
         Urban = scales::number(Urban,accuracy=0.01,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=0.01,big.mark = ","))
df_tab2 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = category, values_from = count) %>%
  mutate(Metro = scales::number(Metro,accuracy=1000,big.mark = ","),
         Urban = scales::number(Urban,accuracy=1000,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=1000,big.mark = ","))


kbl(df_tab2 %>% add_column(df_tab1[,c(2,3,4)],.name_repair = "minimal"))%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  add_header_above(c(" " = 1, "trip count" = 3, "trip/acre" = 3)) %>%
  column_spec(5, background = psrc_colors$oranges_inc[1]) %>%
  column_spec(6, background = psrc_colors$blues_inc[1]) %>%
  column_spec(7, background = psrc_colors$greens_inc[1])
```

```{r}
#| tbl-cap: weekday non-work trip per activity unit by purpose
df_tab1 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = category, values_from = `trip/activity unit`) %>%
  mutate(Metro = scales::number(Metro,accuracy=0.01,big.mark = ","),
         Urban = scales::number(Urban,accuracy=0.01,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=0.01,big.mark = ","))
df_tab2 <- df_plot %>%
  pivot_wider(id_cols = c(dest_purpose_cat), names_from = category, values_from = count) %>%
  mutate(Metro = scales::number(Metro,accuracy=1000,big.mark = ","),
         Urban = scales::number(Urban,accuracy=1000,big.mark = ","),
         `Not RGC` = scales::number(`Not RGC`,accuracy=1000,big.mark = ","))


kbl(df_tab2 %>% add_column(df_tab1[,c(2,3,4)],.name_repair = "minimal"))%>%
  kable_styling(bootstrap_options = c("striped", "hover"), html_font = "Poppins") %>%
  add_header_above(c(" " = 1, "trip count" = 3, "trip/activity unit" = 3)) %>%
  column_spec(5, background = psrc_colors$oranges_inc[1]) %>%
  column_spec(6, background = psrc_colors$blues_inc[1]) %>%
  column_spec(7, background = psrc_colors$greens_inc[1])
```

:::



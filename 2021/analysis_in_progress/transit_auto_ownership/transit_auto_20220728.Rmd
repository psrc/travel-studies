---
title: "HHTS: transit ridership (2017, 2019, 2021) Analysis"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 6
    toc_float: true
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

```{r library setup, include=FALSE}
devtools::install_github("psrc/psrc.travelsurvey",
                         force=TRUE)
devtools::install_github("psrc/psrcplot")
devtools::install_github("psrc/psrctrends")

library(tidyverse)
# library(psrccensus)
library(psrc.travelsurvey)
library(psrcplot)
library(psrctrends)
# library(rlang) #required for psrccensus
# library(emmeans) #required for rlang
library(magrittr)
library(knitr)
library(kableExtra)
library(ggplot2)

# library(survey)
library(summarytools) #freq
library(table1)  #nice descriptive summary table
library(scales) #number formatting
library(ggpubr) #graphing - ggarrange fx
library(forcats) #for factor re-leveling
library(plotly) #for interactive charts

library(odbc) #connect to ElmerGeo
library(DBI) #connect to ElmerGeo
library(sf)
library(leaflet)
library(leafem) #home button
library(raster)
library(ggspatial)
library(lubridate)
library(stringr) #add leading zero's
```

```{r surveys 2017-2019}
# global variables
survey_a <- list(survey = '2017', label = '2017')
survey_b <- list(survey = '2019', label = '2019')
survey_ab <- list(survey = '2017_2019', label = '2017/2019')
survey_c <- list(survey = '2021', label = '2021')
```

```{r data functions}
# rounding function applied to categorical columns 
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%.0f%%)", FREQ, PCT))))}

# accessing data
# 
# refining variables 
smp_commute_fx <- function(data, year) {
  temp_table <- data %>%
    filter(race_eth_broad!="Child -- no race specified") %>%
    drop_na(commute_mode) %>%
    # drop_na(final_cnty) %>%
    # filter(final_cnty!="Total") %>%
    mutate(commute_mode = factor(case_when(commute_mode=="Bus (public transit)" |
                                             commute_mode=="Commuter rail (Sounder, Amtrak)" |
                                             commute_mode=="Ferry or water taxi" |
                                             commute_mode=="Paratransit" |
                                             commute_mode=="Streetcar" |
                                             commute_mode=="Urban rail (Link light rail, monorail)" |
                                             commute_mode=="Urban rail (Link light rail, monorail, streetcar)" ~ "2-Public Transit",
                                           commute_mode=="Bicycle or e-bike" |
                                             commute_mode=="Motorcycle/moped" |
                                             commute_mode=="Motorcycle/moped/scooter" |
                                             commute_mode=="Scooter or e-scooter (e.g., Lime, Bird, Razor)" |
                                             commute_mode=="Walk, jog, or wheelchair" ~ "1-Active transit/micro mobility",
                                           commute_mode=="Drive alone" ~ "3-Drive alone",
                                           commute_mode=="Carpool ONLY with other household members" |
                                             commute_mode=="Carpool with other people not in household (may also include household members)" |
                                             commute_mode=="Other hired service (Uber, Lyft, or other smartphone-app car service)" |
                                             commute_mode=="Taxi (e.g., Yellow Cab)" |
                                             commute_mode=="Vanpool" ~ "4-HOV modes",
                                           TRUE ~ "5-Other modes")))
  ## vehicles per number of adults/per number of workers
  temp_table2 <- temp_table %>% 
    # filter(vehicle_count!="0 (no vehicles)") %>%
    mutate(veh_num=as.numeric(substr(vehicle_count, 1, 1))) %>%
    mutate(hhsize_num=as.numeric(substr(hhsize, 1, 1))) %>%
    # mutate(hhsz_veh=hhsize_num/veh_num) %>%
    # mutate(hhadults_veh=numadults/veh_num) %>%
    # mutate(numwork_veh=numworkers/veh_num) %>%
    mutate(hhsz_veh=ifelse(veh_num>0,hhsize_num/veh_num,0)) %>%
    mutate(hhadults_veh=ifelse(veh_num>0,numadults/veh_num,0)) %>%
    mutate(numwork_veh=ifelse(veh_num>0,numworkers/veh_num,0)) %>% 
    mutate(hhsz_veh_grp=case_when(hhsz_veh==0~"0-No household vehicles",
                                  hhsz_veh<1~"3-More vehicles than people",
                                  hhsz_veh==1~"2-One vehicle per person",
                                  hhsz_veh>1~"1-Fewer vehicles than people",
                                  TRUE ~ as.character(hhsz_veh))) %>% 
    mutate(hhadults_veh_grp=case_when(hhadults_veh==0~"0-No household vehicles",
                                      hhadults_veh<1~"3-More vehicles than adults",
                                      hhadults_veh==1~"2-One vehicle per adults",
                                      hhadults_veh>1~"1-Fewer vehicles than adults",
                                      TRUE ~ as.character(hhadults_veh))) %>% 
    mutate(numwork_veh_grp=case_when(numwork_veh==0~"0-No household vehicles",
                                     numwork_veh<1~"3-More vehicles than workers",
                                     numwork_veh==1~"2-One vehicle per worker",
                                     numwork_veh>1~"1-Fewer vehicles than worker",
                                     TRUE ~ as.character(numwork_veh))) %>% 
    mutate(veh_num_smp=case_when(veh_num==0~"0-No vehicle available",
                                 veh_num==1~"1-1 vehicle available",
                                 veh_num==2~"2-2 vehicles available",
                                 veh_num>=3~"3-3+ vehicles available"))
  
  temp_table3 <- temp_table2 %>% 
    mutate(hhincome_broad = factor(case_when(hhincome_broad=="Under $25,000"~"1-Under $25,000",
                                             hhincome_broad=="$25,000-$49,999"~"2-$25,000-$49,999",
                                             hhincome_broad=="$50,000-$74,999"~"3-$50,000-$74,999",
                                             hhincome_broad=="$75,000-$99,999"~"4-$75,000-$99,999",
                                             hhincome_broad=="$100,000 or more"|
                                               hhincome_broad=="$100,000-$199,000" |
                                               hhincome_broad=="$200,000 or more"~"5-$100,000 or more",
                                             hhincome_broad=="Prefer not to answer"~"6-Prefer not to answer"))) %>% 
    # mutate(education = factor(case_when(education=="Less than high school"~"1-Less than high school",
    #                                     education=="High school graduate"~"2-High school graduate",
    #                                     education=="Vocational/technical training"~"3-Vocational/technical training",
    #                                     education=="Some college"~"4-Some college",
    #                                     education=="Associates degree"~"5-Associates degree",
    #                                     education=="Bachelor degree"~"6-Bachelor degree",
    #                                     education=="Graduate/post-graduate degree"~"7-Graduate/post-graduate degree"))) %>% 
    mutate(education = factor(case_when(education=="Less than high school"|
                                          education=="High school graduate"~"1-High school or less",
                                        education=="Vocational/technical training" |
                                          education=="Some college" |
                                          education=="Associates degree"~"2-Technical or Associates",
                                        education=="Bachelor degree" |
                                          education=="Graduate/post-graduate degree"~"3-Bachelor's or higher"))) %>% 
    mutate(hhsize_simp = factor(case_when(hhsize>5~"5 or more people",
                                          TRUE ~ as.character(hhsize))))
  
  # assign(paste0('smp_commute_', year), temp_table3)
}
```

```{r visualization functions}
# visuals ----
# hhts_count and prep for graphing
count_prep_fx <- function(data, grp1, grp2) {
  
  hhts_count(data,
             group_vars = c(grp1, grp2)) %>%
    mutate(period = data$label) %>%
    filter(!!sym(grp2)!="Total") %>% 
    filter(!!sym(grp1)!="NA")
}

# proportion graphs
share_plot <- function(dt, grp_var, num_var, legend_name, tbl_name){
  
  fill_group <- dt[[grp_var]]
  x_axis_grp <- dt[[num_var]]
  
  share_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=share,
                           fill=fill_group)) +
  geom_bar(stat="identity",
           position="dodge2") +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        axis.title.x = element_blank()) +
  labs(y = "Share",
       fill = legend_name) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                size=.5, width=.2,
                position=position_dodge(0.9))
  
  annotate_figure(share_plot, top = text_grob(tbl_name, 
               color = "blue", face = "bold", size = 14))
}

# side-by-side count and proportion graphs
count_and_share_plot <- function(dt, grp_var, num_var, legend_name, tbl_name){
  
  fill_group <- dt[[grp_var]]
  x_axis_grp <- dt[[num_var]]
  
  count_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=count,
                           fill=fill_group)) +
  geom_bar(stat="identity",
           position="dodge2") +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        axis.title.x = element_blank()) +
  labs(y = "Number",
       fill = legend_name) +
  scale_y_continuous(labels = scales::comma) +
  geom_errorbar(aes(ymin=count-count_moe, ymax=count+count_moe),
                size=.5,width=.2,
                position=position_dodge(.9))
  
  
  share_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=share,
                           fill=fill_group)) +
  geom_bar(stat="identity",
           position="dodge2") +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        axis.title.x = element_blank()) +
  labs(y = "Share",
       fill = legend_name) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                size=.5, width=.2,
                position=position_dodge(0.9))
  
  autos <- ggarrange(count_plot, share_plot, 
                     # ncol = 2, nrow = 1,
                     common.legend = TRUE,
                     legend = "right")
  annotate_figure(autos, top = text_grob(tbl_name, 
               color = "blue", face = "bold", size = 14))
}

# share plot variations
share_plot_by_year <- function(dt1, dt2, dt3, dt4, grp_var, grp_var2, legend_name){
  
  tbl1 <- count_prep_fx(dt1, grp_var, grp_var2)
  tbl2 <- count_prep_fx(dt2, grp_var, grp_var2)
  tbl3 <- count_prep_fx(dt3, grp_var, grp_var2)
  tbl4 <- count_prep_fx(dt4, grp_var, grp_var2)
  
  all_commute_17_21 <- bind_rows(tbl1,
                                 tbl2,
                                 tbl3,
                                 tbl4) %>%
    mutate(period = as.factor(survey))
  
  fill_group <- all_commute_17_21[[grp_var]]
  x_axis_grp <- all_commute_17_21[[grp_var2]]

  ggplot(all_commute_17_21, aes(x=x_axis_grp,
                                y=share,
                                fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~period)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_year2 <- function(dt1, dt2, grp_var, grp_var2, legend_name){
  
  tbl1 <- count_prep_fx(dt1, grp_var, grp_var2)
  tbl2 <- count_prep_fx(dt2, grp_var, grp_var2)
  
  all_commute_17_21 <- bind_rows(tbl1,
                                 tbl2) %>%
    mutate(period = as.factor(survey))
  
  fill_group <- all_commute_17_21[[grp_var]]
  x_axis_grp <- all_commute_17_21[[grp_var2]]

  ggplot(all_commute_17_21, aes(x=x_axis_grp,
                              y=share,
                              fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~period)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_year2_active <- function(dt1, dt2, grp_var, grp_var2, legend_name){
  
  tbl1 <- count_prep_fx(dt1, grp_var, grp_var2)
  tbl2 <- count_prep_fx(dt2, grp_var, grp_var2)
  
  all_commute_17_21 <- bind_rows(tbl1,
                                 tbl2) %>%
    mutate(period = as.factor(survey)) %>% 
    filter(commute_mode=="1-Active transit/micro mobility" |
           commute_mode=="2-Public Transit")
  
  fill_group <- all_commute_17_21[[grp_var]]
  x_axis_grp <- all_commute_17_21[[grp_var2]]

  ggplot(all_commute_17_21, aes(x=x_axis_grp,
                              y=share,
                              fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~period)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_cat <- function(dt1, dt2, dt3, dt4, grp_var, grp_var2, legend_name){
  
  tbl1 <- count_prep_fx(dt1, grp_var, grp_var2)
  tbl2 <- count_prep_fx(dt2, grp_var, grp_var2)
  tbl3 <- count_prep_fx(dt3, grp_var, grp_var2)
  tbl4 <- count_prep_fx(dt4, grp_var, grp_var2)
  
  all_commute_17_21 <- bind_rows(tbl1,
                                 tbl2,
                                 tbl3,
                                 tbl4) %>%
    mutate(period = as.factor(survey))
  
  fill_group <- all_commute_17_21[[grp_var]]
  # facet_group <- all_commute_17_21[[grp_var2]]

  ggplot(all_commute_17_21, aes(x=period,
                                y=share,
                                fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~all_commute_17_21[[grp_var2]])+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
}

share_plot_by_cat2 <- function(dt1, dt2, grp_var, grp_var2, legend_name){
  
  tbl1 <- count_prep_fx(dt1, grp_var, grp_var2)
  tbl2 <- count_prep_fx(dt2, grp_var, grp_var2)
  
  all_commute_17_21 <- bind_rows(tbl1,
                                 tbl2) %>%
    mutate(period = as.factor(survey))
  
  fill_group <- all_commute_17_21[[grp_var]]
  # facet_group <- all_commute_17_21[[grp_var2]]

  ggplot(all_commute_17_21, aes(x=period,
                                y=share,
                                fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~all_commute_17_21[[grp_var2]])+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
}

share_plot_by_cat2_active <- function(dt1, dt2, grp_var, grp_var2, legend_name){
  
  tbl1 <- count_prep_fx(dt1, grp_var, grp_var2)
  tbl2 <- count_prep_fx(dt2, grp_var, grp_var2)
  
  all_commute_17_21 <- bind_rows(tbl1,
                                 tbl2) %>%
    mutate(period = as.factor(survey)) %>% 
    filter(commute_mode=="1-Active transit/micro mobility" |
           commute_mode=="2-Public Transit")
  
  fill_group <- all_commute_17_21[[grp_var]]
  # facet_group <- all_commute_17_21[[grp_var2]]

  plot <- ggplot(all_commute_17_21, aes(x=period,
                                y=share,
                                fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~all_commute_17_21[[grp_var2]])+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
  ggplotly(plot)
}
```

# Introduction
The work presented in this document contains analysis of commute mode, with a focus on transit ridership, in relation to auto ownership and geography. The analysis includes 2021 data and utilizes PSRC's R package, [psrc.travelsurvey](https://psrc.github.io/psrc.travelsurvey/index.html).

* **Has commuting by transit changed with COVID-19?** (2017 and 2019 vs. 2021)
  + Who uses transit? Have there been shifts over time?
* **How does vehicle ownership influence transit commuting use over time?**

```{r variables, include=FALSE}
all_vars_p <- c("commute_mode",
                "workplace",
                "race_category",
                "race_eth_broad",
                "race_eth_poc", #POC/non-POC
                "race_eth_apoc", #Asian POC/non-Asian POC/White
                "license",
                "hhsize",
                "numadults",
                "numworkers",
                "vehicle_count",
                "hhincome_broad",
                "hhincome_detailed",
                "lifecycle",
                "final_home_rgcnum",
                "final_home_is_rgc",
                "final_cnty", #2017-2019 data
                # "final_home_tract", #2021 data
                "education",
                "gender")
```

```{r getting survey data}
psurvey_17 <- get_hhts(survey = survey_a$survey,
                       level="p",
                       vars=all_vars_p)

psurvey_19 <- get_hhts(survey = survey_b$survey,
                       level="p",
                       vars=all_vars_p)

psurvey_1719 <- get_hhts(survey = survey_ab$survey,
                       level="p",
                       vars=all_vars_p)
  
psurvey_21 <- get_hhts(survey = survey_c$survey,
                       level="p",
                       vars=all_vars_p)

# table(psurvey_21$final_cnty)
# test <- get_hhts(survey = "2019", level="p",
#                  vars=c("final_cnty", "vehicle_count"))
```

*Filtering out children and those who do not commute* 
```{r, generate datasets}
# access data ----
commute_17 <- smp_commute_fx(psurvey_17, '2017')
commute_19 <-smp_commute_fx(psurvey_19, '2019')
commute_1719 <-smp_commute_fx(psurvey_1719, '2017/2019')
commute_21 <-smp_commute_fx(psurvey_21, '2021')
```


# General Commuting
Using 'commute_mode' defined as: 'Usual way of commuting to current location/office'
\
    *survey logic*: if workplace = fixed/varied/telework some days

Workplace options: 

* **Only one work location outside of home**
* Work at home ONLY (telework, self-employed)
* **Telework some days and travel to a work location some days**
* **Work location regularly varies (different offices/jobsites)**
* Drive/travel for work (driver, sales)
\
\

```{r}
# merge dfs (original)----
all_commute_17_21 <- bind_rows(psurvey_17,
                               psurvey_19,
                               psurvey_1719,
                               psurvey_21) %>%
  mutate(period = as.factor(survey))


table(all_commute_17_21$commute_mode, all_commute_17_21$survey)
# freq(all_commute_17_21$period)
# freq(all_commute_17_21$commute_mode)
# freq(psurvey_17$workplace)
# table(psurvey_17$final_home_is_rgc, psurvey_17$final_home_rgcnum)
# freq(psurvey_17$final_home_is_rgc)
# freq(psurvey_17$final_home_rgcnum)
```
\
\

When the commute modes are simplified:
```{r}
# merge dfs (simplified)----
all_commute_17_21_simp <- bind_rows(commute_17,
                                    commute_19,
                                    commute_1719,
                                    commute_21) %>%
  mutate(period = as.factor(survey))


table(all_commute_17_21_simp$commute_mode, all_commute_17_21_simp$period)
```
<span style="color:#00716c">HOV-modes are categorized based on the number of individuals in the vehicle: 

* "Carpool ONLY with other household members" 
* "Carpool with other people not in household (may also include household members)"
* "Other hired service (Uber, Lyft, or other smartphone-app car service)" 
* "Taxi (e.g., Yellow Cab)" 
* "Vanpool"
</span> 
\
\
```{r, CSV output4 all workers, include=FALSE, eval=FALSE}
# generate data
commute_allworkers_1719 <- hhts_count(commute_1719,
                                      group_vars = "commute_mode") %>%
  filter(commute_mode!="Total")

commute_allworkers_21 <- hhts_count(commute_21,
                                    group_vars = "commute_mode") %>%
  filter(commute_mode!="Total")

commute_allworkers <- bind_rows(commute_allworkers_1719,
                                commute_allworkers_21)

# create CSV
write.csv(commute_allworkers,
          "T:/2022August/Mary/HHTS/output_data/commute_allworkers.csv", 
          row.names = FALSE)

# test dataset
ggplot(commute_allworkers, aes(x=commute_mode,
                              y=share)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(commute_allworkers$survey)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = "Survey") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))

```

## Race/ethnicity
### Race - all categories
```{r}
share_plot_by_year(commute_17, commute_19, commute_1719, commute_21, 
                   'race_eth_broad', 'commute_mode',
                   'Race Categories')

share_plot_by_cat(commute_17, commute_19, commute_1719, commute_21, 
                   'race_eth_broad', 'commute_mode',
                   'Mode Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719, commute_21,
                           'race_eth_broad', 'commute_mode',
                           'Race Categories')

share_plot_by_cat2_active(commute_1719, commute_21,
                          'race_eth_broad', 'commute_mode',
                          'Race Categories')
```
\
\

### Race - POC/Non-POC
```{r}
share_plot_by_year(commute_17, commute_19, commute_1719, commute_21, 
                   'race_eth_poc', 'commute_mode',
                   'Race Categories')

share_plot_by_cat(commute_17, commute_19, commute_1719, commute_21, 
                   'race_eth_poc', 'commute_mode',
                   'Race Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719, commute_21,
                           'race_eth_poc', 'commute_mode',
                           'Race Categories')

share_plot_by_cat2_active(commute_1719, commute_21,
                          'race_eth_poc', 'commute_mode',
                          'Race Categories')
```
\
\

### Race - Asian POC/Non-Asian POC/White
```{r}
share_plot_by_year2(#commute_17,
                   #commute_19, 
                   commute_1719, 
                   commute_21, 
                   'race_eth_apoc', 'commute_mode',
                   'Race Categories')

share_plot_by_cat2(#commute_17, 
                  #commute_19, 
                  commute_1719, 
                  commute_21, 
                   'race_eth_apoc', 'commute_mode',
                   'Race Categories')
```

```{r, CSV output1, include=FALSE, eval=FALSE}
# generate data
race3_commute_1719 <- count_prep_fx(commute_1719, 'race_eth_apoc', 'commute_mode')
race3_commute_21 <- count_prep_fx(commute_21, 'race_eth_apoc', 'commute_mode')

race3_commute_all <- bind_rows(race3_commute_1719,
                               race3_commute_21)

# create CSV
write.csv(race3_commute_all,
          "T:/2022July/Mary/HHTS/output_data/race3_commute_all.csv", 
          row.names = FALSE)

# test dataset
# ggplot(race3_commute_all, aes(x=commute_mode,
#                               y=share,
#                               fill=race_eth_apoc)) +
#     geom_bar(stat="identity",
#              position="dodge2") +
#     facet_wrap(race3_commute_all$survey)+
#     theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#           axis.title.x = element_blank()) +
#     labs(y = "Share",
#          fill = "Survey") +
#     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#     geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
#                   size=.5, width=.2,
#                   position=position_dodge(0.9))

```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719, 
                           commute_21,
                           'race_eth_apoc', 'commute_mode',
                           'Race Categories')

share_plot_by_cat2_active(commute_1719,
                          commute_21,
                          'race_eth_apoc', 'commute_mode',
                          'Race Categories')
```
\
\

## Income
```{r}
share_plot_by_year(commute_17, commute_19, commute_1719, commute_21, 
                   'hhincome_broad', 'commute_mode',
                   'Income Categories')

share_plot_by_cat(commute_17, commute_19, commute_1719, commute_21, 
                   'hhincome_broad', 'commute_mode',
                   'Income Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719, commute_21,
                           'hhincome_broad', 'commute_mode',
                           'Income Categories')

share_plot_by_cat2_active(commute_1719, commute_21,
                          'hhincome_broad', 'commute_mode',
                          'Income Categories')
```
\
\

## Education
```{r}
share_plot_by_year(commute_17, commute_19, commute_1719, commute_21, 
                   'commute_mode','education',
                   'Commute Categories')

share_plot_by_cat(commute_17, commute_19, commute_1719, commute_21, 
                   'education', 'commute_mode',
                   'Education Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719, commute_21,
                           'education', 'commute_mode',
                           'Education Categories')

share_plot_by_cat2_active(commute_1719, commute_21,
                          'education', 'commute_mode',
                          'Education Categories')
```
\
\

## Regional Growth Center
This analysis is based on the *final_home_is_rgc* variable.
```{r}
share_plot_by_year2(#commute_17, 
                   #commute_19, 
                   commute_1719, 
                   commute_21, 
                   'final_home_is_rgc','commute_mode',
                   'Home Location')

share_plot_by_cat2(#commute_17, 
                   #commute_19, 
                   commute_1719, 
                   commute_21, 
                   'final_home_is_rgc', 'commute_mode',
                   'Home Location')
```

```{r, CSV output2, include=FALSE, eval=FALSE}
# generate data
rgc_commute_1719 <- count_prep_fx(commute_1719, 'final_home_is_rgc', 'commute_mode')
rgc_commute_21 <- count_prep_fx(commute_21, 'final_home_is_rgc', 'commute_mode')

rgc_commute_all <- bind_rows(rgc_commute_1719,
                             rgc_commute_21)

# create CSV
write.csv(rgc_commute_all,
          "T:/2022July/Mary/HHTS/output_data/rgc_commute_all.csv", 
          row.names = FALSE)

# test dataset
# ggplot(rgc_commute_all, aes(x=commute_mode,
#                             y=share,
#                             fill=final_home_is_rgc)) +
#     geom_bar(stat="identity",
#              position="dodge2") +
#     facet_wrap(rgc_commute_all$survey)+
#     theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#           axis.title.x = element_blank()) +
#     labs(y = "Share",
#          fill = "Survey") +
#     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#     geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
#                   size=.5, width=.2,
#                   position=position_dodge(0.9))

```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719,
                           commute_21,
                           'final_home_is_rgc', 'commute_mode',
                           'RGC Status')

share_plot_by_cat2_active(commute_1719,
                          commute_21,
                          'final_home_is_rgc', 'commute_mode',
                          'RGC Status')
```
\
\

## Gender
```{r}
share_plot_by_year2(commute_1719, commute_21, 
                   'gender', 'commute_mode',
                   'Gender Categories')

share_plot_by_cat2(commute_1719, commute_21, 
                   'gender', 'commute_mode',
                   'Gender Categories')
```
```{r, CSV output5, include=FALSE, eval=FALSE}
# generate data
gender_commute_1719 <- count_prep_fx(commute_1719, 'gender', 'commute_mode')
gender_commute_21 <- count_prep_fx(commute_21, 'gender', 'commute_mode')

gender_commute_all <- bind_rows(gender_commute_1719,
                                gender_commute_21)
# create CSV
write.csv(gender_commute_all,
          "T:/2022August/Mary/HHTS/output_data/gender_commute_all.csv", 
          row.names = FALSE)

# test dataset
# ggplot(gender_commute_all, aes(x=commute_mode,
#                             y=share,
#                             fill=gender)) +
#     geom_bar(stat="identity",
#              position="dodge2") +
#     facet_wrap(gender_commute_all$survey)+
#     theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#           axis.title.x = element_blank()) +
#     labs(y = "Share",
#          fill = "Survey") +
#     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#     geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
#                   size=.5, width=.2,
#                   position=position_dodge(0.9))

```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(commute_1719, commute_21,
                           'gender', 'commute_mode',
                           'Gender Categories')

share_plot_by_cat2_active(commute_1719, commute_21,
                          'gender', 'commute_mode',
                          'Gender Categories')
```
\
\

# No-vehicle households
The following research will be focused on those who reported commuting to work and who don't own any hosehold vehicles.
```{r, include=FALSE, eval=FALSE}
table(all_commute_17_21_simp$survey, all_commute_17_21_simp$vehicle_count)
table(all_commute_17_21_simp$vehicle_count, all_commute_17_21_simp$hhsize)
table(all_commute_17_21_simp$survey, all_commute_17_21_simp$numwork_veh_grp)
```

survey logic: vehicle_count=="0 (no vehicles)"
```{r}
noveh_2017 <- commute_17 %>% 
  filter(vehicle_count=="0 (no vehicles)")
noveh_2019 <- commute_19 %>% 
  filter(vehicle_count=="0 (no vehicles)")
noveh_201719 <- commute_1719 %>% 
  filter(vehicle_count=="0 (no vehicles)")
noveh_2021 <- commute_21 %>% 
  filter(vehicle_count=="0 (no vehicles)")
```
\

```{r}
# xtabs(~race_eth_broad+hhincome_broad+survey, data=all_commute_17_21_simp)
# xtabs(~race_eth_broad+hhincome_broad+survey, data=commute_21)

share_plot_by_year2(commute_1719, commute_21,
                    'race_eth_broad', 'hhincome_broad',
                    'Race Categories')

share_plot_by_cat2(commute_1719, commute_21,
                   'race_eth_broad', 'hhincome_broad',
                   'Race Categories')
```
\

## Race/ethnicity
### Race - all categories
```{r}
share_plot_by_year(noveh_2017, noveh_2019, 
                   noveh_201719, noveh_2021, 
                   'race_eth_broad', 'commute_mode',
                   'Race Categories')

share_plot_by_cat(noveh_2017, noveh_2019,
                  noveh_201719, noveh_2021,
                  'race_eth_broad', 'commute_mode',
                  'Race Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(noveh_201719, noveh_2021,
                           'race_eth_broad', 'commute_mode',
                           'Race Categories')

share_plot_by_cat2_active(noveh_201719, noveh_2021,
                          'race_eth_broad', 'commute_mode',
                          'Race Categories')
```
\
\

### Race - POC/Non-POC
```{r}
share_plot_by_year(noveh_2017, noveh_2019, 
                   noveh_201719, noveh_2021, 
                   'race_eth_poc', 'commute_mode',
                   'Race Categories')

share_plot_by_cat(noveh_2017, noveh_2019,
                  noveh_201719, noveh_2021,
                  'race_eth_poc', 'commute_mode',
                  'Race Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(noveh_201719, noveh_2021,
                           'race_eth_poc', 'commute_mode',
                           'Race Categories')

share_plot_by_cat2_active(noveh_201719, noveh_2021,
                          'race_eth_poc', 'commute_mode',
                          'Race Categories')
```
\
\

### Race - Asian POC/Non-Asian POC/White
```{r}
share_plot_by_year(noveh_2017, noveh_2019,
                   noveh_201719, noveh_2021, 
                   'race_eth_apoc', 'commute_mode',
                   'Race Categories')

share_plot_by_cat(noveh_2017, noveh_2019,
                  noveh_201719, noveh_2021,
                  'race_eth_apoc', 'commute_mode',
                  'Race Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(noveh_201719, noveh_2021,
                           'race_eth_apoc', 'commute_mode',
                           'Race Categories')

share_plot_by_cat2_active(noveh_201719, noveh_2021,
                          'race_eth_apoc', 'commute_mode',
                          'Race Categories')
```
\
\

## Income
```{r}
share_plot_by_year(noveh_2017, noveh_2019,
                   noveh_201719, noveh_2021, 
                   'hhincome_broad', 'commute_mode',
                   'Income Categories')

share_plot_by_cat(noveh_2017, noveh_2019,
                  noveh_201719, noveh_2021,
                  'hhincome_broad', 'commute_mode',
                  'Income Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(noveh_201719, noveh_2021,
                           'hhincome_broad', 'commute_mode',
                           'Income Categories')

share_plot_by_cat2_active(noveh_201719, noveh_2021,
                          'hhincome_broad', 'commute_mode',
                          'Income Categories')
```
\
\

## Education
```{r}
share_plot_by_year(noveh_2017, noveh_2019,
                   noveh_201719, noveh_2021,
                   'commute_mode','education',
                   'Commute Categories')

share_plot_by_cat(noveh_2017, noveh_2019,
                  noveh_201719, noveh_2021,
                  'education', 'commute_mode',
                  'Education Categories')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(noveh_201719, noveh_2021,
                           'education', 'commute_mode',
                           'Education Categories')

share_plot_by_cat2_active(noveh_201719, noveh_2021,
                          'education', 'commute_mode',
                          'Education Categories')
```
\
\

## Regional Growth Center
```{r}
share_plot_by_year(noveh_2017, noveh_2019,
                   noveh_201719, noveh_2021, 
                   'final_home_is_rgc','commute_mode',
                   'Home Location')

share_plot_by_cat(noveh_2017, noveh_2019,
                  noveh_201719, noveh_2021,
                  'final_home_is_rgc', 'commute_mode',
                  'Home Location')
```
\
\

#### Focusing on Active/Public Transit
To look at numbers more closely
```{r}
share_plot_by_year2_active(noveh_201719, noveh_2021,
                           'final_home_is_rgc', 'commute_mode',
                           'Home Location')

share_plot_by_cat2_active(noveh_201719, noveh_2021,
                          'final_home_is_rgc', 'commute_mode',
                          'Home Location')
```
\
\

# Vehicle Ownership
There are different ways to quantify vehicle ownership

1. **hhsize/vehicle_count**: Household size
2. **numadults/vehicle_count**: Number of adults (18+)
3. **numworkers/vehicle_count**: Number of workers (number of household members with 1+ jobs)
\

Because we're interested in commute modes, we will be focusing on the number of workers within a household.

## Number of vehicles per worker
The variables used to calculate this variable are: 

1. Number of household vehicles
```{r}
table(all_commute_17_21_simp$vehicle_count, all_commute_17_21_simp$period)
```

2. Number of workers
```{r}
table(all_commute_17_21_simp$numworkers, all_commute_17_21_simp$period)
```
\

```{r}
# table(all_commute_17_21_simp$numwork_veh_grp, all_commute_17_21_simp$period)

share_plot_by_cat2(commute_1719, commute_21,
                   'survey', 'numwork_veh_grp',
                   'Survey Years')
```

### Race - all categories
```{r}
share_plot_by_year2(commute_1719, commute_21,
                    'race_eth_broad', 'numwork_veh_grp',
                    'Race Categories')
share_plot_by_cat2(commute_1719, commute_21,
                   'race_eth_broad', 'numwork_veh_grp',
                   'Race Categories')
```
\
For households with more vehicles than workers, the difference between Black or African American and all other racial groups  is larger in 2017/19 (especially compared to White only). In 2021, the MOEs overlap more with Black or African American, except for the White only individuals. In 2021 White only households decreased in this category and increased in the one vehicle per worker households. 
\
\

### Race - POC/Non-POC
```{r}
# share_plot_by_year(commute_17, commute_19, 
#                    commute_1719, commute_21, 
#                    'race_eth_poc', 'numwork_veh_grp',
#                    'Race Categories')
# share_plot_by_cat(commute_17, commute_19,
#                   commute_1719, commute_21,
#                   'race_eth_poc', 'numwork_veh_grp',
#                   'Race Categories')

share_plot_by_year2(commute_1719, commute_21,
                    'race_eth_poc', 'numwork_veh_grp',
                    'Race Categories')
share_plot_by_cat2(commute_1719, commute_21,
                   'race_eth_poc', 'numwork_veh_grp',
                   'Race Categories')
```
\
Non-POC households reported more vehicles than workers in 2017/19 compared to POC, but in 2021, the difference is smaller with overlapping MOEs. It's difficult to determine any other differences over time because of MOEs. The trends and differences between groups seem relatively consistent over time. The trend for one-vehicle per worker households appears to shift between time periods, but the MOEs make it difficult to determine. 
\
\

### Race - Asian POC/Non-Asian POC/White
```{r}
share_plot_by_year2(commute_1719, commute_21,
                    'race_eth_apoc', 'numwork_veh_grp',
                    'Race Categories')
share_plot_by_cat2(commute_1719, commute_21,
                   'race_eth_apoc', 'numwork_veh_grp',
                   'Race Categories')
```
\
In 2021, there were more Asian POC households with fewer vehicles than workers compared to Non-POC, but the difference with Non-Asian POC is difficult to determine because of MOEs. In 2017/19 there were more Non-POC with more vehicles than workers than the other racial groups, but this difference decreased in 2021 - a difference that is looks mostly because of the decrease for Non-POC since the other groups remain similar over time. 
\
\

## Income
```{r}
# share_plot_by_year(commute_17, commute_19, 
#                    commute_1719, commute_21,
#                    'hhincome_broad', 'numwork_veh_grp',
#                    'Income Categories')
# share_plot_by_cat(commute_17, commute_19,
#                   commute_1719, commute_21,
#                   'hhincome_broad', 'numwork_veh_grp',
#                   'Income Categories')

share_plot_by_year2(commute_1719, commute_21,
                    'hhincome_broad', 'numwork_veh_grp',
                    'Income Categories')
share_plot_by_cat2(commute_1719, commute_21,
                   'hhincome_broad', 'numwork_veh_grp',
                   'Income Categories')
```
\
Zero-vehicle households tend to make less money than households with at least one vehicle, especially in 2021. The overlapping MOEs make it difficult to determine any other changes between years, but the trends seem similar. The number of the lowest income households with fewer vehicles per worker decreased over time, seemingly because the number of households without a vehicle increased.   
\
\

## Education
```{r}
# share_plot_by_year(commute_17, commute_19, 
#                    commute_1719, commute_21,
#                    'education', 'numwork_veh_grp',
#                    'Education Categories')
# share_plot_by_cat(commute_17, commute_19,
#                   commute_1719, commute_21,
#                   'education', 'numwork_veh_grp',
#                   'Education Categories')

share_plot_by_year2(commute_1719, commute_21,
                    'education', 'numwork_veh_grp',
                    'Education Categories')
share_plot_by_cat2(commute_1719, commute_21,
                   'education', 'numwork_veh_grp',
                   'Education Categories')
```
\
In 2021, the number of household vehicles per workers seemed to change for individuals with less education - increased in no vehicle households, decrease in fewer vehicle than worker households, and increase in one vehicle per worker households. There doesn't seem to be too much of a difference between years for the other educational attainment levels. There may be a difference for individuals with bachelors degrees or higher in households with more vehicles than workers (decrease in 2021).


**Would it be better to create 2 groups instead of 3?** This would group the first two smaller categories together. 
```{r}
table(all_commute_17_21_simp$education, all_commute_17_21_simp$survey)
```
\
\

## Regional Growth Center
```{r}
# share_plot_by_year(commute_17, commute_19, 
#                    commute_1719, commute_21,
#                    'final_home_is_rgc', 'numwork_veh_grp',
#                    'Home Location')
# share_plot_by_cat(commute_17, commute_19,
#                   commute_1719, commute_21,
#                   'final_home_is_rgc', 'numwork_veh_grp',
#                   'Home Location')

share_plot_by_year2(commute_1719, commute_21,
                    'final_home_is_rgc', 'numwork_veh_grp',
                    'Home Location')
share_plot_by_cat2(commute_1719, commute_21,
                   'final_home_is_rgc', 'numwork_veh_grp',
                   'Home Location')
```
\
In 2021, for those living in RGCs, there was an increase in the zero vehicle households  and a decrease in the fewer vehicles than workers households. The trends for those living outside of RGCs were similar between years.  
\
\

## Commute Mode
```{r}
# share_plot_by_year(commute_17, commute_19, 
#                    commute_1719, commute_21,
#                    'commute', 'numwork_veh_grp',
#                    'Commute Modes')
# share_plot_by_cat(commute_17, commute_19,
#                   commute_1719, commute_21,
#                   'commute', 'numwork_veh_grp',
#                   'Commute Modes')

share_plot_by_year2(commute_1719, commute_21,
                    'commute_mode', 'numwork_veh_grp',
                    'Commute Modes')
share_plot_by_cat2(commute_1719, commute_21,
                   'commute_mode', 'numwork_veh_grp',
                   'Commute Modes')
```
\
In 2021, there was an increase in public transit use for zero-vehicle households. the zero vehicle households  and a decrease in the fewer vehicles than workers households. The trends for those living outside of RGCs were similar between years.  
\
\

## Household size
```{r}
share_plot_by_year(commute_17, commute_19,
                   commute_1719, commute_21,
                   'final_home_is_rgc', 'hhsize_simp',
                   'Commute Modes')
share_plot_by_cat(commute_17, commute_19,
                  commute_1719, commute_21,
                  'final_home_is_rgc', 'hhsize_simp',
                  'Commute Modes')

share_plot_by_year2(commute_1719, commute_21,
                    'final_home_is_rgc', 'hhsize_simp',
                    'Commute Modes')

share_plot_by_cat2(commute_1719, commute_21,
                   'final_home_is_rgc', 'hhsize_simp',
                   'Commute Modes')
```
\
For 3-person households, the difference between 2017 and 2019 is interesting to look at but it's difficult to make any conclusions because of the MOEs. Overall, regardless of time period, 1-2 person households are more often in RGCs, while households with 3 or more people are more often outside RGCs.  
\
\

```{r CSV output3, include=FALSE, eval=FALSE}
## create dataset ----
var <- c('race_eth_poc', 'vehicle_count', 'numworkers')

Vsurvey_17 <- get_hhts(survey = survey_a$survey,
                       level="p",
                       vars=var)
Vsurvey_19 <- get_hhts(survey = survey_b$survey,
                       level="p",
                       vars=var)
Vsurvey_1719 <- get_hhts(survey = survey_ab$survey,
                       level="p",
                       vars=var)
Vsurvey_21 <- get_hhts(survey = survey_c$survey,
                       level="p",
                       vars=var)

## refine dataset ----
V2survey_17 <- Vsurvey_17 %>% 
    filter(race_eth_poc!="Child -- no race specified") %>%
    mutate(veh_num=as.numeric(substr(vehicle_count, 1, 1))) %>%
    mutate(numwork_veh=numworkers/veh_num) %>% 
    mutate(numwork_veh_grp=case_when(numwork_veh<1~"3-More vehicles than workers",
                                     numwork_veh==1~"2-One vehicle per worker",
                                     numwork_veh>1~"1-Fewer vehicles than worker",
                                     TRUE ~ as.character(numwork_veh)))
V2survey_19 <- Vsurvey_19 %>% 
    filter(race_eth_poc!="Child -- no race specified") %>%
    mutate(veh_num=as.numeric(substr(vehicle_count, 1, 1))) %>%
    mutate(numwork_veh=numworkers/veh_num) %>% 
    mutate(numwork_veh_grp=case_when(numwork_veh<1~"3-More vehicles than workers",
                                     numwork_veh==1~"2-One vehicle per worker",
                                     numwork_veh>1~"1-Fewer vehicles than worker",
                                     TRUE ~ as.character(numwork_veh)))
V2survey_1719 <- Vsurvey_1719 %>% 
    filter(race_eth_poc!="Child -- no race specified") %>%
    mutate(veh_num=as.numeric(substr(vehicle_count, 1, 1))) %>%
    mutate(numwork_veh=numworkers/veh_num) %>% 
    mutate(numwork_veh_grp=case_when(numwork_veh<1~"3-More vehicles than workers",
                                     numwork_veh==1~"2-One vehicle per worker",
                                     numwork_veh>1~"1-Fewer vehicles than worker",
                                     TRUE ~ as.character(numwork_veh)))
    
V2survey_21 <- Vsurvey_21 %>% 
    filter(race_eth_poc!="Child -- no race specified") %>%
    mutate(veh_num=as.numeric(substr(vehicle_count, 1, 1))) %>%
    mutate(numwork_veh=numworkers/veh_num) %>% 
    mutate(numwork_veh_grp=case_when(numwork_veh<1~"3-More vehicles than workers",
                                     numwork_veh==1~"2-One vehicle per worker",
                                     numwork_veh>1~"1-Fewer vehicles than worker",
                                     TRUE ~ as.character(numwork_veh)))

tbl1 <- count_prep_fx(V2survey_17, 'race_eth_poc', 'numwork_veh_grp') 
tbl2 <- count_prep_fx(V2survey_19, 'race_eth_poc', 'numwork_veh_grp')
tbl3 <- count_prep_fx(V2survey_1719, 'race_eth_poc', 'numwork_veh_grp')
tbl4 <- count_prep_fx(V2survey_21, 'race_eth_poc', 'numwork_veh_grp')




## combine dataset ----
V3_commute_17_21 <- bind_rows(tbl1,
                              tbl2,
                              tbl3,
                              tbl4) %>%
    mutate(period = as.factor(survey))

write.csv(V3_commute_17_21,"T:/2022July/Mary/HHTS/output_data/3-race_vehperworker.csv", row.names = FALSE)

```
\
\

# Research: Vehicle Ownership & Location
## Vehicle Ownership & RGC
*Did the number of zero-vehicle households in RGCs increase in 2021?*
```{r, include=FALSE}
# Michael's example (https://psrc.github.io/psrc.travelsurvey/articles/calculate_hhts_summaries.html#determining-difference)
# t_2017_19c  <- get_hhts("2017_2019", "t", c("mode_simple","trip_path_distance","travel_time"))
# rs          <- hhts_median(t_2017_19c, "travel_time", "mode_simple")
# z_score(rs[1],rs[3])    # Compares the first-line and third-line estimates for significant difference;
#                         # -- true difference indicated by score > 1

# x <- get_hhts("2017_2019", "p", c('final_home_is_rgc', 'numwork_veh_grp'))
xy17 <- hhts_count(commute_1719, group_vars=c('final_home_is_rgc', 'numwork_veh_grp'))
xy21 <- hhts_count(commute_21, group_vars=c('final_home_is_rgc', 'numwork_veh_grp'))
z_0veh <- z_score(xy17[6], xy21[6]) 
```
No - based on the z-score (`r z_0veh`), we **cannot** conclude that the values are different and that there was a change over time.
\
\

*Did the number of fewer-vehicles-than-workers households in RGCs decrease in 2021?*
```{r}
z_lessveh <- z_score(xy17[7], xy21[7])
```
Yes - based on the z-score (`r z_lessveh`), we **can** conclude that the values are different and that there was a change over time.
\
\


## External data sources for location

* [US Census: Vehicles Available](https://www.census.gov/acs/www/about/why-we-ask-each-question/vehicles/)
* [Vehicle Registration Transactions by Department of Licensing](https://data.wa.gov/Transportation/Vehicle-Registration-Transactions-by-Department-of/brw6-jymh/data)
    + Counties: King, Kitsap, Pierce, Snohomish
    + Owner Type: Individual Owner
    + Transaction Month/Year: Jan 2021-Dec 2021
    + Vehicle Type: Passenger Car, Multipurpose Passenger Vehicle, Truck
* ["Car Ownership Statistics" by Lyle Daly](https://www.fool.com/the-ascent/research/car-ownership-statistics/)
    + Washington: 2.5: average number of vehicles per WA household

\
\

### Census
```{r}
veh_stats <- matrix(c(8.5,32.5,37.1,21.9,
                      6.9,29.2,37.3,26.2,
                      10.5,34.8,35.3,19.4,
                      4.7,25.7,40.3,29.3,
                      5.2,27.2,39.4,28.2,
                      4.7,25.2,39.7,30.4),
                      ncol=6, byrow=FALSE)
veh_stats <- veh_stats*.01
colnames(veh_stats) <- c("National", "Washington", "King", "Kitsap", "Pierce", "Snohomish")
rownames(veh_stats) <- c("No vehicle available", "1 vehicle available", "2 vehicles available", "3+ vehicles available")

census_data <- as.table(veh_stats)
census_data_df <- as.data.frame(census_data)
colnames(census_data_df)[1] <- "Vehicles"
colnames(census_data_df)[2] <- "Geography"
colnames(census_data_df)[3] <- "Households"
```

```{r psrcplot}
veh_stats_plot <- create_bar_chart(t=census_data_df,
                                   w.x="Vehicles",
                                   w.y="Households",
                                   f="Geography",
                                   w.title="Household Vehicle Ownership",
                                   w.sub.title="Latest ACS 5-Year Estimates | Data Profiles/Housing Characteristics",
                                   w.color="psrc_light",
                                   w.interactive="yes")

veh_stats_plot

# veh_stats_plot2 <- create_facet_bar_chart(t=census_data_df,
#                                           w.x="Geography",
#                                           w.y="Households",
#                                           f="Geography",
#                                           g="Vehicles",
#                                           w.title="Household Vehicle Ownership",
#                                           w.sub.title="Latest ACS 5-Year Estimates | Data Profiles/Housing Characteristics",
#                                           w.color="psrc_light",
#                                           w.interactive="yes",
#                                           w.scales="fixed",
#                                           w.facet=4)
# 
# veh_stats_plot2
```
\
\


These results are similar to those from the Household Travel Survey. 
```{r}
# generate data
veh_num_simp_1719 <- hhts_count(commute_1719,
                                group_vars = c("final_cnty","veh_num_smp")) %>%
  filter(veh_num_smp!="Total") %>% 
  filter(final_cnty!="Total")

veh_num_simp_21 <- hhts_count(commute_21,
                              group_vars = c("final_cnty","veh_num_smp")) %>%
  filter(veh_num_smp!="Total") 
  # filter(final_cnty!="Total") %>% 
  # drop_na(final_cnty)

hhveh_num_simp <- bind_rows(veh_num_simp_1719,
                            veh_num_simp_21)

# table(hhveh_num_simp$final_cnty, hhveh_num_simp$veh_num_smp)
# head(hhveh_num_simp)
# table(veh_num_simp_1719$final_cnty)
# table(veh_num_simp_1719$veh_num_smp)
# table(commute_17$veh_num_smp)
# table(commute_21$veh_num_smp)


# # create CSV
# write.csv(commute_allworkers,
#           "T:/2022July/Mary/HHTS/output_data/commute_allworkers.csv", 
#           row.names = FALSE)

# test dataset
veh_num_plot <- create_facet_bar_chart(t=hhveh_num_simp,
                                       w.x="veh_num_smp",
                                       w.y="share",
                                       f="final_cnty",
                                       g="survey",
                                       w.title="Household Vehicle Ownership",
                                       w.sub.title="Household Travel Survey | PSRC",
                                       w.color="psrc_light",
                                       w.interactive="yes")

veh_num_plot
```
\
\

### Department of Licensing
Mapping Vehicle Registrations
```{r, include=FALSE}
# reading in csvs from DoL 
King_21 <- read.csv(file = 'T:/2022August/Mary/HHTS/veh_regis_2021/Vehicle_Registration_King.csv')
Kitsap_21 <- read.csv(file = 'T:/2022August/Mary/HHTS/veh_regis_2021/Vehicle_Registration_Kitsap.csv')
Pierce_21 <- read.csv(file = 'T:/2022August/Mary/HHTS/veh_regis_2021/Vehicle_Registration_Pierce.csv')
Snohomish_21 <- read.csv(file = 'T:/2022August/Mary/HHTS/veh_regis_2021/Vehicle_Registration_Snohomish.csv')

# head(Kitsap_21)
# class(Snohomish_21$X2020.Census.Tract)

#combining the county files - they were too large to download as one file
# class(Kitsap_21$Postal.Code) #integer
# class(King_21$Postal.Code) #character
# class(Pierce_21$Postal.Code) #integer
# class(Snohomish_21$Postal.Code) #integer

King_21$Postal.Code <- as.integer(King_21$Postal.Code)

veh_reg_PSRC <- bind_rows(King_21, Kitsap_21, 
                          Pierce_21, Snohomish_21)

# head(veh_reg_PSRC)
# table(veh_reg_PSRC$County)
# table(veh_reg_PSRC$X2020.Census.Tract)
```

```{r, include=FALSE}
# Read in shapefile ----
spn<- 2285
wgs_84<-4326

# ElmerGeo
# geodatabase_server <- "AWS-PROD-SQL\\Sockeye"
# geodatabase_name <- "ElmerGeo"
# gdb_nm <- paste0("MSSQL:server=",geodatabase_server,";database=",geodatabase_name,";trusted_connection=yes")
# tbl_nm <- "dbo.tract2020_nowater"
# tracts_layer<- st_read(gdb_nm, tbl_nm)
# tracts_layer<- st_transform(tracts_layer, crs=wgs_84)

# option for when ElmerGeo not working
tbl_nm <- "T:/2022August/Mary/HHTS/output_data/tracts_2020.shp"
tracts_layer <- st_read(tbl_nm)
tracts_layer <- st_transform(tracts_layer, crs=wgs_84)

# elmer_geo_connection <- dbConnect(odbc::odbc(),
#                                   driver = "SQL Server",
#                                   server = "AWS-PROD-SQL\\Sockeye",
#                                   database = "ElmerGeo",
#                                   trusted_connection = "yes")
# 
# tracts_layer <- st_read(dsn=elmer_geo_connection,
#                         layer="TRACT2020_NOWATER",
#                         geometry_column = 'Shape',
#                         type = 6)

# plot(tracts_layer)

# Join DoL data to 2020 tract shapefile ----
# add leading 0's to join to shapefile's tract numbers
veh_reg_PSRC$X2020.Census.Tract <- str_pad(veh_reg_PSRC$X2020.Census.Tract, 6, side = "left", pad = "0")

# transform from integer to string
# class(veh_reg_PSRC$X2020.Census.Tract) #integer
veh_reg_PSRC$X2020.Census.Tract <- as.character(veh_reg_PSRC$X2020.Census.Tract)
# class(veh_reg_PSRC$X2020.Census.Tract) #character
# head(veh_reg_PSRC$X2020.Census.Tract)
# nrow(veh_reg_PSRC) #3191865


# aggregate number of vehicle registrations by census tract
# head(veh_reg_PSRC)
# table(veh_reg_PSRC$X2020.Census.Tract)
# table(veh_reg_PSRC$Transaction.Count)
veh_reg_PSRC_agg <- veh_reg_PSRC %>% 
  group_by(X2020.Census.Tract) %>%
  summarise(veh_by_tract=sum(Transaction.Count)) 
  
  
# nrow(veh_reg_PSRC_agg) #965
class(veh_reg_PSRC_agg$veh_by_tract)
head(veh_reg_PSRC_agg$veh_by_tract)

# merge on variables
veh_num_tracts <- merge(tracts_layer, veh_reg_PSRC_agg, 
                        by.x="tractce20",
                        by.y="X2020.Census.Tract", 
                        all.x=TRUE)
# plot(veh_num_tracts$veh_by_tract)
# class(veh_num_tracts$veh_by_tract)

# calculate vehicles by population for each tract
veh_num_tracts_pop <- veh_num_tracts %>% 
  mutate(veh_by_pop_tract=veh_by_tract/total_pop2)

summary(veh_num_tracts$veh_by_pop_tract)
class(veh_num_tracts_pop$veh_by_pop_tract)
summary(veh_num_tracts_pop$veh_by_pop_tract)
summary(veh_num_tracts$veh_by_tract)
head(veh_num_tracts_pop)

# save as shapefile again
# shapefile(veh_num_tracts,"T:/2022August/Mary/HHTS/output_data/veh_num_tracts_2020.shp")  
```

```{r}
# set map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8

# set up palettes
pop_pal <- leaflet::colorNumeric(palette="Purples", 
                             domain = veh_num_tracts_pop$total_pop2)

veh_pal <- leaflet::colorNumeric(palette="Greens", 
                             domain = veh_num_tracts_pop$veh_by_tract)

vbp_pal <- leaflet::colorNumeric("Blues", veh_num_tracts_pop$veh_by_pop_tract)

# map settings
veh_registration_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addLayersControl(baseGroups = "Vehicles per person",
                   overlayGroups = c("Vehicle registrations",
                                     "Population per tract"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  # polygon layers
  addPolygons(data=veh_num_tracts_pop,
              fillColor = veh_pal(veh_num_tracts_pop$veh_by_tract),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 1.0,
              group = "Vehicle registrations",
              label = ~veh_by_tract) %>%
  addPolygons(data=veh_num_tracts_pop,
              fillColor = pop_pal(veh_num_tracts_pop$total_pop2),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 1.0,
              group = "Population per tract",
              label = ~total_pop2) %>%
  addPolygons(data=veh_num_tracts_pop,
               fillColor = vbp_pal(veh_num_tracts_pop$veh_by_pop_tract),
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 1.0,
              group = "Vehicles per person",
              label = ~veh_by_pop_tract) %>% 
  # legends
  leaflet::addLegend(pal = vbp_pal,
                     values = veh_num_tracts_pop$veh_by_pop_tract,
                     position = "bottomleft",
                     title = paste("Vehicle registrations","<br>", "per person"),
                     group="Vehicles per person") %>% 
  leaflet::addLegend(pal = veh_pal,
                     values = veh_num_tracts_pop$veh_by_tract,
                     position = "bottomright",
                     title = "Vehicle registrations",
                     group="Vehicle registrations") %>%
  leaflet::addLegend(pal = pop_pal,
                     values = veh_num_tracts_pop$total_pop2,
                     position = "bottomright",
                     title = "Population",
                     group="Population per tract") %>%
  #default hide overlap groups
  hideGroup("Vehicle registrations") %>% 
  hideGroup("Population per tract") %>%
  #set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom)
  # addHomeButton(group = "Vehicles per person",
  #                        position = "topleft",
  #                        add=TRUE)

# print map
veh_registration_map
```
This map includes census tract population data (2020). The population numbers are based on all people in the tract - not the number of workers or number of adults. To calculate vehicle registrations by workers or by adults would require additional work retrieving those numbers by tract. 
\
\


# END OF WORK FOR NOW------
\
```{r, include=FALSE, eval=FALSE}
race_com_2017_noveh_3grp <- psurvey_17_simp_3grp %>% 
  filter(vehicle_count=="0 (no vehicles)")

race_com_2017_noveh_cnt_3 <- count_prep_fx(race_com_2017_noveh_3grp,'race_eth_broad', 'commute_mode')

share_plot(race_com_2017_noveh_cnt_3, 'race_eth_broad', 'commute_mode', 'Race', 'Commute Mode and Race: 2017, No household vehicles')
```
\
\

# Analysis
## Transit and Household Auto Ownership
```{r, include=FALSE, eval=FALSE}
# retrieve data
# hh_autos_all <- get_hhts(dyear=c(2017,2019,2021),
#                          level="h",
#                          vars=c("hh_race_category",
#                                 "hhsize",
#                                 "vehicle_count",
#                                 "survey_year"))



# Household-level data
hh_autos <- c(2017, 2019, 2021) %>%
  lapply(FUN=function(x) get_hhts(x, "h", 
                                  c("survey_year",
                                    "vehicle_count",
                                    "hh_race_category",
                                    "hhsize",
                                    "numworkers", #to be able to calculate ratio
                                    "hhincome_broad",
                                    "lifecycle",
                                    "numworkers", #to be able to calculate ratio
                                    # "final_home_rgcnum",
                                    "res_type")))

hh_autos_simp <- lapply(c(2017, 2019, 2021), FUN=function(x) get_hhts(x, "h", 
                                  c("hh_race_category",
                                    "hhsize",
                                    "vehicle_count",
                                    "survey_year",
                                    "numworkers", #to be able to calculate ratio
                                    "hhincome_broad",
                                    "hhincome_detailed",
                                    "lifecycle",
                                    "final_home_rgcnum")) %>% 
                          mutate(vehicle_count_simp=case_when(vehicle_count== "0 (no vehicles)" ~ 0,
                                      vehicle_count == "1" ~ 1,
                                      vehicle_count == "2" ~ 2,
                                      is.na(vehicle_count) ~ NA_real_,
                                      TRUE ~ 3)))

# Person-level data
#education, license 

```

```{r example from Michael 4/15, include=FALSE, eval=FALSE}
pums_1yr <- list()
pums_1yr <- lapply(2015:2019, FUN=function(x) get_psrc_pums(1, x, "p", c("PRACE", "SCHL", "AGEP")) %>%
               mutate(data_year=as.factor(x)) %>%
               mutate(POCYN=case_when(
                   PRACE=="White alone" ~ "Non-POC", 
                   !is.na(PRACE) ~ "POC")) %>%
               mutate(edu_simp=case_when(
                   grepl("(Bach|Mast|Prof|Doct)", SCHL) ~ "Bachelor's degree or higher",
                                           !is.na(SCHL) ~ "Less than a Bachelor's degree")))
poc_edu_pums <- function(dt){
                  temp <- filter(dt, AGEP > 24)
                  counties <- c("King","Kitsap","Pierce","Snohomish")
                  rs <- list()
                  rs <- lapply(counties, FUN=function(x){
                     ctytmp <- filter(temp, COUNTY==x)
                     rs1 <- psrc_pums_count(ctytmp, 
                                            group_var=c("edu_simp","POCYN"), 
                                            incl_counties=FALSE) %>%
                            mutate(County=unique(pull(ctytmp,COUNTY)))}) %>% rbindlist() %>%
                            mutate(data_year=unique(pull(temp, data_year))) %>% 
                            relocate(c("data_year", "County"))
return(rs)
}
poc_edu <- lapply(pums_1yr, poc_edu_pums) %>% rbindlist()
```

#### By Race
```{r, include=FALSE, eval=FALSE}
# stat function
# race_auto <- hhts_count(df=hh_autos_all,
#                         group_vars=c("hh_race_category", 
#                                      "vehicle_count"))

cnt_fx <- function(x){
  hhts_count(x, group_vars=c("hh_race_category","vehicle_count"))
}

race_auto <- lapply(hh_autos, cnt_fx) %>% data.table::rbindlist()

# re-order number of vehicles in numerical order
race_auto$vehicle_count <- factor(race_auto$vehicle_count,
                                  levels=c("0 (no vehicles)", "1", 
                                           "2", "3", "4", "5",
                                           "6", "7", "8", "9", 
                                           "10 or more vehicles"))
# freq(race_auto$vehicle_count)
```

##### Survey Numbers
```{r, include=FALSE, eval=FALSE}
race_auto_total_nototal <- race_auto %>% 
  filter(vehicle_count!="Total")

count_and_share_plot(race_auto_total_nototal,
                     "hh_race_category",
                     "vehicle_count",
                     "Household race category",
                     "Number of Household Automobiles by Race")
```

```{r workspace, include=FALSE, eval=FALSE, echo=FALSE}
# race_auto_plot_count <- ggplot(race_auto_total_nototal, 
#                                aes(x=vehicle_count,
#                                    y=count,
#                                    fill=hh_race_category)) +
#   geom_bar(stat="identity",
#            position="dodge2") +
#   theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#         axis.title.x = element_blank()) +
#   labs(y = "Number of Households",
#        # x = "Number of vehicles",
#        # title = "Count in Region",
#        fill = "Household race category") +
#   scale_y_continuous(labels = scales::comma) +
#   geom_errorbar(aes(ymin=count-count_moe, ymax=count+count_moe),
#                 size=.5,width=.2,
#                 position=position_dodge(.9))
# 
# # print(race_auto_plot_count)
# 
# race_auto_plot_share <- ggplot(race_auto_total_nototal,
#                                aes(x=vehicle_count,
#                                    y=share,
#                                    fill=hh_race_category)) +
#   geom_bar(stat="identity",
#            position="dodge2") +
#   theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#         axis.title.x = element_blank()) +
#   labs(y = "Share of Households",
#        # x = "Number of vehicles",
#        # title = "Proportion in Region",
#        fill = "Household race category") +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#   geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
#                 size=.5, width=.2,
#                 position=position_dodge(0.9))
# 
# # print(race_auto_plot_nototal)
# 
# 
# autos <- ggarrange(race_auto_plot_count, race_auto_plot_share, ncol = 2, nrow = 1,
#                    common.legend = TRUE,
#                    legend = "bottom")
# annotate_figure(autos, top = text_grob("Number of Household Automobiles by Race", 
#                color = "blue", face = "bold", size = 14))
```
\
\

##### Simplified Vehicle Numbers
Because the survey provides the option for people to respond with the number of household vehicles up to 10, these categories have been simplified to 4 categories: 1, 2, 3+. 
```{r, include=FALSE, eval=FALSE}
# hh_autos_simp <- race_auto %>%
#   filter(vehicle_count!="Missing") %>% 
#   mutate(vehicle_count_simp=case_when(grepl("0", vehicle_count) ~ "0",
#                                       grepl("1", vehicle_count) ~ "1",
#                                       grepl("2", vehicle_count) ~ "2",
#                                       grepl("(3|4|5|6|7|8|9|10)", vehicle_count) ~ "3+",
#                                       TRUE~ vehicle_count))

hh_autos_simp <- race_auto %>%
  # filter(vehicle_count!="Missing") %>% 
  mutate(vehicle_count_simp=case_when(vehicle_count== "0 (no vehicles)" ~ 0,
                                      vehicle_count == "1" ~ 1,
                                      vehicle_count == "2" ~ 2,
                                      is.na(vehicle_count) ~ NA_real_,
                                      TRUE ~ 3))

table1(~vehicle_count |hh_race_category,
       data=race_auto,
       render.categorical=my.render.cat)

```

```{r, include=FALSE, eval=FALSE}
# unable to group by survey_year because of issue with variable, so requires additional steps - after retrieving the data, need to filter out by the year, then can perform the summary statistic, then rbind the tables together
hh_autos_simp_17 <- hh_autos_simp %>% 
  filter(survey_year==as.factor(2017))
hh_autos_simp_19 <- hh_autos_simp %>% 
  filter(survey_year==as.factor(2019))
hh_autos_simp_21 <- hh_autos_simp %>% 
  filter(survey_year==as.factor(2021))

auto_num_17 <- hhts_count(hh_autos_simp_17,
                          group_vars = c("vehicle_count_simp",
                                         "hh_race_category")) %>% 
  mutate(Year=2017)
auto_num_19 <- hhts_count(hh_autos_simp_19,
                          group_vars = c("vehicle_count_simp",
                                         "hh_race_category")) %>% 
  mutate(Year=2019)
auto_num_21 <- hhts_count(hh_autos_simp_21,
                          group_vars = c("vehicle_count_simp",
                                         "hh_race_category")) %>% 
  mutate(Year=2021)


auto_num_17_21 <- rbind(auto_num_17,
                        auto_num_19,
                        auto_num_21)


prop_tbl_by_auto <- auto_num_17_21 %>% 
  filter(vehicle_count_simp != "Total") %>% 
  filter(hh_race_category == "Total")

prop_tbl_by_auto_race <- auto_num_17_21 %>% 
  filter(vehicle_count_simp != "Total") %>% 
  filter(hh_race_category != "Total")


g1 <- ggplot(data=prop_tbl_by_auto, 
             aes(x=vehicle_count_simp,
                 y=share,
                 fill=Year))+
  geom_bar(stat="identity",
             position = "dodge2") +
    labs(x = "Number of Vehicles",
         y = "Percent of Households",
         fill = "Year",
         title = paste0("Auto Ownership by Household: Year")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       breaks = seq(0, 1, by = .2))

print(g1)

g2 <- ggplot(data=prop_tbl_by_auto_race, 
             aes(x=vehicle_count_simp,
                 y=share,
                 fill=hh_race_category))+
  geom_bar(stat="identity",
             position = "dodge2") +
    labs(x = "Number of Vehicles",
         y = "Percent of Households",
         fill = "Race/ethnicity",
         title = paste0("Auto Ownership by Household: Race/ethnicity")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       breaks = seq(0, 1, by = .2))

print(g2)



ggarrange(g1, g2, ncol = 2, nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
```

<a href="#top">Back to top of the page</a>
---
title: "modeling vehicle miles traveled"
output:
  html_document:
    df_print: paged
---




```{r }
library(psrc.travelsurvey)
library(dplyr)
library(stringr)
library(ggplot2)
library(psrcplot)
library(forcats)
library(odbc)
library(DBI)
library(tidyr)
library(tidycensus)
library(psrcslides)
library(officer)
library(DBI)
library(stargazer)
library(MASS)
install_psrc_fonts()
```


```{r}
mode_vars<-c('mode_1', 'mode_simple')
other_vars<-c('sample_county',  'dest_purpose_cat', 'origin_purpose_cat', 'trip_path_distance', 'household_id',  'travelers_total', 'person_id')

all_vars<-c(mode_vars, other_vars)
household_vars=c('hhid', 'final_home_tract_10' )
```

renter or owner
```{r}
trip_data_17_19<- get_hhts(survey="2017_2019", level="t", vars=all_vars)
```

```{r}
trip_data_17_19<-trip_data_17_19[,!duplicated(colnames(trip_data_17_19))]
```
# to do - join back to the person data to get people who don't have any driving
```{r}

driving_data<-trip_data_17_19 %>% dplyr::filter(mode_simple=='Drive') %>%
  mutate(travelers_total=ifelse(travelers_total>10, 1, travelers_total))%>%
  mutate(travelers_total=ifelse(travelers_total<1, 1, travelers_total))%>%
              mutate(vmt= trip_path_distance/travelers_total)
```

```{r}
vmt_per<- driving_data%>%group_by(person_id, daynum)%>%
          mutate(vmt_day=sum(vmt))%>%
          filter(row_number()==1)
```

```{r}

persons_list<- get_hhts(survey="2017_2019", level="p", vars=c('person_id', 'numadults', 'employment', 'final_cnty', 'vehicle_count',  "hhincome_broad",  'hhincome_detailed', 'final_home_is_rgc','hhsize', 'lifecycle', 'age_category', 'survey_year', 'rent_own', 'res_dur', 'numworkers', 'numchildren', 'gender_grp', 'jobs_count', 'student', 'education', 'industry', 'license', 'commute_freq', 'commute_dur', 'telecommute_freq', 'work_county', 'benefits_1', 'benefits_2', 'benefits_3', 'benefits_4', 'rent_own', 'commute_auto_distance'))
persons_list<-persons_list[,!duplicated(colnames(persons_list))]

```

```{r}
hh_tract<- get_hhts(survey='2017_2019', level = 'h', vars= c( 'final_home_tract10'))

persons_tract<-left_join(persons_list,hh_tract,by='household_id')%>%mutate(tract_char= as.character(final_home_tract10))

```

```{r}
t_access<- read.csv('transportation_accessibility.csv')%>%mutate(tract_char=as.character(geoid_nm))

persons_access<- left_join(persons_tract,t_access, by='tract_char')
```

```{r}
persons_vmt<-left_join(persons_access,vmt_per, by='person_id')%>%
  mutate(vmt_day=replace_na(vmt_day,0))%>%
  mutate(ln_vmt_day=log(1+vmt_day))%>%
  filter(vmt_day<300)

```

```{r}
ggplot(persons_vmt, aes(ln_vmt_day))+
geom_histogram()+
xlim(0, 10)
```

```{r}

vmt_model<-lm(vmt_day ~ numadults+employment+hhincome_broad+vehicle_count+age_category+lifecycle+hhsize+survey_year+final_home_is_rgc+numworkers+numchildren+gender_grp
+jobs_count+student+ education+ license+ commute_freq+ commute_dur +telecommute_freq+ final_cnty+benefits_1+ benefits_2+ benefits_3+ benefits_4+rent_own+ log(1+jobs_auto/10000)+ log(1+jobs_transit/10000)+log(1+supermarket)+log(1+pharmacy)+log(1+restaurant)+log(1+school)+log(1+park)+commute_auto_distance -1
               ,data=persons_vmt)

```

```{r}
step<-stepAIC(vmt_model, direction="both")
step$anova
```






```{r}
vmt_model_best_fit<-lm(vmt_day ~ numadults + employment + vehicle_count + lifecycle + 
    final_home_is_rgc + jobs_count + license + commute_freq + 
    commute_dur + telecommute_freq + final_cnty + benefits_2 + 
    benefits_3 + rent_own + log(1 + jobs_auto/10000) + log(1 + 
    jobs_transit/10000) + log(1 + supermarket) + log(1 + restaurant) + 
    log(1 + school) + log(1 + park) + log(1+commute_auto_distance) - 
    1, data=persons_vmt)
output<-stargazer(vmt_model_best_fit, type='text', out='vmt_model_best.txt')

```
```{r}
vmt_model_best_fit_2<-lm(vmt_day ~ numadults + vehicle_count + lifecycle + employment + license + 
    commute_dur + telecommute_freq + final_cnty + benefits_2 + 
    benefits_3 + rent_own + log(1 + jobs_auto/10000) + log(1 + 
    jobs_transit/10000)  + log(1 + park) + log(1+commute_auto_distance) - 
    1, data=persons_vmt)
output<-stargazer(vmt_model_best_fit_2, type='text', out='vmt_model_best2.txt')
```

```{r}
persons_vmt_model<- persons_vmt%>%select(numadults,employment,hhincome_detailed,vehicle_count,age_category,lifecycle,survey_year,numworkers,numchildren,gender_grp
,student, education, license, commute_freq, commute_dur ,telecommute_freq, final_cnty,benefits_1, benefits_2, benefits_3, benefits_4,rent_own, jobs_auto, jobs_transit,supermarket,pharmacy,restaurant,school,park, vmt_day) 
```
```{r}

```

```{r}
summary(persons_vmt_model)
```
``

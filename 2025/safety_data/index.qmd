---
title: 2025 Safety Data Topsheet Summary
date: today
server: shiny

echo: false

format:
  html:
    mainfont: Poppins
    theme: 
      light: [cosmo, custom.scss]
    code-tools: true
    df-print: kable
    warnings: false
---


```{r}
#| include: false
source("data_processing.R")
```

## missing variables

```{r}
vars_codebook <- variable_list$variable
vars_data <- names(safety_responses)

# setdiff(vars_codebook, vars_data) 
# setdiff(vars_data, vars_codebook) 
```

::: {.callout-warning}
### Issues and Questions

- the delivered dataset is missing `res_no_lanes` variable while having additional `non_res_streets` variable
- values in `non_res_streets`

```{r}
table(safety_responses$non_res_streets, useNA="always")
```

:::

## completed participant count

```{r}
safety_responses %>%
  group_by(platform) %>%
  summarise(count = n())
```


## stats by logic


::: {.callout-warning}
### Issues and Questions

- potential demographic variables that can be merged from HTS: `numchildren`, `disability_person`, `mobility_aides`
- coding error in variables related to reasons not being able to comfortably use travel modes (Click to expand following blocks)

::: {.callout-caution appearance="minimal" collapse="true"}

## `bike_comfort`: "0: Not Selected" and NAs are flipped

```{r}
get_vars_summary(safety_responses, "bike_comfort")
get_stat_output(safety_responses, variable_list, "if bike_comfort is not agree")
```

:::

::: {.callout-caution appearance="minimal" collapse="true"}

## `walk_comfort`: "0: Not Selected" and NAs are flipped

```{r}
get_vars_summary(safety_responses, "walk_comfort")
get_stat_output(safety_responses, variable_list, "If walk_comfort is not agree")
```

:::

::: {.callout-caution appearance="minimal" collapse="true"}

## `transit_comfort`: has no "0: Not Selected" values
  
```{r}
get_vars_summary(safety_responses, "transit_comfort")
get_stat_output(safety_responses, variable_list, "if transit_comfort is not agree")
```
  
:::
:::

::: {.callout-note}
dashboard does not work with local document (working on publishing with Netlify)
:::

```{r}
all_logics <- variable_list %>%
  group_by(logic) %>%
  summarise(n()) %>%
  ungroup() %>%
  arrange(desc(`n()`)) %>%
  mutate(logic_count = paste0(logic," (",`n()`,")"))

all_logics_list <-setNames(as.list(all_logics$logic), nm = all_logics$logic_count)
```



```{r}
# dropdown: select logic
shiny::selectInput('select_logic', ' Select Logic:', all_logics_list)
# print stat table
shiny::verbatimTextOutput("statData")
```

```{r}
#| context: server

source("data_processing.R")

df <- shiny::reactive(get_stat_output(safety_responses, variable_list, input$select_logic))

output$statData <- shiny::renderPrint({
  df()
})
```

## single variable charts

```{r}
# dropdown: select variable
shiny::selectInput('single_var', 'Select Variable:', unique(codebook$variable))
# print plot
plotly::plotlyOutput("single_plot") 
```

```{r}
#| context: server

source("data_processing.R")

output$single_plot <- plotly::renderPlotly({
  plot_single(input$single_var)
})
```



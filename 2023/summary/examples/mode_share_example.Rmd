---
title: "first-example-mode-summary"
author: "suzanne"
date: "2024-03-20"
output: html_document
---

## Load in Packages
You many need to download some packages on github: travelSurveyTools, psrcelmer, and psrcplot.
For this use the syntax:
library(devtools)
devtools::install_github('rsgInc/travelSurveyTools')
devtools::install_github('rsgInc/psrcelmer')
devtools::install_github('rsgInc/psrcplot')

```{r setup, include=FALSE}
library(data.table)
library(stringr)
library(travelSurveyTools)
library(psrcelmer)
library(dplyr)
library(psrcplot)
library(tidyverse)
```

## Debugging travelSurveyTools

travelSurveyTools still has many cryptic error messages usually related to data or codebook formatting and naming. You may need to debug to find where or why the problem exists.

You can use: devtools::load_all('C:/GitHub/travelSurveyTools/R') and then browser() and put breakpoints in the code to find the problem.


## Read in data items from Elmer

The travelSurveyTools package expects everything to be a data.table, so run setDT all over the place.
```{r }
trip<- get_query(sql= "select trip_id, household_id as hh_id, day_id,
person_id, mode_1, survey_year,  trip_weight 
                from HHSurvey.v_trips_labels")

setDT(trip)
```

## Read in Codebook
```{r pressure, echo=FALSE}
cb_path = str_glue("J:/Projects/Surveys/HHTravel/Survey2023/Data/codebook/PSRC_Combined_Codebook_2023_packagable.xlsx")

variable_list = readxl::read_xlsx(cb_path, sheet = 'variable_list')
value_labels = readxl::read_xlsx(cb_path, sheet = 'value_labels')

setDT(variable_list)
setDT(value_labels)
```

## Set IDs as characters
I guess for joining?
```{r}
trip[, trip_id := as.character(trip_id)]
trip[, hh_id := as.character(hh_id)]
trip[, person_id := as.character(person_id)]
trip[, day_id := as.character(day_id)]
```

Make sure your summary variable is set to the expected type.
```{r}
trip <- trip%>%mutate(survey_year=as.character(survey_year))
```

## Make a new variable

If your variable is going to be a transformation of existing data in the codebook- for example grouping- you need to add the new variable and its new values to the internal to code, working codebook.

## Adding a new variable to the codebook
```{r}

variable_list<-rbind(
    variable_list,
    data.table(
      variable = "mode_simple",
      is_checkbox = 0,
      hh = 0,
      person = 0,
      day = 0,
      trip = 1,
      vehicle = 0,
      location = 0,
      description = "mode aggregation",
      logic = 'mode aggregation',
      data_type = "integer/categorical",
      shared_name = "mode_simple"
    )
  )

```

##Define new value labels and add them to the value_labels
```{r}
mode_simple_labels = value_labels[group_1_title == 'mode_simple',
                                   c('label', 'group_1_value')]

```

```{r}
value_labels<-value_labels%>%select(variable, value, label, val_order)
mode_simple_value_labels<-mode_simple_labels%>%
                            mutate(variable='mode_simple')%>%
                            distinct(group_1_value, .keep_all=TRUE)%>%
                            rowid_to_column(var='value')%>%
                           rowid_to_column(var='val_order')%>%
                             select(variable, value, group_1_value, val_order)%>%
                           rename(label=group_1_value)


 
value_labels<-rbind(value_labels,
                     data.table(mode_simple_value_labels))
```

```{r}
variable_list<-setDT(variable_list)
value_labels<-setDT(value_labels)
value_labels[, val_order := seq_len(nrow(value_labels))]
```
```

## Create new variable on the household travel survey table
```{r}

trip <-merge(trip, mode_simple_labels, by.x = 'mode_1', by.y = 'label')
setnames(trip, 'group_1_value', 'mode_simple')

```


The package expects the data to be in a list of data.tables.
```{r}
hts_data = list(#hh = hh,
                #person = person,
                #day = day,
                trip = trip)
```

## Prepare data for summary
```{r}
prepped_dt = hts_prep_variable(summarize_var = 'mode_simple',
                               summarize_by = 'survey_year',
                               data = hts_data,
                               id_cols = 'trip_id',
                               wt_cols = 'trip_weight',
                               weighted = TRUE,
                               missing_values = '')
```

## Summarize data
```{r}
mode_summary<-hts_summary(prepped_dt = prepped_dt$cat,
                          summarize_var = 'mode_simple',
                          summarize_by = 'survey_year',
                          id_cols = 'trip_id',
                          wtname='trip_weight',
                          weighted = TRUE)
```

## Visualize
```{r}
common_modes<-mode_summary$summary$wtd%>%filter(prop>.005)
static_bar_chart(common_modes, y='mode_simple', x='prop', fill='survey_year')

```


---
title: "second-example"
author: "suzanne"
date: "2024-03-27"
output: html_document
---



```{r setup, include=FALSE}
library(data.table)
library(stringr)
library(travelSurveyTools)
library(psrcelmer)
library(dplyr)
library(psrcplot)
library(tidyverse)
source('survey-23-preprocess.R')
```



```{r }
hh<- get_query(sql= "select  household_id as hh_id, hhincome_broad,survey_year, hh_weight
                from HHSurvey.v_households_labels")


person<- get_query(sql= "select household_id as hh_id,race_category,
person_id, workplace, telecommute_freq, survey_year, person_weight, gender, age, industry 
                from HHSurvey.v_persons_labels")
                
day<- get_query(sql= "select person_id, day_id, household_id as hh_id, telework_time, day_weight , survey_year from HHSurvey.v_days_labels")

trip<- get_query(sql= "select trip_id, household_id as hh_id, day_id,
person_id, mode_1, dest_purpose, survey_year, trip_weight 
                from HHSurvey.v_trips_labels")
setDT(hh)
setDT(person)
setDT(day)
setDT(trip)
```
#race_category needs to be added to the codebook



## Read in Codebook
```{r pressure, echo=FALSE}
cb_path = str_glue("J:/Projects/Surveys/HHTravel/Survey2023/Data/codebook/PSRC_Combined_Codebook_2023_packagable.xlsx")

variable_list = readxl::read_xlsx(cb_path, sheet = 'variable_list')
value_labels = readxl::read_xlsx(cb_path, sheet = 'value_labels')

setDT(variable_list)
setDT(value_labels)
```

## Set IDs as characters
I guess for joining?, functionalize convert all ids to charcets
```{r}

hh[, hh_id:=as.character(hh_id)]
person[, hh_id:=as.character(hh_id)]
day[, hh_id:=as.character(hh_id)]
trip[, hh_id := as.character(hh_id)]

person[, person_id := as.character(person_id)]
day[, person_id := as.character(person_id)]
trip[, person_id := as.character(person_id)]

day[, day_id := as.character(day_id)]
trip[, day_id := as.character(day_id)]

trip[, trip_id := as.character(trip_id)]
hh <- hh%>%mutate(survey_year=as.character(survey_year))
person <- person%>%mutate(survey_year=as.character(survey_year))
day <- day%>%mutate(survey_year=as.character(survey_year))
trip <- trip%>%mutate(survey_year=as.character(survey_year))
```

Variables that need grouping:
telework_time: use group_2, group_2_value: telework_time_broad
gender: gender_grp group_1
telecommute_freq: telecommute_freq_simple: group_1
dest_purpose: dest_purpose_simple, group_1
mode-> mode_simple


```{r}

variable_list<-rbind(
    variable_list,
    data.table(
      variable = c("mode_simple", 'dest_purpose_simple', 'telework_time_broad', 'gender_grp', 'telecommute_freq_simple'),
      is_checkbox = c(0,0,0,0,0),
      hh = c(0,0,0,0,0),
      person = c(0,0,0,1, 1),
      day = c(0,0,1,0, 0),
      trip = c(1,1, 0, 0,0),
      vehicle = c(0,0,0,0,0),
      location = c(0,0,0,0,0),
      description = c("mode aggregation", "destination aggregation", "telework time aggregation", "gender group", 'telecommute frequency group'),
      logic = c('mode aggregation', 'destination aggregation',"telework time aggregation", "gender group", 'telecommute frequency group'),
      data_type = c("integer/categorical", "integer/categorical", "integer/categorical", "integer/categorical", "integer/categorical"),
      shared_name = c("mode_simple", 'dest_purpose_simple', 'telework_time_broad', 'gender_grp', 'telecommute_freq_simple')
    )
  )


```


# Add associated values
1. persons: telecommute_freq_simple, gender_grp
2. day: telework_time_broad
2. trips: mode_simple, dest_purpose_simple



# persons day table, gender_grp
1. find the labels for the group
2. add the labeled data to the underlying table
3. add the values code to the values list
```{r}
group_labels<-get_group_labels(value_labels,group_id, group_name, tbl)
person_gend_group<-add_grp_tbl(group_labels, tbl)
values_labels<-add_values_code(group_labels, value_labels)
```



# persons table telecommute_freq
```{r}

group_labels   <- value_labels%>%
                    filter(group_1_title == 'telecommute_freq_simple')%>%
                    select('label', group_1_value)

value_labels<-add_values_code(group_labels,  value_labels, 'telecommute_freq_simple','group_1_value')

```


## Create new variable on the household travel survey table, using the grouped variable
```{r}
person <-left_join(person, group_labels, by=c('telecommute_freq' = 'label'))
setnames(person, 'group_1_value', 'telecommute_freq_simple' )

```




# day table, telework_time_broad
```{r}

group_labels   <- value_labels%>%
                    filter(group_2_title == 'telework_time_broad')%>%
                    select('label', group_2_value)

value_labels<-add_values_code(group_labels,  value_labels, 'telework_time_broad','group_2_value')

```


## Create new variable on the household travel survey table, using the grouped variable
```{r}
day <-left_join(day, group_labels, by=c('telework_time' = 'label'))
setnames(day, 'group_2_value', 'telework_time_broad')

```






# trip table
```{r}

group_labels   <- value_labels%>%
                    filter(group_1_title == 'mode_simple')%>%
                    select('label', group_1_value)

value_labels<-add_values_code(group_labels,  value_labels, 'mode_simple','group_1_value')

```


## Create new variable on the household travel survey table, using the grouped variable
```{r}
trip <-left_join(trip, group_labels, by=c('mode_1' = 'label'))

setnames(trip, 'group_1_value', 'mode_simple')

```


purpose

```{r}

group_labels   <- value_labels%>%
                    filter(group_1_title == 'dest_purpose_simple')%>%
                    select('label', group_1_value)

value_labels<-add_values_code(group_labels,  value_labels, 'dest_purpose_simple','group_1_value')

```


## Create new variable on the household travel survey table, using the grouped variable
```{r}
trip <-left_join(trip, group_labels, by=c('dest_purpose' = 'label'))

setnames(trip, 'group_1_value', 'dest_purpose_simple')

```

```{r}
variable_list<-variable_list%>% distinct(variable, .keep_all=TRUE)
```

trend in workplace (person)
workplace by hh income

trend in frequency (person)
telecommute_freq

trend in time spent (day)
time spent by hhincome


trips by purpose
by workplace
by time spent
by frequency

trips by mode
by workplace
by time spent
by frequency

# join persons to households
# join that to days
# join days to trips

```{r}
#person<-merge(person, hh, by = c('hh_id', 'survey_year'))
#day<-merge(person,day, by = c('person_id', 'survey_year'))
#trip<-merge(day, trip, by = c('day_id', 'survey_year'))

```
workplace; workplace by income; telecommute frequency; telecommute frequency by income
```{r}
workers<-person%>%filter(!workplace %in% c('Missing: Skip logic', "Missing: Skip Logic"))%>%drop_na(workplace)
worker_list<-list(person=workers)

```



```{r}
workplace <- summarize_weighted(hts_data= worker_list,
                               summarize_var = 'workplace',
                               summarize_by = 'survey_year',
                               id_cols=c('person_id'),
                               wt_cols=c('person_weight')
                               )

```
## Visualize
```{r}

workplace_summary<-workplace$summary$wtd%>%filter(prop>.005)
static_bar_chart(workplace_summary, y='workplace', x='prop', fill='survey_year')

```
2023 only by income
```{r}
workers_23<-workers%>%filter(survey_year =='2023')
hh_23<- hh%>%filter(survey_year== '2023')

worker_list_23<- list(hh=hh_23, person= workers_23)
```

```{r}
workplace_gender <- summarize_weighted(hts_data= worker_list_23,
                               summarize_var = 'workplace',
                               summarize_by = 'gender_grp',
                               id_cols='person_id',
                               wt_cols='person_weight',
                               wt_name="person_weight"
                               )

```
## Visualize
```{r}

workplace_gender_summary<-workplace_gender$summary$wtd
static_bar_chart(workplace_gender_summary, y='workplace', x='prop', fill='gender_grp')

```
```{r}
workplace_industry <- summarize_weighted(hts_data= worker_list_23,
                               summarize_var = 'workplace',
                               summarize_by = c('survey_year', 'hhincome_broad'),
                               id_cols=c('hh_id', 'person_id'),
                               wt_cols= c('hh_weight', 'person_weight'),
                               wtname =  'person_weight'
                               )

```
```{r}

workplace_industry_summary<-workplace_industry$summary$wtd%>%mutate(group='group')
static_facet_column_chart(workplace_industry_summary, x='workplace', y='prop', fill='group', facet='industry')

```

The package expects the data to be in a list of data.tables.
```{r}

hts_data = list(#hh = hh,
                #person = person,
                #day = day,
                trip = trip)
```

##summarize data
```{r}

mode_summary = summarize_weighted(hts_data= hts_data,
                               summarize_var = 'mode_simple',
                               summarize_by = 'survey_year',
                               id_cols=c('hh_id', 'trip_id'),
                               wt_cols=c('hh_weight','trip_weight')
                               )
```


## Visualize
```{r}

common_modes<-mode_summary$summary$wtd%>%filter(prop>.005)
static_bar_chart(common_modes, y='mode_simple', x='prop', fill='survey_year')

```



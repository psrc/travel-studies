---
title: "displacement"
author: "suzanne"
date: "2024-05-09"
output: html_document
---


```{r setup, include=FALSE}
library(data.table)
library(stringr)
library(travelSurveyTools)
library(psrcelmer)
library(dplyr)
library(psrcplot)
library(tidyverse)
library(forcats)
source('../survey-23-preprocess.R')
```


```{r }
hh<- get_query(sql= "select  household_id as hh_id, hhincome_broad,home_jurisdiction,survey_year, hhsize, hh_race_category, numchildren,home_rgcname, prev_home_rgcname, res_dur, prev_res_factors_community_change, prev_res_factors_forced,prev_res_factors_housing_cost, prev_res_factors_income_change,   hh_weight
                from HHSurvey.v_households_labels")


setDT(hh)

```


```{r}
center.lyr <- st_read_elmergeo('URBAN_CENTERS')
```


new columns/variables, prev_home_rgc_type, current_home_rgc_type

## Read in Codebook
```{r pressure, echo=FALSE}
cb_path = str_glue("J:/Projects/Surveys/HHTravel/Survey2023/Data/data_published/PSRC_Codebook_2023_v1.xlsx")

variable_list = readxl::read_xlsx(cb_path, sheet = 'variable_list')
value_labels = readxl::read_xlsx(cb_path, sheet = 'value_labels')

setDT(variable_list)
setDT(value_labels)
```

## Set IDs as characters
TO DO: functionalize convert all ids to characters, or store as characters upfront
```{r}

hh[, hh_id:=as.character(hh_id)]

hh <- hh%>%mutate(survey_year=as.character(survey_year))

```

Variables needed: 
was_displaced on households table
prev_home_rgc_category
current_home_rgc_categorry


```{r}
variable_list<-add_variable(variable_list, 'was_displaced','hh')
variable_list<-add_variable(variable_list, 'prev_home_rgc_cat','hh')
variable_list<-add_variable(variable_list, 'current_home_rgc_cat','hh')
```

```{r}

value<- c(0,1,2,3)
label=c('Displaced Mover', 'Not Displaced Mover', 'Not Mover', 'No Response')
val_labels<-data.frame(value, label)
val_labels<-val_labels%>%mutate(variable='was_displaced')%>%
    mutate(group_1_title = NA, group_1_value = NA,
           group_2_title = NA, group_2_value= NA,
           group_3_title = NA, group_3_value = NA)

all_value_labels<-value_labels%>%select(variable, value, label, group_1_title, group_1_value,
                                      group_2_title, group_2_value, group_3_title, group_3_value)
new_value_labels<-rbind(all_value_labels, val_labels)
new_value_labels[, val_order := seq_len(nrow(new_value_labels))]
value_labels<-new_value_labels  
```


```{r}

value<- c(0,1,2,3)
label=c('Previous Home Urban RGC', 'Previous Home Metro RGC','Previous Home Not RGC', 'Not Mover')
val_labels<-data.frame(value, label)
val_labels<-val_labels%>%mutate(variable='prev_home_rgc_cat')%>%
    mutate(group_1_title = NA, group_1_value = NA,
           group_2_title = NA, group_2_value= NA,
           group_3_title = NA, group_3_value = NA)

all_value_labels<-value_labels%>%select(variable, value, label, group_1_title, group_1_value,
                                      group_2_title, group_2_value, group_3_title, group_3_value)
new_value_labels<-rbind(all_value_labels, val_labels)
new_value_labels[, val_order := seq_len(nrow(new_value_labels))]
value_labels<-new_value_labels  
```

```{r}

value<- c(0,1,2,3)
label=c('Current Home Urban RGC', 'Current Home Metro RGC','Current Home Not RGC', 'Not Mover')
val_labels<-data.frame(value, label)
val_labels<-val_labels%>%mutate(variable='prev_home_rgc_cat')%>%
    mutate(group_1_title = NA, group_1_value = NA,
           group_2_title = NA, group_2_value= NA,
           group_3_title = NA, group_3_value = NA)

all_value_labels<-value_labels%>%select(variable, value, label, group_1_title, group_1_value,
                                      group_2_title, group_2_value, group_3_title, group_3_value)
new_value_labels<-rbind(all_value_labels, val_labels)
new_value_labels[, val_order := seq_len(nrow(new_value_labels))]
value_labels<-new_value_labels  
```



prev_home_rgc_category
current_home_rgc_categorry

```{r}
variable_list<-add_variable(variable_list, 'res_dur_5',hh)
group_labels<-get_grouped_labels(group_id='group_1', group_name='res_dur_5')
value_labels<-add_values_code(group_name='res_dur_5')
hh<-grp_to_tbl(tbl=hh, ungrouped_name='res_dur', grouped_name='res_dur_5')
```
Add new variables to the households table

```{r}
#hh<-hh%>%drop_na(res_dur)%>%filter(res_dur!='Missing Response')
```

was_displaced
not everyone answered the question which makes this a bit challening
remove non-response




first find the list of movers; then find the non-response on the displacement question



### Note filtering non-response on residence duration




```{r}
#some how a duplicate snuck into the variable list not sure how
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)
```

```{r}
displacement_reasons<-c('prev_res_factors_forced', 'prev_res_factors_income_change', 'prev_res_factors_housing_cost', 'prev_res_factors_community_change')
```

```{r}
hh<-hh%>%mutate(was_displaced = case_when(
                res_dur_5 == 'More than 5 years' ~ 'Not Mover', 
                is.na(prev_res_factors_forced) ~ 'No Response',
                prev_res_factors_forced=='Missing: Skip Logic' ~ 'No Response',
                prev_res_factors_forced=='Selected'|prev_res_factors_income_change=='Selected'|
                prev_res_factors_housing_cost =='Selected'| prev_res_factors_community_change=='Selected' 
                ~ 'Displaced Mover',
                TRUE ~ 'Not Displaced Mover'
))


```

```{r}
hts_data<-list(hh=hh)
```


Aggregate res duration

```{r}
summary = summarize_weighted(hts_data= hts_data,
                               summarize_var = 'res_dur',
                               summarize_by = c('survey_year'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'res_dur', value_labels)
wtd_sum
```


```{r}
static_column_chart(wtd_sum,x='res_dur', y='prop', fill='survey_year',ylabel= 'Share of households', xlabel='Residence Duration')+ theme(axis.text.x=element_text(size=14), axis.text.y=element_text(size=14),legend.text = element_text(size=14), axis.title.y=element_text(size=20), axis.title.x=element_text(size=20))
```

```{r}
summary = summarize_weighted(hts_data= hts_data,
                               summarize_var = 'res_dur_5',
                               summarize_by = c('survey_year'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'res_dur_5', value_labels)
wtd_sum
```


```{r}
static_column_chart(wtd_sum,x='res_dur_5', y='prop', fill='survey_year',ylabel= 'Share of households', xlabel='Residence Duration')+ theme(axis.text.x=element_text(size=14), axis.text.y=element_text(size=14),legend.text = element_text(size=14), axis.title.y=element_text(size=20), axis.title.x=element_text(size=20))
```
```{r}
summary = summarize_weighted(hts_data= hts_data,
                               summarize_var = 'res_dur_5',
                               summarize_by = c('survey_year', 'prev_res_factors_forced'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'res_dur_5', value_labels)
wtd_sum
```


```{r}
summary = summarize_weighted(hts_data= hts_data,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum
```
```{r}
static_column_chart(wtd_sum,x='was_displaced', y='prop', fill='survey_year',ylabel= 'Share of households', xlabel='Displacement Status')+ theme(axis.text.x=element_text(size=14), axis.text.y=element_text(size=14),legend.text = element_text(size=14), axis.title.y=element_text(size=20), axis.title.x=element_text(size=20))
```


```{r}
summary = summarize_weighted(hts_data= hts_data,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum
```


NOTE: REMOVING NON RESPONSE
```{r}
hh_response<-hh%>%filter(was_displaced!='No Response')%>%filter(survey_year!='2017')
hts_data_w_response=list(hh=hh_response)

```

```{r}
summary = summarize_weighted(hts_data= hts_data_w_response,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum
```

```{r}
static_column_chart(wtd_sum,x='was_displaced', y='prop', fill='survey_year',ylabel= 'Share of households', xlabel='Displacement Status')+ theme(axis.text.x=element_text(size=14), axis.text.y=element_text(size=14),legend.text = element_text(size=14), axis.title.y=element_text(size=20), axis.title.x=element_text(size=20))
```

```{r}
summary = summarize_weighted(hts_data= hts_data_w_response,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum
```
```{r}
hh_response<-left_join(hh_response, center.lyr, by=join_by(prev_home_rgcname==name))

```


we know the current home of people whether they moved in the past five years or no, gives us a bigger sample
```{r}
hh_response<-hh_response%>%mutate(current_home_rgc_cat=case_when(
  is.na(home_rgcname) ~'Not RGC',
  home_rgcname=='Not RGC' ~ 'Not RGC',
  TRUE ~ 'RGC'))


hts_data_w_response<-list(hh=hh_response)
```

```{r}
summary = summarize_weighted(hts_data= hts_data_w_response,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year', 'current_home_rgc_cat'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum_all<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum_all
```


FILTER TO ONLY MOVERS, because we don't have previous home locations for non-movers
```{r}
hh_response<-hh_response%>%mutate(prev_home_rgc_cat=case_when(
  is.na(prev_home_rgcname) ~'Not RGC',
  prev_home_rgcname=='Not RGC' ~ 'Not RGC',
  TRUE ~ 'RGC'))%>%
  filter(res_dur_5=='Less than 5 years')

hts_data_w_response<-list(hh=hh_response)
```

```{r}
summary = summarize_weighted(hts_data= hts_data_w_response,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year', 'current_home_rgc_cat'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum_all<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum_all
```

```{r}
summary = summarize_weighted(hts_data= hts_data_w_response,
                               summarize_var = 'was_displaced',
                               summarize_by = c('survey_year', 'prev_home_rgc_cat'),
                               id_cols='hh_id',
                               wt_cols='hh_weight',
                               wtname='hh_weight'
                               )

wtd_sum<-order_factors(summary$summary$wtd, 'was_displaced', value_labels)
wtd_sum
```


```{r}
static_facet_column_chart(wtd_sum,x='was_displaced', y='prop', fill='survey_year', facet='prev_home_rgc_cat',ylabel= 'Share of households', xlabel='Displacement Status')+ theme(axis.text.x=element_text(size=14), axis.text.y=element_text(size=14),legend.text = element_text(size=14), axis.title.y=element_text(size=20), axis.title.x=element_text(size=20))
```


```{r}

```


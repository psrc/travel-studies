---
title: "Displacement: 5 years"
author: "Mary Richards"
format: 
  html:
    toc: true
editor: visual
execute:
  warning: false
---

# General setup

PSRC and RSG have built a new package called travelSurveyTools to work with travel survey data. It is recommended to read through this documentation before you start using the package. <https://rsginc.github.io/travelSurveyTools/>

## Read in Libraries

```{r setup}
# YOU MIGHT need to download some special packages on github: travelSurveyTools, psrcelmer, and psrcplot. IF you need to download them, here's how:
# library(devtools)
# 
# devtools::install_github('rsgInc/travelSurveyTools')
# devtools::install_github('psrc/psrcelmer')
# devtools::install_github('psrc/psrcplot')
# devtools::install_github('psrc/psrc.travelsurvey', force=TRUE)

library(data.table)
library(stringr)
library(travelSurveyTools)
library(psrcelmer)
library(dplyr)
library(psrcplot)
library(tidyverse)
library(table1)
library(psrc.travelsurvey)

library(sf) #for regional geographies
library(leaflet)
library(leafem) #home button
sf_use_s2(FALSE)
library(corrplot) #for correlation analysis

source('../survey-23-preprocess.R')
# source('C:/Users/mrichards/Documents/GitHub/travel-studies/2023/summary/survey-23-preprocess.R')
```

## Read in Codebook

```{r}
cb_path = str_glue("J:/Projects/Surveys/HHTravel/Survey2023/Data/data_published/PSRC_Codebook_2023_v1.xlsx")

variable_list = readxl::read_xlsx(cb_path, sheet = 'variable_list')
value_labels = readxl::read_xlsx(cb_path, sheet = 'value_labels')

setDT(variable_list)
setDT(value_labels)
```

## Read in Data from Elmer

```{r}
# Specify which variables to retrieve
# View(psrc.travelsurvey:::init_variable_list)

vars <- c(
  #household-level variables
  'household_id', 'res_dur', 'prev_home_wa', 'home_rgcname', 
  'prev_home_rgcname', 'home_county', 'prev_home_county',
  'home_jurisdiction', 'prev_rent_own', 'rent_own', 
  'prev_res_type', 'res_type',
  'hhsize', 'numadults', 'numchildren', 'numworkers', 'vehicle_count', 
  'hhincome_detailed', 'hhincome_broad',
  'prev_res_factors_amenities', 'prev_res_factors_community_change',
  'prev_res_factors_crime', 'prev_res_factors_employment', 
  'prev_res_factors_forced', 'prev_res_factors_hh_size', 
  'prev_res_factors_housing_cost', 'prev_res_factors_income_change', 
  'prev_res_factors_less_space', 'prev_res_factors_more_space', 
  'prev_res_factors_no_answer', 'prev_res_factors_other', 
  'prev_res_factors_quality', 'prev_res_factors_school', 
  'prev_res_factors_specify', 'prev_res_factors_telework', 
  'hh_race_category',
  "home_jurisdiction","home_lat","home_lng",
  "prev_home_lat", "prev_home_lng", 
  "home_tract20", "prev_home_tract20",
  
  #person-level variables
  'race_category', 'race_afam', 'race_aiak', 'race_asian', 'race_hapi', 
  'race_noanswer', 'race_other', 'race_other_specify', 'race_white',
  'ethnicity_1', 'ethnicity_2', 'ethnicity_3', 'ethnicity_4', 
  'ethnicity_997', 'ethnicity_999', 'ethnicity_other',
  'person_id', 'gender', 'age',
  'education', 'employment')

# Retrieve the data
hts_data <- get_psrc_hts(survey_vars = vars)  # default includes all survey_years

# For calculating moe
z_score<-1.645
```

The survey instrument is here: J:/Projects/Surveys/HHTravel/Survey2023/Documents/Survey_Instrument/Puget_Sound_HTS_Questionnaire_2023_Final.docx

Open the codebook and review the variable and it's values. J:/Projects/Surveys/HHTravel/Survey2023/Data/data_published/PSRC_Codebook_2023_v1.xlsx

# Research notes

## Who was asked?

### 2017

-   How long have you lived at your current residence?
-   Was your previous home located in the state of Washington? - If lived in residence \<= 5 years

### 2019

-   \[res_duration\]
-   \[prev_home_wa\] - if lived in current residence \<= 5 years
-   \[prev_res_factors\] - if previous home was in Washington (and moved in past 5 years)

### 2021

-   \[RES_DURATION\]
-   \[PREV_HOME_WA\] - if lived in current residence \<= 5 years
-   \[PREV_RES_FACTORS\] - if previous home was in Washington (and moved in past 5 years)

### 2023

-   \[RES_DURATION\] - if rMove or (rMove for Web and person 1)
-   \[PREV_HOME_WA\] - if lived in current residence \<= 5 years
-   \[PREV_RES_FACTORS\] - if previous home was in Washington

## How were the questions asked?

The 2017 survey didn't ask about \[prev_res_factors\], so displacement will be analyzed for 2019, 2021, and 2023.

*Which of the following were important factors in your decision to move away from your previous residence?* *Select all that apply.*

### 2019

-   Could no longer afford previous residence because of an increase in rent or housing costs
-   Could no longer afford previous residence because of a change in income or finances
-   Friends, family, or cultural community were leaving the area
-   Changes in household size, establish own household
-   Needed more space
-   Needed less space
-   Employment or commuting considerations (e.g., to take new job or shorten commute)
-   Access to a different K-12 school
-   Concerns about safety or crime
-   To upgrade to a better quality home or to stop renting and buy a home
-   Forced to move out (e.g., building demolished or renovated, asked to leave by landlord, foreclosure)
-   Other reason
-   Prefer not to answer

### 2021 (same wording as 2019 with a few additional options)

-   COVID-19 removed need to live in previous residence (e.g., no longer need to attend work or school in-person)
-   Concerns about COVID-19 health risks

### 2023 (similar options, but some new options and different wording of others)

-   *Increase in rent or housing costs, could no longer afford previous place*
-   *Change in income or finances, could no longer afford previous place*
-   *Friends, family, or cultural community left or were leaving the area*
-   *Change in who you live with (e.g., move out on your own, getting married/divorced)*
-   Needed more space
-   Needed less space
-   *To have better access to work (e.g., better commute or take new job)*
-   **To have better access to recreation, restaurants, shops, and other amenities**
-   *Employerâ€™s telework policy removed need to live in previous residence*
-   Access to a different K-12 school
-   Concerns about safety or crime
-   To upgrade to a better-quality home or to stop renting and buy a home
-   Forced to move out (e.g., building demolished or renovated, asked to leave by landlord, foreclosure)
-   Other reason
-   Prefer not to answer

## Topics to explore

-   Demographics (household level)
    -   race/ethnicity
    -   lifecycle
    -   household size
    -   number of children
    -   income
    -   number of vehicles
    -   education?
-   Previous and current living:
    -   housing tenure
    -   housing type
-   Spatial patterns (limited for 2023)
    -   RGCs

# Data setup

## Identify displaced movers

There was a problem with the 2023 HTS data, where the previous home location question was only asked to respondents who moved within the last five years AND moved from OUTSIDE of WA state. Therefore, we are unable to do any useful analyses moves/displacement based on where households had lived within our region.

To identify movers we are choosing those who have moved within the past **five years** and those who previously lived in Washington state.

To identify displacement, respondents were asked about their reasons for moving. 4 of the 14 reasons are linked with displacement:

-   Increase in rent or housing costs, could no longer afford previous place
-   Change in income or finances, could no longer afford previous place
-   Friends, family, or cultural community left or were leaving the area
-   Forced to move out (e.g., building demolished or renovated, asked to leave by landlord, foreclosure)

```{r}
# unique(hts_data$hh$res_dur)

hts_data$hh <- hts_data$hh %>% 
  mutate(movers=case_when(res_dur=="Less than a year" |
                            res_dur=="Between 1 and 2 years" | 
                            res_dur=="Between 2 and 3 years" |
                            res_dur=="Between 3 and 5 years"
                          ~ 'Did move',
                          res_dur=="Missing Response" ~ 'No response',
                          TRUE ~ 'Did not move'),
         displaced=case_when(prev_res_factors_forced=='Selected'|
                               prev_res_factors_income_change=='Selected'|
                               prev_res_factors_housing_cost =='Selected'|
                               prev_res_factors_community_change=='Selected'~ 'Displaced',
                             TRUE~'Not displaced'))

table(hts_data$hh$movers, hts_data$hh$displaced)
table(hts_data$hh$survey_year, hts_data$hh$movers)

# There is an issue with the 2023 data where some people who hadn't moved within the past 5 years were able to select reasons for moving (prev_res_factors). This shouldn't have happened: all respondents were asked how long they had been in their current homes > if they chose <5 years they were asked if their previous residence had been in WA > if yes, they were asked to select why they moved. As a result, we will need to filter out the people who did not move.

hts_data$hh <- hts_data$hh %>%
  filter(movers == "Did move")

# to check
table(hts_data$hh$movers)
table(hts_data$hh$survey_year, hts_data$hh$movers)
table(hts_data$hh$movers, hts_data$hh$displaced)
table(hts_data$hh$survey_year, hts_data$hh$displaced)
table(hts_data$hh$movers, hts_data$hh$res_dur)
table(hts_data$hh$res_dur, hts_data$hh$displaced)
```

### Less than 2 years

```{r}
# hts_data$hh <- hts_data$hh %>% 
#   mutate(movers=case_when(res_dur=="Less than a year" |
#                             res_dur=="Between 1 and 2 years" #| 
#                           # res_dur=="Between 2 and 3 years" |
#                           # res_dur=="Between 3 and 5 years" 
#                           ~ 'Did move',
#                           res_dur=="Missing Response" ~ 'No response',
#                           TRUE ~ 'Did not move'),
#          displaced=case_when(prev_res_factors_forced=='Selected'|
#                                prev_res_factors_income_change=='Selected'|
#                                prev_res_factors_housing_cost =='Selected'|
#                                prev_res_factors_community_change=='Selected'~ 'Displaced',
#                              TRUE~'Not displaced'))
# 
# # There is an issue with the 2023 data where some people who hadn't moved within the past 5 years were able to select reasons for moving (prev_res_factors). This shouldn't have happened: all respondents were asked how long they had been in their current homes > if they chose <5 years they were asked if their previous residence had been in WA > if yes, they were asked to select why they moved. As a result, we will need to filter out the people who did not move.
# 
# hts_data$hh <- hts_data$hh %>%
#   filter(movers != "Did not move")
# 
# # to check
# table(hts_data$hh$movers, hts_data$hh$displaced)
# table(hts_data$hh$movers, hts_data$hh$res_dur)
# table(hts_data$hh$res_dur, hts_data$hh$displaced)
```

Some of these movers came from out of the state or country

```{r}
table(hts_data$hh$prev_home_wa, hts_data$hh$survey_year)
```

But we want to focus on those who have moved within the state

```{r}
# filter to only those who previously lived in WA (wanted to get the total number of respondents who moved/didn't move - if filter had been in previous, those who did not move would not have been included because the prev_home_wa was only asked of people who reported moving within the past 5 years)
hts_data$hh <- hts_data$hh %>% 
   filter(prev_home_wa=="Yes, previous home was in Washington")

table(hts_data$hh$survey_year, hts_data$hh$movers)
```

Based on a denominator of 1276 in 2023, we can look at displacement.

```{r}
table(hts_data$hh$survey_year, hts_data$hh$displaced)

# create csv for checking
# write.csv(hts_data$hh,
#           "T:/2024October/Mary/HHTS/displacement_check.csv")
```

### Remove 2017 year from data

The 2017 survey did not ask respondents about why they moved, so they cannot be categorized as displaced or not displaced.

```{r}
hts_data$hh <- hts_data$hh %>% 
  filter(survey_year!=2017)
```

### Add standard groupings

Based on https://psrc.github.io/psrc.travelsurvey/articles/add-standard-groupings.html

```{r}
hts_data <- hts_data %>% 
  hts_bin_income() %>% 
  hts_bin_hhsize() %>% 
  hts_bin_rent_own() %>% 
  hts_bin_vehicle_count() %>% 
  hts_bin_edu() %>% 
  hts_bin_worker()
```

## Explore 'Other' responses

```{r, include=FALSE, eval=FALSE}
table(hts_data$hh$prev_res_factors_other, hts_data$hh$survey_year) 
# unique(hh_detail$prev_res_factors_specify)
```

# Demographics

## Household Race

#### All races

AANHIPI non-Hispanic, Black or African American non-Hispanic, Hispanic, Missing/No response, Some Other Races non-Hispanic, White non-Hispanic

The prop field is weighted and matches the estimate.

```{r}
# unique(hts_data$hh$hh_race_category)
# table(hts_data$hh$hh_race_category)

# add new variable
variable_list<-add_variable(variable_list, 'displaced','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('hh_race_category'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "hh_race_category", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Household race", 
                    title = "Displacement by Household Race (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

#### 4 races

AANHPI non-Hispanic, Hispanic, Missing/No response, Other POC non-Hispanic, White non-Hispanic

```{r}
hts_data$hh <- mutate(hts_data$hh,
                      hh_race_category_4= case_when(hh_race_category=="Black or African American non-Hispanic"|
                                                      hh_race_category=="Some Other Races non-Hispanic" ~ "Other POC non-Hispanic",
                                                    TRUE~hh_race_category))

# checking numbers
# unique(hts_data$hh$hh_race_category_4)
# table(hts_data$hh$hh_race_category_4)

# add new variable
variable_list<-add_variable(variable_list, 'hh_race_category_4','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('hh_race_category_4'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "hh_race_category_4", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Household race", 
                    title = "Displacement by Household Race (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

#### 3 races

AANHPI non-Hispanic, Missing/No response, Non-Asian POC, White non-Hispanic

```{r}
hts_data$hh <- mutate(hts_data$hh,
                      hh_race_category_3= case_when(hh_race_category=="Black or African American non-Hispanic"|
                                                      hh_race_category=="Hispanic" ~ "Non-Asian POC",
                                                      hh_race_category=="Some Other Races non-Hispanic" ~ "Non-Asian POC",
                                                    TRUE~hh_race_category))

# checking numbers
# unique(hts_data$hh$hh_race_category_3)
table(hts_data$hh$hh_race_category_3)

# add new variable
variable_list<-add_variable(variable_list, 'hh_race_category_3','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('hh_race_category_3'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "hh_race_category_3", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Household race", 
                    title = "Displacement by Household Race (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

#### 2 races

People of Color, Missing/No response, White non-Hispanic

```{r}
hts_data$hh <- mutate(hts_data$hh,
                      hh_race_category_2= case_when(hh_race_category=="AANHPI non-Hispanic"|
                                                      hh_race_category=="Black or African American non-Hispanic"|
                                                      hh_race_category=="Hispanic"|
                                                      hh_race_category=="Some Other Races non-Hispanic" ~ "POC",
                                                    TRUE~hh_race_category))

# checking numbers
# unique(hts_data$hh$hh_race_category_2)
# table(hts_data$hh$hh_race_category_2)

# add new variable
variable_list<-add_variable(variable_list, 'hh_race_category_2','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('hh_race_category_2'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "hh_race_category_2", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Household race", 
                    title = "Displacement by Household Race (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Checking with previous reports

https://www.psrc.org/media/4917 and https://www.psrc.org/media/4916 more documentation on data wiki (http://aws-linux/mediawiki/index.php/Displacement_Analysis)

```{r}
# prev_res_factors_forced, prev_res_factors_income_change, prev_res_factors_housing_cost, prev_res_factors_community_change
# 
movers_df <- hts_data$hh %>% 
  filter(movers=="Did move",
         survey_year==2019,
         prev_res_factors_forced=="Selected")

disp_2race_forced <- psrc_hts_stat(hts_data, 
                                   analysis_unit="hh", 
                                   group_vars=c("movers", "hh_race_category_2", "prev_res_factors_forced"))

disp_2race_income <- psrc_hts_stat(hts_data, 
                                   analysis_unit="hh", 
                                   group_vars=c("movers","hh_race_category_2", "prev_res_factors_income_change"))

disp_2race_cost <- psrc_hts_stat(hts_data, 
                                   analysis_unit="hh", 
                                   group_vars=c("movers","hh_race_category_2", "prev_res_factors_housing_cost"))

disp_2race_cost <- psrc_hts_stat(hts_data, 
                                   analysis_unit="hh", 
                                   group_vars=c("movers","hh_race_category_2", "prev_res_factors_community_change"))


table(hts_data$hh$prev_res_factors_other, hts_data$hh$survey_year) 
# unique(hh_detail$prev_res_factors_specify)
```

## Lifecycle

```{r}

```

## Household Size

```{r}
unique(hts_data$hh$hhsize) #13 options
unique(hts_data$hh$hhsize_bin4) #standard groupings: 4 options

# add new variable
variable_list<-add_variable(variable_list, 'hhsize_bin4','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('hhsize_bin4'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "hhsize_bin4", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Household Size", 
                    title = "Displacement by Household Size (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

## Number of children

```{r}
# unique(hts_data$hh$numchildren) #original variables
# table(hts_data$hh$numchildren) #original variables


hts_data$hh <- mutate(hts_data$hh,
                      numchildren_simp= factor(
                        fcase(grepl("^(3|4|5|6|7|8|9|10|11|12)", numchildren) ,"3+ children",
                               !is.na(numchildren), as.character(numchildren))))

unique(hts_data$hh$numchildren_simp)
table(hts_data$hh$numchildren_simp)

# add new variable
variable_list<-add_variable(variable_list, 'numchildren_simp','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('numchildren_simp'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "numchildren_simp", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Number of Children", 
                    title = "Displacement by Number of Children (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

## Household Income

```{r}
# unique(hts_data$hh$hhincome_broad) #original variables

# unique(hts_data$hh$hhincome_bin3) #standard groupings
unique(hts_data$hh$hhincome_bin5) #standard groupings

# add new variable
variable_list<-add_variable(variable_list, 'hhincome_bin5','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('hhincome_bin5'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "hhincome_bin5", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Household Income", 
                    title = "Displacement by Household Income (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```
### Household Income Flag

```{r}
unique(hts_data$hh$hhincome_bin5) #standard groupings

hts_data$hh <- hts_data$hh %>% 
  mutate(income_flag= case_when(hhincome_bin5=="$100,000 or more"~"$100,000 or more",
                            TRUE~"Less than $100,000"))

table(hts_data$hh$survey_year, hts_data$hh$income_flag)
```

## Number of Vehicles

```{r}
# unique(hts_data$hh$vehicle_count) #original variables

# unique(hts_data$hh$vehicle_count_bin4) #standard groupings

# add new variable
variable_list<-add_variable(variable_list, 'vehicle_count_bin4','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('vehicle_count_bin4'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "vehicle_count_bin4", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Number of Vehicles", 
                    title = "Displacement by Household Vehicle Count (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

## Education

```{r}
# unique(hts_data$person$education) #original variables
# table(hts_data$person$education) #original variables

# unique(hts_data$person$edu_bin2) #standard groupings
# table(hts_data$person$edu_bin2) 

edu_person <- hts_data$person %>% 
  select(hh_id, edu_bin2) %>% 
  mutate(edu_num= case_when(edu_bin2=="Less than Bachelors degree"~1,
                            edu_bin2=="Bachelors or higher"~2,
                            TRUE~NA)) %>% 
  group_by(hh_id) %>% 
  summarise(edu_num_prod = prod(edu_num, na.rm=T)) %>% 
  mutate(edu_hh_max= case_when(edu_num_prod==1~"Less than Bachelors degree",
                               edu_num_prod>1~"Bachelors or higher")) 
table(edu_person$edu_hh_max)

hts_data$hh <- hts_data$hh %>% 
  left_join(edu_person, by="hh_id")

# add new variable
variable_list<-add_variable(variable_list, 'edu_hh_max','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('edu_hh_max'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "edu_hh_max", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Education Attainment", 
                    title = "Displacement by Household's Highest Education (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

## Employment

### Number of workers
```{r}
# unique(hts_data$hh$numworkers) #original variables
# table(hts_data$hh$numworkers)

hts_data$hh <- mutate(hts_data$hh,
                      num_workers_4bin= factor(
                        fcase(grepl("^(3|4|5|6|7|8|9|10|11|12|13)", numworkers) ,"3+ workers",
                               !is.na(numworkers), as.character(numworkers))))


table(hts_data$hh$num_workers_4bin)

# add new variable
variable_list<-add_variable(variable_list, 'num_workers_4bin','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('num_workers_4bin'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "num_workers_4bin", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Workers in Household", 
                    title = "Displacement by Household Employment (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Relationship between Workers and Adults

```{r}
# unique(hts_data$person$employment) #original variables
# unique(hts_data$person$worker) #standard grouping
# table(hts_data$person$worker)
unique(hts_data$hh$numadults)

worker_person <- hts_data$person %>% 
  select(hh_id, worker) %>% 
  mutate(worker_num= case_when(worker=="Not worker"~0,
                               worker=="Worker"~1,
                               TRUE~NA)) %>% 
  group_by(hh_id) %>% 
  summarise(worker_num_sum = sum(worker_num, na.rm=T)) 

table(worker_person$worker_num_sum)

hts_data$hh <- hts_data$hh %>%
  left_join(worker_person, by="hh_id") %>% 
  # mutate(numadults_simp= factor(
  #   fcase(grepl("^(6|7|8|9|10|11|12)", numadults) ,"6+ adults",
  #         !is.na(numadults), as.character(numadults)))) %>%
  mutate(numadults_num= as.numeric(substr(numadults,1,2))) %>% 
  mutate(adult_workers= case_when(worker_num_sum==numadults_num ~ "All workers",
                                  worker_num_sum < numadults_num ~ "Fewer workers",
                                  worker_num_sum > numadults_num ~ "More workers"))

table(hts_data$hh$numadults_num)
table(hts_data$hh$adult_workers)

#there is one household with more workers than adults
check <- hts_data$hh %>% 
  filter(adult_workers=="More workers")


# add new variable
variable_list<-add_variable(variable_list, 'adult_workers','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('adult_workers'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "adult_workers", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Workers:Adults", 
                    title = "Displacement by Household Workers:Adults (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

# Previous and Current Living

## Housing Tenure

### Previous

```{r}
# unique(hts_data$hh$prev_rent_own) #original variables

# need to recreate to match the standard grouping rent_own_bin2 variable
# based on code: https://github.com/psrc/psrc.travelsurvey/blob/main/R/psrc-hts-recode-hh-vars.R
hts_data$hh <- mutate(hts_data$hh,
                      prev_rent_own_bin2= factor(
                        fcase(grepl("^Provided", prev_rent_own) ,"Rent",
                              grepl("^(Other|Prefer)", as.character(prev_rent_own)), NA_character_,
                              !is.na(rent_own), as.character(prev_rent_own))))

unique(hts_data$hh$prev_rent_own_bin2)
table(hts_data$hh$prev_rent_own_bin2, hts_data$hh$survey_year)

# add new variable
variable_list<-add_variable(variable_list, 'prev_rent_own_bin2','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('prev_rent_own_bin2'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "prev_rent_own_bin2", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Previous Housing Tenure", 
                    title = "Displacement by Previous Housing Tenure (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Current

```{r}
# unique(hts_data$hh$rent_own) #original variables

# unique(hts_data$hh$rent_own_bin2) #standard groupings
table(hts_data$hh$rent_own_bin2, hts_data$hh$survey_year)

# add new variable
variable_list<-add_variable(variable_list, 'rent_own_bin2','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('rent_own_bin2'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "rent_own_bin2", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Current Tenure", 
                    title = "Displacement by Current Tenure (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Transition

```{r}
unique(hts_data$hh$prev_rent_own_bin2)
unique(hts_data$hh$rent_own_bin2)
# table(hts_data$hh$prev_rent_own_bin2)
# table(hts_data$hh$rent_own_bin2)

hts_data$hh <- mutate(hts_data$hh,
                      res_tenure_transition= case_when(prev_rent_own_bin2=="Rent" & 
                                                         rent_own_bin2=="Own/paying mortgage" ~ "Rent-Own",
                                                       prev_rent_own_bin2=="Owned/paid mortgage" & 
                                                         rent_own_bin2=="Rent" ~ "Own-Rent",
                                                       TRUE~"No change"))


# add new variable
variable_list<-add_variable(variable_list, 'res_tenure_transition','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('res_tenure_transition'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "res_tenure_transition", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Change in Housing Tenure", 
                    title = "Displacement by Change in Housing Tenure (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

## Housing Type

##### checking the raw data

```{r}
unique(hts_data$hh$prev_res_type) #original variables

# add new variable
# variable_list<-add_variable(variable_list, 'res_tenure_transition','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('prev_res_type'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "prev_res_type",
                    ylabel = "% of respondents", xlabel = "Previous Housing Type", 
                    title = "Displacement by Change in Previous Housing Type (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

###### look into household/dorms

```{r}
dorm_hh <- hts_data$hh %>%
  filter(prev_res_type=="Dorm or institutional housing")

table(dorm_hh$home_county)
table(dorm_hh$hhincome_broad)
table(dorm_hh$numadults)

dorm_hh_person <- dorm_hh %>% 
  inner_join(hts_data$person,
             by="hh_id")

table(dorm_hh_person$hhsize)

dorm_hh_1person <- dorm_hh_person %>% 
  filter(hhsize=="1 person")

table(dorm_hh_1person$age)
table(dorm_hh_1person$hhincome_broad)
```

##### aggregating the housing type

Based on sample size and MOE, it would be best to aggregate certain housing types. There appears to be a statistical difference in displacement rates between families living in buildings with 3 or fewer and 4 or more apartments/condos. Families in townhouses and buildings with 3 or fewer units seem to be displaced at similar rates, so those will be aggregated, although the numbers are still quite small for those two - the majority of people are in single-family houses or in buildings with 4 or more units. All of the remaining options have low sample sizes, so they will be aggregated.

```{r}
hts_data$hh <- mutate(hts_data$hh,
                      prev_res_type_simp= case_when(prev_res_type=="Single-family house (detached house)" ~ "Single-family",
                                                    prev_res_type=="Townhouse (attached house)" |
                                                      prev_res_type=="Building with 3 or fewer apartments/condos" ~ "Lower-density shared walls",
                                                    prev_res_type=="Building with 4 or more apartments/condos" ~ "Higher-density shared walls",
                                                    TRUE~"Other"))

```

##### checking against other demographic variables

To explore how this recategorization aligns with other SES

```{r}
# HOUSING TYPE & RACE (ALL) ----

# add new variable
variable_list<-add_variable(variable_list, 'prev_res_type_simp','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'prev_res_type_simp',
                             summarize_by = c('hh_race_category'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(wtd_sum,
                    x = "prev_res_type_simp", y = "prop", fill = "hh_race_category",
                    ylabel = "% of respondents", xlabel = "Previous Housing Type", 
                    title = "Previous Housing Type by Race/Ethnicity (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )


# HOUSING TYPE & INCOME (3 categories) ----
# add new variable
variable_list<-add_variable(variable_list, 'hhincome_bin3','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'prev_res_type_simp',
                             summarize_by = c('hhincome_bin3'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(wtd_sum,
                    x = "prev_res_type_simp", y = "prop", fill = "hhincome_bin3",
                    ylabel = "% of respondents", xlabel = "Previous Housing Type", 
                    title = "Previous Housing Type by Income (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Previous

```{r}
unique(hts_data$hh$prev_res_type_simp) #aggregated variable

# add new variable
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('prev_res_type_simp'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "prev_res_type_simp", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Previous Housing Type", 
                    title = "Displacement by Previous Housing Type (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Current

Using the same aggregation categories as with the previous housing type.

```{r}
# unique(hts_data$hh$prev_res_type) #original variables
# table(hts_data$hh$prev_res_type)

hts_data$hh <- mutate(hts_data$hh,
                      res_type_simp= case_when(res_type=="Single-family house (detached house)" ~ "Single-family",
                                               res_type=="Townhouse (attached house)" |
                                                 res_type=="Building with 3 or fewer apartments/condos" ~ "Lower-density shared walls",
                                               res_type=="Building with 4 or more apartments/condos" ~ "Higher-density shared walls",
                                               TRUE~"Other"))

# add new variable
variable_list<-add_variable(variable_list, 'res_type_simp','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('res_type_simp'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "res_type_simp", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Current Housing Type", 
                    title = "Displacement by Current Housing Type (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

### Transition

Using the same aggregation categories as with the previous housing type. "Other" == Dorm or institutional housing; Mobile home/trailer; Other (including boat, RV, van, etc.)

```{r}
# unique(hts_data$hh$prev_res_type_simp) #original variables
# unique(hts_data$hh$res_type_simp)
# table(hts_data$hh$prev_res_type_simp)

hts_data$hh <- mutate(hts_data$hh,
                      prev_res_type_num= case_when(prev_res_type_simp=="Single-family" ~1,
                                                   prev_res_type_simp=="Lower-density shared walls" ~2,
                                                   prev_res_type_simp=="Higher-density shared walls" ~3,
                                                   prev_res_type_simp=="Other" ~4),
                      res_type_num= case_when(res_type_simp== "Single-family" ~1,
                                              res_type_simp== "Lower-density shared walls" ~2,
                                              res_type_simp== "Higher-density shared walls" ~3,
                                              res_type_simp== "Other" ~4),
                      res_type_transition= case_when(prev_res_type_num==res_type_num~"No change",
                                                     prev_res_type_num>res_type_num~"More space, less density",
                                                     prev_res_type_num<res_type_num~"Less space, higher density"))

table(hts_data$hh$res_type_transition)

# add new variable
variable_list<-add_variable(variable_list, 'res_type_transition','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('res_type_transition'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "res_type_transition", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Change in Housing Type", 
                    title = "Displacement by Change in Housing Type (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
                                                       
```

# Spatial Patterns

## RGCs

There is no 2023 data for previous home location, so this will be based on current home location.

```{r}
# table(hts_data$hh$prev_home_rgcname, hts_data$hh$survey_year) #original variables
# table(hts_data$hh$home_rgcname, hts_data$hh$survey_year) #original variables

hts_data$hh <- mutate(hts_data$hh,
                      prev_RGC= case_when(prev_home_rgcname=="Not RGC" ~ "Not RGC",
                                          TRUE~"RGC"),
                      RGC= case_when(home_rgcname== "Not RGC" ~ "Not RGC",
                                          TRUE~"RGC"))

table(hts_data$hh$prev_RGC, hts_data$hh$survey_year)
table(hts_data$hh$RGC, hts_data$hh$survey_year)

# add new variable
variable_list<-add_variable(variable_list, 'RGC','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('RGC'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "RGC", y = "prop", fill = "displaced",
                    ylabel = "% of respondents", xlabel = "Home Location", 
                    title = "Displacement by Location in RGC (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

## Counties

```{r}
# unique(hts_data$hh$home_county) #original variables
# table(hts_data$hh$home_county)


# add new variable
variable_list<-add_variable(variable_list, 'home_county','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('home_county'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "home_county",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Displacement by County (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )

```

## Regional Geographies
### All
Regional Growth Strategies 6 categories: Metro cities, HCTs, Rural, etc.
```{r}
# regional geography layer
region_geo.url <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services/Regional_Geographies/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
region_geo <- st_read(region_geo.url)

home_loc <- hts_data$hh %>%
  st_as_sf(coords = c("home_lng", "home_lat"), 
           crs = 4326) %>% 
  select(hh_id, geometry) #3343

hh <- st_intersection(home_loc, region_geo) %>%
  select(hh_id, cnty_name, feat_type, juris, class_desc) #3195

# add geography data to hts_data$hh
hts_data$hh <- hts_data$hh %>% 
  left_join(hh, by="hh_id")

# check
unique(hts_data$hh$class_desc)
table(hts_data$hh$survey_year, hts_data$hh$class_desc)

# add new variable
variable_list<-add_variable(variable_list, 'class_desc','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('class_desc'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)

# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "class_desc",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Displacement by Regional Geography (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

#### NA?
```{r}
# after st_intersection, hh dataset has fewer records than hts_data$hh by 148> NAs in regional geographies
test_na <- hts_data$hh %>% 
  filter(is.na(class_desc))

test <- hts_data$hh %>% 
  filter(is.na(home_lng))

length(unique(hts_data$hh$home_lat)) #2881
length(unique(hts_data$hh$home_lng)) #2278

missing_hh <- hts_data$hh %>%
  left_join(hh, by="hh_id")


# create map to verify that there are home locations outside of the regional geographies
# plot(region_geo)
# plot(region_geo["class_desc"])
# plot(home_loc)

# set map extent
map.lat<- 47.615
map.lon<- -122.257
map.zoom<- 8.5


color_palette <- leaflet::colorFactor(palette = psrc_colors$psrc_light,
                                      domain = region_geo$class_desc) # this is the value field

# map settings
test_map <- leaflet() %>%
  leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
  leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
  leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
  leaflet::addProviderTiles("CartoDB.VoyagerOnlyLabels",
                            options = leaflet::leafletOptions(pane = "maplabels"),
                            group = "Labels") %>%
  addPolygons(data=region_geo,
              fillColor = color_palette(region_geo$class_desc),
              color = color_palette,
              stroke=FALSE, 
              smoothFactor = 0.2,
              fillOpacity = 0.7) %>%
  addCircleMarkers(lng = hts_data$hh$home_lng,
                   lat = hts_data$hh$home_lat,
                   radius = 0.8) %>%
  addCircleMarkers(lng = test_na$home_lng,
                   lat = test_na$home_lat,
                   radius = 1.3,
                   color="red") %>%
  addLegend(position = "bottomright",
            pal = color_palette,
            values = unique(region_geo$class_desc),
            # colors = unique(region_geo$class_desc),
            labels = unique(region_geo$class_desc),
            # values = unique(region_geo$class_desc),
            # colors = unique(region_geo$class_desc),
            # labels = unique(region_geo$class_desc),
            title = "Regional <br> Geographies") %>% 
  
  #set view extent
  leaflet::setView(lng=map.lon, lat=map.lat, zoom=map.zoom) %>% 
  addEasyButton(easyButton(
    icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)
    title ="Region",
    onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))

# print map
test_map
```

### Simplified: 2 categories
```{r}
# unique(hts_data$hh$class_desc) #original variables
# table(hts_data$hh$survey_year, hts_data$hh$class_desc)

# aggregate categories
hts_data$hh <- mutate(hts_data$hh,
                      class_desc_bin2= case_when(class_desc=="HCT"  |
                                                   class_desc=="Metro" ~ "Metro/HCT",
                                                 TRUE~"Other"))

# add new variable
variable_list<-add_variable(variable_list, 'class_desc_bin2','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=hts_data$hh)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('class_desc_bin2'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "class_desc_bin2",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Displacement by Regional Geography (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

# Correlations
The dependent variable is displacement.   
The explanatory variables can be categorized as **categorical** and *numeric*. The reference group is provided for the categorical variables. 
\
```{r reference variables, eval=FALSE, include=FALSE}
hts_data$hh

table(hts_data$hh$hhincome_broad) # Under $25k is reference
table(hts_data$hh$hhsize) # 1 person
table(hts_data$hh$rent_own_bin2) #  Own/paying mortgage
table(hts_data$hh$prev_rent_own_bin2) # Owned/paid mortgage
table(hts_data$hh$numadults_num) # numeric
table(hts_data$hh$edu_hh_max) # Bachelors or higher
# table(hts_data$hh$hh_race_category_4) # White Only for both race categorizations
table(hts_data$hh$prev_res_type_simp) # Higher-density shared walls
table(hts_data$hh$res_type_simp) # Higher-density shared walls
table(hts_data$hh$prev_RGC) # Not RGC 
table(hts_data$hh$RGC) # Not RGC
```

### Correlation background
#### Sample sizes per year/displacement reason
```{r}
# sample size for each reason for displacement, and by income
hts_data$hh

df_table <- hts_data$hh %>% 
  filter(displaced=="Displaced") %>%
  mutate(community_num=case_when(prev_res_factors_community_change=="Selected" ~as.numeric(1),
                                 prev_res_factors_community_change=="Not Selected" ~as.numeric(0)),
         cost_num= case_when(prev_res_factors_housing_cost=="Selected" ~as.numeric(1),
                             prev_res_factors_housing_cost=="Not Selected" ~as.numeric(0)),
         forced_num= case_when(prev_res_factors_forced=="Selected" ~as.numeric(1),
                               prev_res_factors_forced=="Not Selected" ~as.numeric(0)),
         income_num= case_when(prev_res_factors_income_change=="Selected" ~as.numeric(1),
                               prev_res_factors_income_change=="Not Selected" ~as.numeric(0))) %>% 
  dplyr::group_by(survey_year) %>% 
  summarise(community=sum(community_num),
            cost=sum(cost_num),
            forced=sum(forced_num),
            income=sum(income_num)) %>% 
  print()
```
There are 3,343 households total. There are 916 displaced households. 

#### Household-level variabes
##### Goodman and Kruskal
The Goodman and Kruskal tau measure is an asymmetric association measure between two categorical variables, based on the extent to which variation in one variable can be explained by the other.
Based on https://cran.r-project.org/web/packages/GoodmanKruskal/vignettes/GoodmanKruskal.html.
```{r}
corr_variables <- c("displaced",
                    "hhincome_bin5", 
                    "hhsize_bin4",
                    "rent_own_bin2",
                    "prev_rent_own_bin2", 
                    "vehicle_count_bin4",
                    "numadults", 
                    "numchildren_simp",
                    "num_workers_4bin",
                    "edu_hh_max",
                    "prev_res_type",
                    "res_type")

# household type, using home location - displacement risk mapping - hhtract

library(GoodmanKruskal)
hh_correlation <- subset(hts_data$hh, select = corr_variables)
Disp_GKmatrix <- GKtauDataframe(hh_correlation)
plot(Disp_GKmatrix)
```
The strongest association seen in this plot is that between household size (hhsize_bin4) and number of adults (numadults) where the forward association is 0.77 and the reverse association is 0.55 - these numbers suggest that household size is highly predictive of the number of adults, which seems reasonable. 

##### Correlation for matrix factors
If you want to have a genuine correlation plot for factors or mixed-type, you can also use model.matrix to one-hot encode all non-numeric variables. This is quite different than calculating CramÃ©r's V as it will consider your factor as separate variables, as many regression models do.
https://stats.stackexchange.com/questions/148554/how-can-you-visualize-the-relationship-between-3-categorical-variables
```{r}
library(ggcorrplot)

model.matrix(~0+., data=hh_correlation) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
```


#### Person-level variabes
```{r}
# join displacement data at hh to person-level data
person_level <- hts_data$hh %>%
  right_join(hts_data$person, by="hh_id") #person table includes 23,612


unique(person_level$age)
levels(person_level$education)
levels(person_level$employment)

# order/transform employment variables
person_level_ordered <- person_level %>%
  mutate(employment_simp=case_when(employment=="Employed full time (35+ hours/week, paid)"~"Full-time",
                                   employment=="Employed part time (fewer than 35 hours/week, paid)"|
                                     employment=="Self-employed"~"Part-time",
                                   TRUE~"Not employed"))
person_level_ordered$employment_simp <- factor(person_level_ordered$employment_simp, levels=c('Not employed', 'Part-time', 'Full-time'))

levels(person_level_ordered$age)
levels(person_level_ordered$employment_simp)

# categorical correlation
corr_variables_p <- c("displaced",
                      "age", 
                      "education",
                      "employment_simp") 

p_correlation <- subset(person_level_ordered, select = corr_variables_p)
Disp_GKmatrix_p <- GKtauDataframe(p_correlation)
plot(Disp_GKmatrix_p)

# 'continuous' correlation
# ordering person-level variables: education, employment status, age
person_level_num <- person_level %>%
  mutate(age_num=case_when(age=="Under 5 years old"~1,
                           age=="5-11 years"~2,
                           age=="12-15 years"~3,
                           age=="16-17 years"~4,
                           age=="18-24 years"~5,
                           age=="25-34 years"~6,
                           age=="35-44 years"~7,
                           age=="45-54 years"~8,
                           age=="55-64 years"~9,
                           age=="65-74 years"~10,
                           age=="75-84 years"~11,
                           age=="85 years or older"~12),
         education_num=case_when(education=="Prefer not to answer "~1,
                                 education=="Less than high school"~2,
                                 education=="High school graduate"~3,
                                 education=="Some college"~4,
                                 education=="Vocational/technical training"~5,
                                 education=="Associates degree"~6,
                                 education=="Bachelor degree"~7,
                                 education=="Graduate/post-graduate degree"~8),
         employment_num=case_when(employment=="Not employed and not looking for work (e.g., retired, stay-at-home parent, student)"|
                                     employment=="Retired" |
                                     employment=="Homemaker" |
                                     employment=="Not currently employed" |
                                    employment=="Unemployed and looking for work" |
                                    employment=="Unpaid volunteer or intern" |
                                    employment=="Employed but not currently working (e.g., on leave, furloughed 100%)"~1,
                                   employment=="Employed part time (fewer than 35 hours/week, paid)" |
                                     employment=="Self-employed"~2,
                                   employment=="Employed full time (35+ hours/week, paid)"~3)) 

person_level_num_filtered <- person_level_num %>% 
  select(displaced, age_num, education_num, employment_num)

model.matrix(~0+., data=person_level_num_filtered) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
```


#### COVID 
Movers before, during, and after the evication moratoriums
Policies and interest rates- before and after COVID - using the survey year and subtracting the range of years
```{r}
# we are loosely defining the time period of the moratorium as 2020-2021
hts_data$hh

table(hts_data$hh$res_dur)

time <- hts_data$hh %>% 
  mutate(covid_moving= case_when(survey_year==2019 |
                                   survey_year==2021 & res_dur !="Less than a year" | 
                                   #remove respondents who moved after (2020-2021)
                                   survey_year==2023 & res_dur =="Between 3 and 5 years" ~ "before", 
                                 #keep respondents who moved before 2020 (3-5 years before 2023)
                                 TRUE~"after"),
         moratorium= case_when(survey_year==2019 | 
                                 survey_year==2021 & res_dur=="Between 2 and 3 years" |
                                 survey_year==2021 & res_dur=="Between 3 and 5 years" |
                                 survey_year==2023 & res_dur=="Between 3 and 5 years" ~ "before",
                               survey_year==2021 & res_dur=="Less than a year" |
                                 survey_year==2023 & res_dur=="Between 1 and 2 years" |
                                 survey_year==2023 & res_dur=="Between 2 and 3 years" ~ "during",
                               survey_year==2021 & res_dur=="Between 1 and 2 years" |
                                 survey_year==2021 & res_dur=="Between 2 and 3 years" |
                                 survey_year==2021 & res_dur=="Between 3 and 5 years" |
                                 survey_year==2023 & res_dur=="Less than a year" ~ "after",
                               TRUE~ "Other"),
         moratorium_binary= case_when(moratorium=="before" |
                                        moratorium=="after"~ "not during",
                                      moratorium=="during"~ "during",
                                      TRUE~ "Other"))

time$covid_moving <- factor(time$covid_moving, levels=c('before', 'after'))
time$moratorium <- factor(time$moratorium, levels=c('before', 'during', 'after'))

# checking numbers
# table(hts_data$hh$survey_year)
# table(time$survey_year)
table(time$survey_year, time$res_dur)
table(time$survey_year, time$covid_moving)
table(time$survey_year, time$movers)
table(time$displaced, time$covid_moving)  
table(time$survey_year, time$moratorium)
table(time$moratorium, time$movers)
table(time$moratorium, time$moratorium_binary)

```

##### COVID
```{r}
# add new variable
variable_list<-add_variable(variable_list, 'covid_moving','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=time)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('covid_moving'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "covid_moving",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Displacement by COVID (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

##### Moratorium
```{r}
# add new variable
variable_list<-add_variable(variable_list, 'moratorium','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=time)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('moratorium'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "moratorium",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Displacement by Moratorium (2019, 2021, 2023)",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```
###### Moratorium by income
```{r}
# unique(time$income_flag)

time_less <- time %>% 
  filter(income_flag=="Less than $100,000")
time_100k <- time %>% 
  filter(income_flag=="$100,000 or more")

hta_data_all <- list(hh=time_less)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('moratorium'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "moratorium",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Moratorium (2019, 2021, 2023) - Less than $100k",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )

hta_data_all <- list(hh=time_100k)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('moratorium'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "moratorium",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Moratorium (2019, 2021, 2023) - More than $100k",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```

```{r}
# add hh level covid data to person-level data
hh_covid <- time %>% 
  select(hh_id, covid_moving)
person_level_covid <- person_level_ordered %>%
  select(hh_id, age, education, employment_simp, displaced) %>%
  right_join(hh_covid, by="hh_id")
```

##### Before
###### Person
```{r}
person_level_covid_before <- person_level_covid %>%
  filter(covid_moving=="before")

corr_variables_p <- c("displaced",
                      "age", 
                      "education",
                      "employment_simp") 

p_correlation_before <- subset(person_level_covid_before, select = corr_variables_p)
Disp_GKmatrix_p_before <- GKtauDataframe(p_correlation_before)
plot(Disp_GKmatrix_p_before)
```
###### Household
```{r}
hh_level_covid_before <- time %>%
  filter(covid_moving=="before")

hh_correlation_before <- subset(hh_level_covid_before, select = corr_variables)
Disp_GKmatrix_p_before <- GKtauDataframe(hh_correlation_before)
plot(Disp_GKmatrix_p_before)
```

##### After
###### Person
```{r}
person_level_covid_after <- person_level_covid %>%
  filter(covid_moving=="after")

p_correlation_after <- subset(person_level_covid_after, select = corr_variables_p)
Disp_GKmatrix_p_after <- GKtauDataframe(p_correlation_after)
plot(Disp_GKmatrix_p_after)
```
###### Household
```{r}
hh_level_covid_after <- time %>%
  filter(covid_moving=="after")

hh_correlation_after <- subset(hh_level_covid_after, select = corr_variables)
Disp_GKmatrix_h_after <- GKtauDataframe(hh_correlation_after)
plot(Disp_GKmatrix_h_after)
```

##### Moratorium - binary
```{r}
# add new variable
variable_list<-add_variable(variable_list, 'moratorium_binary','hh')
variable_list<-variable_list%>%distinct(variable, .keep_all=TRUE)

hta_data_all <- list(hh=time)

# Calculate a categorical summary, i.e. count/share
summary = summarize_weighted(hts_data= hta_data_all,
                             summarize_var = 'displaced',
                             summarize_by = c('moratorium_binary'),
                             id_cols='hh_id',
                             wt_cols='hh_weight',
                             wtname='hh_weight'
)

wtd_sum<-summary$summary$wtd %>%
  mutate(prop_moe=z_score*prop_se)


# create chart
static_column_chart(filter(wtd_sum, #survey_year == focus_year, 
                           displaced=="Displaced"),
                    x = "displaced", y = "prop", fill = "moratorium_binary",
                    ylabel = "% of respondents", #xlabel = "Home County", 
                    title = "Displacement in Relation to Moratorium",
                    moe = "prop_moe") + theme(
                      axis.text.x = element_text(size = 14),
                      axis.text.y = element_text(size = 14),
                      axis.title.y = element_text(size = 20),
                      axis.title.x = element_text(size = 20),
                      plot.title = element_text(size = 24)
                    )
```


#### Displacement Risk
```{r}
# home locations - previous and current
home_count <- hts_data$hh %>%
  group_by(survey_year) %>%
  summarise(n_distinct(home_tract20))

prev_home_count <- hts_data$hh %>%
  group_by(survey_year) %>%
  summarise(n_distinct(prev_home_tract20))

# there is one household with a previous home tract, but it appears to be NA
# test <- hts_data$hh %>% 
#   filter(survey_year=="2023") %>% 
#   group_by(prev_home_tract20) %>% 
#   summarise(first(hh_id))

# displacement risk dataset -----
arc_service <- "https://services6.arcgis.com/GWxg6t7KXELn1thE/arcgis/rest/services"

disp10.url <- file.path(arc_service, "Displacement_Risk_Data/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson")
disp10.lyr <- st_read(disp10.url)


# join displacement risk data to HTS data: home tract based on lat/long -----
home_loc <- hts_data$hh %>%
  st_as_sf(coords = c("home_lng", "home_lat"), 
           crs = 4326) %>% 
  select(hh_id, geometry) #3343 features

hh <- st_intersection(home_loc, disp10.lyr)

# add geography data to hts_data$hh
hts_data$hh <- hts_data$hh %>% 
  left_join(hh, by="hh_id")

# join displacement risk data to HTS data: previous home tract based on lat/long -----
# create displacement dataset for previous home locations
prev_disp10.lyr <- disp10.lyr %>% 
  rename_with(.cols = ElmerGeo_DBO_displacement_risk_:vote_level, function(x){paste0("prev_", x)})
  # rename_with(.fn = ~ paste0("prev_", .x))

# need to remove 2023 data because locations not available
hh_no2023 <- hts_data$hh  %>%
  filter(survey_year!="2023")
table(hh_no2023$survey_year)

prev_home_loc <- hh_no2023 %>%
  st_as_sf(coords = c("prev_home_lat", "prev_home_lng"), 
           crs = 4326) %>% 
  select(hh_id, geometry) #2067 features

hh_prev <- st_intersection(prev_home_loc, prev_disp10.lyr)

# add geography data to hts_data$hh
hts_data$hh <- hts_data$hh %>% 
  left_join(hh_prev, by="hh_id")

```